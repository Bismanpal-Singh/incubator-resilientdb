import { CommentSection } from '@/components/CommentSection'
import { Divider, Box, Space, Tabs, TabsList, TabsTab, TabsPanel, Code, Alert } from '@mantine/core'
import { IconInfoCircle } from '@tabler/icons-react'
import { ResContractPlayground } from '@/components/ResContractPlayground'

{/* BEGIN AUTO_DOC: rescontract */}

# rescontract

The `rescontract` project provides a user-friendly **command-line interface (CLI)** for managing smart contracts on the *ResilientDB blockchain*. It simplifies complex tasks by acting as a convenient wrapper around ResilientDB's core C++ tools. With this CLI, developers can easily *create accounts*, **compile** Solidity code, and **deploy** their smart contracts without needing to interact directly with the underlying executables.


```mermaid
flowchart TD
A0["CLI Command Interface"]
A1["ResilientDB Tool Bridging"]
A2["`ResDB_Home` Configuration"]
A3["Deployed Contract Registry"]
A4["External Dependency Handling"]
A5["External Process Execution"]
A6["Centralized Logging"]
A0 -- "Triggers" --> A1
A0 -- "Updates" --> A3
A0 -- "Invokes" --> A4
A1 -- "Reads location from" --> A2
A2 -- "Logs errors to" --> A6
A4 -- "Runs through" --> A5
A5 -- "Reports errors to" --> A6

```

`rescontract` is a command-line interface (CLI) designed to streamline smart contract development for the ResilientDB ecosystem. It acts as a user-friendly wrapper around ResilientDB's powerful, high-performance C++ tools, simplifying the entire workflow from account creation to contract deployment. This guide provides a comprehensive overview of its configuration, usage, and architecture.

## Getting Started: Configuration

Before any commands can be run, `rescontract` must know the location of your ResilientDB project installation. This path, known as `ResDB_Home`, is essential for the CLI to locate the core executables it depends on.

### Setting `ResDB_Home`

The CLI searches for the `ResDB_Home` path in a specific order. The first valid path found is the one that will be used.

1.  **Environment Variable (Recommended):** The highest priority method. Set an environment variable named `ResDB_Home`. This is the most robust way to configure the tool.

    ```bash
    # Set for the current session
    export ResDB_Home=/path/to/your/resilientdb

    # Add to your .bashrc or .zshrc for permanence
    ```

2.  **Configuration File (`config.yaml`):** If the environment variable is not set, `rescontract` looks for a `config.yaml` file. It checks in the following locations:
    *   The current working directory.
    *   The user's home directory (`~`).

    The file should contain a single key-value pair:

    ```yaml
    ResDB_Home: /path/to/your/resilientdb
    ```

If `ResDB_Home` cannot be found through any of these methods, `rescontract` will exit with an error.

## CLI Command Reference

The `rescontract` CLI provides a set of simple, memorable commands that mask complex underlying operations. It is built with the `commander` library, which provides features like automatic help menus (`rescontract --help`).

### Core Commands

*   `create`: Creates a new blockchain account by calling ResilientDB's `contract_tools`.
*   `compile`: Compiles a Solidity (`.sol`) file into a JSON artifact that the blockchain can understand. This command requires the `solc` compiler to be installed.
*   `deploy`: Deploys a compiled contract to the ResilientDB blockchain.
*   `list-deployments`: Lists all contracts that have been successfully deployed via `rescontract`.

### Usage Example: Compiling a Contract

To compile a smart contract, you provide the path to your source file and specify an output file.

```bash
rescontract compile --sol contracts/MyToken.sol --output build/MyToken.json
```

This command invokes the `solc` compiler with the correct flags and saves the resulting JSON artifact to the specified location.

## How It Works: Core Architecture

`rescontract` is designed as a lightweight bridge to more powerful tools rather than a monolithic application. This architecture ensures reliability by leveraging the official, battle-tested ResilientDB and Solidity executables.

### ResilientDB Tool Bridging

The core design principle of `rescontract` is to act as a smart wrapper. Commands like `create` and `deploy` do not contain any cryptographic or blockchain logic. Instead, they perform two main steps:

1.  **Locate the Tool:** Using the `ResDB_Home` path, the CLI constructs the full path to the required C++ executable (e.g., `.../bazel-bin/.../contract_tools`).
2.  **Execute and Delegate:** The CLI then executes that C++ program, passing along any arguments provided by the user.

This approach keeps `rescontract` simple and ensures you are always using the authoritative logic from the core ResilientDB project.

### External Process Execution

To manage communication with external C++ tools and `solc`, `rescontract` uses a robust, promise-based helper function. This utility handles the complexities of running a child process:

*   It starts the external program (e.g., `contract_tools`).
*   It captures `stdout` and `stderr` in real-time, displaying them to the user.
*   It waits for the process to complete and checks its exit code. An exit code of `0` indicates success, while any other value signals an error.

This standardized "messenger service" ensures that every external command is executed and monitored in a consistent, reliable way.

```javascript
// Simplified concept from index.js
function handleExecFile(command, args) {
  return new Promise((resolve, reject) => {
    const child = execFile(command, args);
    
    // ... code to pipe child's stdout/stderr to the console ...

    child.on('exit', (code) => {
      if (code === 0) resolve();
      else reject(new Error(`Process exited with code ${code}`));
    });
  });
}
```

### Dependency Management (`solc`)

The `compile` command depends on the Solidity compiler, `solc`. To simplify setup, `rescontract` includes a post-installation script that runs automatically after `npm install`.

This script checks if `solc` is present on the system. If not, it prompts the user for permission to install it, automating what would otherwise be a manual setup step.

### Deployed Contract Registry

To prevent accidental re-deployment of the same contract, `rescontract` maintains a local registry. This is a simple JSON file named `.rescontract_deployed_contracts.json` located in the user's home directory.

*   **On Deployment:** Before deploying, `rescontract` checks if a contract with the same name and owner already exists in the registry. If it does, the operation is aborted with a warning.
*   **On Success:** After a successful deployment, the new contract's name, owner, and on-chain address are added to the registry.
*   **Listing:** The `rescontract list-deployments` command reads this file and displays its contents in a formatted list, providing a clear history of your deployments.

## Troubleshooting & Logging

`rescontract` uses the `winston` library to provide a centralized logging system, which is crucial for debugging. Logs are sent to two destinations simultaneously:

1.  **Console:** User-friendly, concise messages are displayed directly in the terminal during command execution.
2.  **Log Files:** Detailed, timestamped logs are saved to a dedicated directory: `~/.rescontract-logs/`.
    *   `cli.log`: Contains a complete record of all informational messages and standard errors for every command run.
    -   `exceptions.log`: A critical safety net that records any unhandled exceptions that cause the application to crash.

When a command fails unexpectedly, these log files are the first and most important resource for diagnosing the problem.

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)

{/* END AUTO_DOC: rescontract */}

## License

This project is licensed under the Apache License 2.0 - see the [LICENSE](https://github.com/apache/incubator-resilientdb-ResContract/blob/main/LICENSE) file for details.

<Space h="xl" />
<Divider my="xl" label="Community Feedback" labelPosition="center" />

<Box mb="xl">
  <CommentSection
    pageTitle="ResContract CLI Documentation"
    pageUrl={typeof window !== 'undefined' ? window.location.href : ''}
    repoOwner="apache"
    repoName="incubator-resilientdb-ResContract"
    labels={['user-feedback', 'documentation', 'rescontract']}
    title="Questions or Feedback about ResContract?"
  />
</Box> 