#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 08_single_pass_mode</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d5/d1b/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_208__single__pass__mode.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">08_single_pass_mode</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md1354"></a>
autotoc_md1354</h2>
<p>layout: default title: "Single-Pass Mode" parent: "Codex" </p>
<h2><a class="anchor" id="autotoc_md1355"></a>
nav_order: 8</h2>
<h1><a class="anchor" id="autotoc_md1356"></a>
Chapter 8: Single-Pass Mode</h1>
<p>In the <a class="el" href="../../d2/d53/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_207__configuration__management.html">previous chapter</a>, we explored how Codex uses configuration files to remember your preferences and follow custom instructions. We've mostly seen Codex operate in its default interactive mode, like having a conversation in the <a class="el" href="../../dd/d7b/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_201__terminal__ui____ink__components__.html">Terminal UI</a> where the <a class="el" href="../../d0/dbd/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_203__agent__loop.html">Agent Loop</a> goes back and forth with the AI.</p>
<p>But what if you have a task that's very clearly defined? Imagine you want to rename a function across your entire project. You know exactly what needs to be done, and you don't really need a back-and-forth chat. Wouldn't it be faster if you could just give Codex the instructions and have it figure out <em>all</em> the necessary changes at once?</p>
<p>That's exactly the idea behind <b>Single-Pass Mode</b>.</p>
<h2><a class="anchor" id="autotoc_md1357"></a>
What's the Big Idea? The Architect Analogy</h2>
<p>Think about building a house. The normal, interactive mode of Codex is like having a conversation with your architect room by room: "Let's design the kitchen." "Okay, now how about the living room?" "Should we add a window here?". It's collaborative and allows for adjustments along the way.</p>
<p><b>Single-Pass Mode</b> is different. It's like giving the architect the complete blueprints, all the requirements, and the site survey <em>upfront</em>, and asking them to come back with the <em>final, complete building plan</em> in one go.</p>
<p>In this experimental mode, Codex tries to:</p>
<ol type="1">
<li>Gather a large amount of context about your project (lots of code files).</li>
<li>Send your request <em>and</em> all that context to the AI model <em>at the same time</em>.</li>
<li>Ask the AI to generate a <em>complete set</em> of file operations (creations, updates, deletions) needed to fulfill your request, all in a single response.</li>
<li>Show you the proposed changes for review.</li>
<li>If you approve, apply all the changes and exit.</li>
</ol>
<p>This mode aims for efficiency, especially on larger, well-defined tasks where you're reasonably confident the AI can generate the full solution without needing clarification.</p>
<h2><a class="anchor" id="autotoc_md1358"></a>
Key Concepts</h2>
<ol type="1">
<li><b>Full Context (Within Limits):</b> Instead of just looking at one or two files, Codex gathers the content of many files in your project (respecting ignore rules from <a class="el" href="../../d2/d53/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_207__configuration__management.html">Configuration Management</a> and size limits like <code>MAX_CONTEXT_CHARACTER_LIMIT</code>). This gives the AI a broader view of your codebase.</li>
<li><b>Single Structured Response:</b> The AI isn't just asked for text. It's specifically instructed to respond with a structured list of <em>all</em> the file operations required. Codex uses a predefined schema (like <code>EditedFilesSchema</code> defined using Zod in <code>file_ops.ts</code>) to tell the AI exactly how to format this list.</li>
<li><b>All-or-Nothing Confirmation:</b> You are presented with a summary and a diff (showing additions and deletions) of <em>all</em> the proposed changes across all affected files. You then give a single "Yes" or "No" to apply everything or nothing.</li>
<li><b>Efficiency for Defined Tasks:</b> This mode shines when your instructions are clear and the task doesn't likely require interactive refinement (e.g., "Rename function X to Y everywhere", "Add logging to every public method in class Z").</li>
</ol>
<h2><a class="anchor" id="autotoc_md1359"></a>
How to Use It</h2>
<p>You typically invoke single-pass mode using a specific command-line flag when running Codex (the exact flag might vary, but let's assume <code>--single-pass</code>).</p>
<p><b>Example:</b></p>
<p>Let's say you want to rename a function <code>calculate_total</code> to <code>compute_grand_total</code> throughout your project located in <code>~/my-sales-app/</code>.</p>
<div class="fragment"><div class="line">cd ~/my-sales-app/</div>
<div class="line">codex --single-pass &quot;Rename the function &#39;calculate_total&#39; to &#39;compute_grand_total&#39; in all project files.&quot;</div>
</div><!-- fragment --><p><b>What Happens:</b></p>
<ol type="1">
<li><b>Context Loading:</b> Codex will identify the files in <code>~/my-sales-app/</code> (respecting ignores), read their content, and note the size. You might see output indicating this.</li>
<li><b>AI Thinking:</b> It sends your prompt and the file contents to the AI, asking for the complete set of changes. You'll likely see a spinner.</li>
<li><b>Review:</b> Codex receives the proposed file operations from the AI. It calculates the differences (diffs) and shows you a summary: ``` Summary: Modified: src/utils.py (+1/-1) Modified: tests/test_utils.py (+1/-1) Modified: main_app.py (+1/-1)</li>
</ol>
<h1><a class="anchor" id="autotoc_md1360"></a>
Proposed Diffs:</h1>
<h2><a class="anchor" id="autotoc_md1361"></a>
Changes for: src/utils.py</h2>
<p>@ -10,7 +10,7 @ </p>
<h1><a class="anchor" id="autotoc_md1362"></a>
... code ...</h1>
<p>-def calculate_total(items): +def compute_grand_total(items): </p>
<h1><a class="anchor" id="autotoc_md1363"></a>
... implementation ...</h1>
<h1><a class="anchor" id="autotoc_md1364"></a>
... (more diffs for other files) ...</h1>
<p>Apply these changes? [y/N] ``<code></p><ol type="1">
<li>**Confirmation:** You type</li>
</ol>
<p></code>y<code>and press Enter.</p><ol type="1">
<li>**Applying:** Codex modifies the files</li>
</ol>
<p></code>src/utils.py<code>,</code>tests/test_utils.py<code>, and</code>main_app.py` according to the diffs.</p><ol type="1">
<li><b>Exit:</b> The Codex process finishes.</li>
</ol>
<p>If you had typed <code>n</code>, no files would have been changed.</p>
<h2><a class="anchor" id="autotoc_md1365"></a>
Under the Hood: The Single-Pass Flow</h2>
<p>Let's trace the journey when you run <code>codex --single-pass "prompt"</code>:</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant User</div>
<div class="line">    participant CLI as Codex CLI (SinglePass)</div>
<div class="line">    participant ContextLoader as context_files.ts</div>
<div class="line">    participant OpenAI</div>
<div class="line">    participant FileSystem</div>
<div class="line"> </div>
<div class="line">    User-&gt;&gt;CLI: Runs `codex --single-pass &quot;Rename func...&quot;`</div>
<div class="line">    CLI-&gt;&gt;ContextLoader: Get project file contents (respecting ignores)</div>
<div class="line">    ContextLoader-&gt;&gt;FileSystem: Reads relevant files</div>
<div class="line">    FileSystem--&gt;&gt;ContextLoader: File contents</div>
<div class="line">    ContextLoader--&gt;&gt;CLI: Returns list of files &amp; content</div>
<div class="line">    CLI-&gt;&gt;CLI: Formats huge prompt (request + file contents) using `renderTaskContext`</div>
<div class="line">    CLI-&gt;&gt;OpenAI: Sends single large request (expecting structured `EditedFilesSchema` response)</div>
<div class="line">    Note over CLI, OpenAI: AI processes context and request</div>
<div class="line">    OpenAI--&gt;&gt;CLI: Returns structured response { ops: [ {path:..., updated_full_content:...}, ... ] }</div>
<div class="line">    CLI-&gt;&gt;CLI: Parses the `ops` list (`file_ops.ts`)</div>
<div class="line">    CLI-&gt;&gt;CLI: Generates diffs and summary (`code_diff.ts`)</div>
<div class="line">    CLI-&gt;&gt;User: Displays summary &amp; diffs, asks &quot;Apply changes? [y/N]&quot;</div>
<div class="line">    User-&gt;&gt;CLI: Types &#39;y&#39;</div>
<div class="line">    CLI-&gt;&gt;FileSystem: Applies changes (writes updated content, creates/deletes files)</div>
<div class="line">    CLI-&gt;&gt;User: Shows &quot;Changes applied.&quot; message</div>
<div class="line">    CLI-&gt;&gt;CLI: Exits</div>
</div><!-- fragment --><ol type="1">
<li><b>Invocation:</b> The CLI (<code>cli_singlepass.tsx</code>) is started in single-pass mode.</li>
<li><b>Context Gathering:</b> It uses functions like <code>getFileContents</code> from <code>utils/singlepass/context_files.ts</code> to read the content of project files, respecting ignore patterns and size limits.</li>
<li><b>Prompt Construction:</b> It builds a large prompt using <code>renderTaskContext</code> from <code>utils/singlepass/context.ts</code>. This prompt includes your request and embeds the content of all gathered files, often in an XML-like format.</li>
<li><b>AI Call:</b> It sends this single, massive prompt to the OpenAI API. Crucially, it tells the API to format the response according to a specific structure (<code>EditedFilesSchema</code> from <code>utils/singlepass/file_ops.ts</code>) which expects a list of file operations.</li>
<li><b>Response Parsing:</b> The CLI receives the response and uses the <code>EditedFilesSchema</code> to parse the expected list of operations (create file, update file content, delete file, move file).</li>
<li><b>Diffing &amp; Summary:</b> It uses helpers like <code>generateDiffSummary</code> and <code>generateEditSummary</code> from <code>utils/singlepass/code_diff.ts</code> to compare the proposed <code>updated_full_content</code> for each operation against the original file content, generating human-readable diffs and a summary.</li>
<li><b>Confirmation:</b> The main application component (<code>SinglePassApp</code> in <code>components/singlepass-cli-app.tsx</code>) displays the summary and diffs using Ink components and prompts the user for confirmation (<code>ConfirmationPrompt</code>).</li>
<li><b>Application:</b> If confirmed, the <code>applyFileOps</code> function iterates through the parsed operations and uses Node.js's <code>fs.promises</code> module (<code>fsPromises.writeFile</code>, <code>fsPromises.unlink</code>, etc.) to modify the files on disk.</li>
<li><b>Exit:</b> The application cleans up and exits.</li>
</ol>
<h2><a class="anchor" id="autotoc_md1366"></a>
Diving into Code</h2>
<p>Let's look at the key parts involved.</p>
<h3><a class="anchor" id="autotoc_md1367"></a>
Starting Single-Pass Mode (<code>cli_singlepass.tsx</code>)</h3>
<p>This module likely provides the entry point function called by the main CLI when the <code>--single-pass</code> flag is detected.</p>
<div class="fragment"><div class="line">// File: codex-cli/src/cli_singlepass.tsx (Simplified)</div>
<div class="line">import type { AppConfig } from &quot;./utils/config&quot;;</div>
<div class="line">import { SinglePassApp } from &quot;./components/singlepass-cli-app&quot;;</div>
<div class="line">import { render } from &quot;ink&quot;;</div>
<div class="line">import React from &quot;react&quot;;</div>
<div class="line"> </div>
<div class="line">// This function is called by the main CLI logic</div>
<div class="line">export async function runSinglePass({</div>
<div class="line">  originalPrompt, // The user&#39;s request string</div>
<div class="line">  config,         // Loaded configuration (model, instructions)</div>
<div class="line">  rootPath,       // The project directory</div>
<div class="line">}: { /* ... */ }): Promise&lt;void&gt; {</div>
<div class="line">  return new Promise((resolve) =&gt; {</div>
<div class="line">    // Render the dedicated Ink UI for single-pass mode</div>
<div class="line">    render(</div>
<div class="line">      &lt;SinglePassApp</div>
<div class="line">        originalPrompt={originalPrompt}</div>
<div class="line">        config={config}</div>
<div class="line">        rootPath={rootPath}</div>
<div class="line">        onExit={() =&gt; resolve()} // Callback when the app is done</div>
<div class="line">      /&gt;,</div>
<div class="line">    );</div>
<div class="line">  });</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li><b>Explanation:</b> This function simply renders the main React component (<code>SinglePassApp</code>) responsible for the entire single-pass UI and logic, passing along the user's prompt and configuration. It uses a Promise to signal when the process is complete.</li>
</ul>
<h3><a class="anchor" id="autotoc_md1368"></a>
The Main UI and Logic (<code>singlepass-cli-app.tsx</code>)</h3>
<p>This component manages the state (loading, thinking, confirming, etc.) and orchestrates the single-pass flow.</p>
<div class="fragment"><div class="line">// File: codex-cli/src/components/singlepass-cli-app.tsx (Simplified Snippets)</div>
<div class="line">import React, { useEffect, useState } from &quot;react&quot;;</div>
<div class="line">import { Box, Text, useApp } from &quot;ink&quot;;</div>
<div class="line">import OpenAI from &quot;openai&quot;;</div>
<div class="line">import { zodResponseFormat } from &quot;openai/helpers/zod&quot;;</div>
<div class="line">// --- Local Utils ---</div>
<div class="line">import { getFileContents } from &quot;../utils/singlepass/context_files&quot;;</div>
<div class="line">import { renderTaskContext } from &quot;../utils/singlepass/context&quot;;</div>
<div class="line">import { EditedFilesSchema, FileOperation } from &quot;../utils/singlepass/file_ops&quot;;</div>
<div class="line">import { generateDiffSummary, generateEditSummary } from &quot;../utils/singlepass/code_diff&quot;;</div>
<div class="line">import * as fsPromises from &quot;fs/promises&quot;;</div>
<div class="line">// --- UI Components ---</div>
<div class="line">import { InputPrompt, ConfirmationPrompt } from &quot;./prompts&quot;; // Conceptual grouping</div>
<div class="line"> </div>
<div class="line">export function SinglePassApp({ /* ...props: config, rootPath, onExit ... */ }): JSX.Element {</div>
<div class="line">  const app = useApp();</div>
<div class="line">  const [state, setState] = useState(&quot;init&quot;); // &#39;init&#39;, &#39;prompt&#39;, &#39;thinking&#39;, &#39;confirm&#39;, &#39;applied&#39;, &#39;error&#39;...</div>
<div class="line">  const [files, setFiles] = useState([]); // Holds { path, content }</div>
<div class="line">  const [diffInfo, setDiffInfo] = useState({ summary: &quot;&quot;, diffs: &quot;&quot;, ops: [] });</div>
<div class="line"> </div>
<div class="line">  // 1. Load file context on mount</div>
<div class="line">  useEffect(() =&gt; {</div>
<div class="line">    (async () =&gt; {</div>
<div class="line">      const fileContents = await getFileContents(rootPath, /* ignorePatterns */);</div>
<div class="line">      setFiles(fileContents);</div>
<div class="line">      setState(&quot;prompt&quot;); // Ready for user input</div>
<div class="line">    })();</div>
<div class="line">  }, [rootPath]);</div>
<div class="line"> </div>
<div class="line">  // 2. Function to run the AI task</div>
<div class="line">  async function runSinglePassTask(userPrompt: string) {</div>
<div class="line">    setState(&quot;thinking&quot;);</div>
<div class="line">    try {</div>
<div class="line">      // Format the context + prompt for the AI</div>
<div class="line">      const taskContextStr = renderTaskContext({ prompt: userPrompt, files, /*...*/ });</div>
<div class="line"> </div>
<div class="line">      const openai = new OpenAI({ /* ... config ... */ });</div>
<div class="line">      // Call OpenAI, specifying the expected structured response format</div>
<div class="line">      const chatResp = await openai.beta.chat.completions.parse({</div>
<div class="line">        model: config.model,</div>
<div class="line">        messages: [{ role: &quot;user&quot;, content: taskContextStr }],</div>
<div class="line">        response_format: zodResponseFormat(EditedFilesSchema, &quot;schema&quot;), // Ask for this specific structure!</div>
<div class="line">      });</div>
<div class="line"> </div>
<div class="line">      const edited = chatResp.choices[0]?.message?.parsed; // The parsed { ops: [...] } object</div>
<div class="line"> </div>
<div class="line">      if (!edited || !Array.isArray(edited.ops)) { /* Handle no ops */ }</div>
<div class="line"> </div>
<div class="line">      // Generate diffs from the AI&#39;s proposed operations</div>
<div class="line">      const [combinedDiffs, opsToApply] = generateDiffSummary(edited, /* original files map */);</div>
<div class="line">      if (!opsToApply.length) { /* Handle no actual changes */ }</div>
<div class="line"> </div>
<div class="line">      const summary = generateEditSummary(opsToApply, /* original files map */);</div>
<div class="line">      setDiffInfo({ summary, diffs: combinedDiffs, ops: opsToApply });</div>
<div class="line">      setState(&quot;confirm&quot;); // Move to confirmation state</div>
<div class="line"> </div>
<div class="line">    } catch (err) { setState(&quot;error&quot;); }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  // 3. Function to apply the changes</div>
<div class="line">  async function applyFileOps(ops: Array&lt;FileOperation&gt;) {</div>
<div class="line">    for (const op of ops) {</div>
<div class="line">      if (op.delete) {</div>
<div class="line">        await fsPromises.unlink(op.path).catch(() =&gt; {});</div>
<div class="line">      } else { // Create or Update</div>
<div class="line">        const newContent = op.updated_full_content || &quot;&quot;;</div>
<div class="line">        await fsPromises.mkdir(path.dirname(op.path), { recursive: true });</div>
<div class="line">        await fsPromises.writeFile(op.path, newContent, &quot;utf-8&quot;);</div>
<div class="line">      }</div>
<div class="line">      // Handle move_to separately if needed</div>
<div class="line">    }</div>
<div class="line">    setState(&quot;applied&quot;);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  // --- Render logic based on `state` ---</div>
<div class="line">  if (state === &quot;prompt&quot;) {</div>
<div class="line">    return &lt;InputPrompt onSubmit={runSinglePassTask} /* ... */ /&gt;;</div>
<div class="line">  }</div>
<div class="line">  if (state === &quot;thinking&quot;) { /* Show Spinner */ }</div>
<div class="line">  if (state === &quot;confirm&quot;) {</div>
<div class="line">    return (</div>
<div class="line">      &lt;Box flexDirection=&quot;column&quot;&gt;</div>
<div class="line">        {/* Display diffInfo.summary and diffInfo.diffs */}</div>
<div class="line">        &lt;ConfirmationPrompt</div>
<div class="line">          message=&quot;Apply these changes?&quot;</div>
<div class="line">          onResult={(accept) =&gt; {</div>
<div class="line">            if (accept) applyFileOps(diffInfo.ops);</div>
<div class="line">            else setState(&quot;skipped&quot;);</div>
<div class="line">          }}</div>
<div class="line">        /&gt;</div>
<div class="line">      &lt;/Box&gt;</div>
<div class="line">    );</div>
<div class="line">  }</div>
<div class="line">  if (state === &quot;applied&quot;) { /* Show success, maybe offer another prompt */ }</div>
<div class="line">  // ... other states: init, error, skipped ...</div>
<div class="line"> </div>
<div class="line">  return &lt;Text&gt;...&lt;/Text&gt;; // Fallback</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li><b>Explanation:</b> This component uses <code>useEffect</code> to load files initially. The <code>runSinglePassTask</code> function orchestrates calling the AI (using <code>zodResponseFormat</code> to enforce the <code>EditedFilesSchema</code>) and generating diffs. <code>applyFileOps</code> performs the actual file system changes if the user confirms via the <code>ConfirmationPrompt</code>. The UI rendered depends heavily on the current <code>state</code>.</li>
</ul>
<h3><a class="anchor" id="autotoc_md1369"></a>
Defining the AI's Output: <code>file_ops.ts</code></h3>
<p>This file defines the exact structure Codex expects the AI to return in single-pass mode.</p>
<div class="fragment"><div class="line">// File: codex-cli/src/utils/singlepass/file_ops.ts (Simplified)</div>
<div class="line">import { z } from &quot;zod&quot;; // Zod is a schema validation library</div>
<div class="line"> </div>
<div class="line">// Schema for a single file operation</div>
<div class="line">export const FileOperationSchema = z.object({</div>
<div class="line">  path: z.string().describe(&quot;Absolute path to the file.&quot;),</div>
<div class="line">  updated_full_content: z.string().optional().describe(</div>
<div class="line">    &quot;FULL CONTENT of the file after modification. MUST provide COMPLETE content.&quot;</div>
<div class="line">  ),</div>
<div class="line">  delete: z.boolean().optional().describe(&quot;Set true to delete the file.&quot;),</div>
<div class="line">  move_to: z.string().optional().describe(&quot;New absolute path if file is moved.&quot;),</div>
<div class="line">  // Ensure only one action per operation (update, delete, or move)</div>
<div class="line">}).refine(/* ... validation logic ... */);</div>
<div class="line"> </div>
<div class="line">// Schema for the overall response containing a list of operations</div>
<div class="line">export const EditedFilesSchema = z.object({</div>
<div class="line">  ops: z.array(FileOperationSchema).describe(&quot;List of file operations.&quot;),</div>
<div class="line">});</div>
<div class="line"> </div>
<div class="line">export type FileOperation = z.infer&lt;typeof FileOperationSchema&gt;;</div>
<div class="line">export type EditedFiles = z.infer&lt;typeof EditedFilesSchema&gt;;</div>
</div><!-- fragment --><ul>
<li><b>Explanation:</b> This uses the Zod library to define a strict schema. <code>FileOperationSchema</code> describes a single change (update, delete, or move), emphasizing that <code>updated_full_content</code> must be the <em>entire</em> file content. <code>EditedFilesSchema</code> wraps this in a list called <code>ops</code>. This schema is given to the OpenAI API (via <code>zodResponseFormat</code>) to ensure the AI's response is structured correctly.</li>
</ul>
<h3><a class="anchor" id="autotoc_md1370"></a>
Generating Context and Diffs</h3>
<ul>
<li><b><code>context.ts</code> (<code>renderTaskContext</code>):</b> Takes the user prompt and file contents and formats them into the large string sent to the AI, including instructions and often wrapping file content in XML-like tags (<code>&lt;file&gt;&lt;path&gt;...&lt;/path&gt;&lt;content&gt;...&lt;/content&gt;&lt;/file&gt;</code>).</li>
<li><b><code>code_diff.ts</code> (<code>generateDiffSummary</code>, <code>generateEditSummary</code>):</b> Takes the <code>ops</code> returned by the AI and compares the <code>updated_full_content</code> with the original content read from disk. It uses a library (like <code>diff</code>) to generate standard diff text and then formats it (often with colors) and creates a short summary list for display.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1371"></a>
Conclusion</h2>
<p>Single-Pass Mode offers a different, potentially faster way to use Codex for well-defined tasks. By providing extensive context upfront and asking the AI for a complete set of structured file operations in one response, it minimizes back-and-forth. You gather context, send one big request, review the complete proposed solution, and either accept or reject it entirely. While still experimental, it's a powerful approach for streamlining larger refactoring or generation tasks where the requirements are clear.</p>
<p>This concludes our tour through the core concepts of Codex! We've journeyed from the <a class="el" href="../../dd/d7b/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_201__terminal__ui____ink__components__.html">Terminal UI</a> and <a class="el" href="../../d3/dac/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_202__input__handling____textbuffer__editor__.html">Input Handling</a>, through the central <a class="el" href="../../d0/dbd/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_203__agent__loop.html">Agent Loop</a>, into the crucial aspects of <a class="el" href="../../d9/dc7/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_204__approval__policy______security.html">Approval Policy &amp; Security</a>, <a class="el" href="../../dc/db0/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_205__response______tool__call__handling.html">Response &amp; Tool Call Handling</a>, and safe <a class="el" href="../../dd/deb/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_206__command__execution______sandboxing.html">Command Execution &amp; Sandboxing</a>, learned about <a class="el" href="../../d2/d53/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_207__configuration__management.html">Configuration Management</a>, and finally explored the alternative <a class="el" href="../../d5/d1b/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Codex_208__single__pass__mode.html">Single-Pass Mode</a>.</p>
<p>We hope this gives you a solid understanding of how Codex works under the hood. Feel free to dive deeper into the codebase, experiment, and perhaps even contribute!</p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
