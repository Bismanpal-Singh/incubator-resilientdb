#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 07_configuration__config_</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d5/d05/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_207__configuration____config__.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">07_configuration__config_</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md2671"></a>
autotoc_md2671</h2>
<p>layout: default title: "Configuration (config)" parent: "OpenManus" </p>
<h2><a class="anchor" id="autotoc_md2672"></a>
nav_order: 7</h2>
<h1><a class="anchor" id="autotoc_md2673"></a>
Chapter 7: Configuration (Config)</h1>
<p>Welcome to Chapter 7! In <a class="el" href="../../d6/d4f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_206__schema.html">Chapter 6: Schema</a>, we learned how OpenManus uses schemas to define the structure of data passed between different components, like official forms ensuring everyone fills them out correctly.</p>
<p>Now, think about setting up a new application. You often need to tell it <em>how</em> to behave.</p><ul>
<li>Which AI model should it use?</li>
<li>What's the secret key to access that AI?</li>
<li>Should it run code in a restricted "sandbox" environment?</li>
<li>Which search engine should it prefer?</li>
</ul>
<p>These are all <b>settings</b> or <b>configurations</b>. This chapter explores how OpenManus manages these settings using the <code>Config</code> system.</p>
<h2><a class="anchor" id="autotoc_md2674"></a>
What Problem Does Config Solve?</h2>
<p>Imagine you're building a simple app that uses an AI service. You need an API key to access it. Where do you put this key?</p>
<ul>
<li><b>Option 1: Hardcode it directly in the code.</b> <code>python @section autotoc_md2675 Bad idea! Don't do this! api_key = "MY_SUPER_SECRET_API_KEY_12345" @section autotoc_md2676 ... rest of the code uses api_key ... </code> This is a terrible idea! Your secret key is exposed in the code. Sharing the code means sharing your secret. Changing the key means editing the code. What if multiple parts of the code need the key? You'd have it scattered everywhere!</li>
<li><b>Option 2: Use a Configuration System.</b> Keep all settings in a separate, easy-to-read file. The application reads this file when it starts and makes the settings available wherever they're needed.</li>
</ul>
<p>OpenManus uses Option 2. It keeps settings in a file named <code>config.toml</code> and uses a special <code>Config</code> object to manage them.</p>
<p><b>Use Case:</b> Let's say we want our <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a> component to use the "gpt-4o" model and a specific API key. Instead of writing "gpt-4o" and the key directly into the <code>LLM</code> class code, the <code>LLM</code> class will <em>ask</em> the <code>Config</code> system: "What model should I use?" and "What's the API key?". The <code>Config</code> system provides the answers it read from <code>config.toml</code>.</p>
<h2><a class="anchor" id="autotoc_md2677"></a>
Key Concepts: The Settings File and Manager</h2>
<h3><a class="anchor" id="autotoc_md2678"></a>
1. The Settings File (<code>config.toml</code>)</h3>
<p>This is a simple text file located in the <code>config/</code> directory of your OpenManus project. It uses the TOML format (Tom's Obvious, Minimal Language), which is designed to be easy for humans to read.</p>
<p>It contains sections for different parts of the application. Here's a highly simplified snippet:</p>
<div class="fragment"><div class="line"># config/config.toml (Simplified Example)</div>
<div class="line"> </div>
<div class="line">[llm] # Settings for the Large Language Model</div>
<div class="line">model = &quot;gpt-4o&quot;</div>
<div class="line">api_key = &quot;YOUR_OPENAI_API_KEY_HERE&quot; # Replace with your actual key</div>
<div class="line">base_url = &quot;https://api.openai.com/v1&quot;</div>
<div class="line">api_type = &quot;openai&quot;</div>
<div class="line"> </div>
<div class="line">[sandbox] # Settings for the code execution sandbox</div>
<div class="line">use_sandbox = true</div>
<div class="line">image = &quot;python:3.12-slim&quot;</div>
<div class="line">memory_limit = &quot;256m&quot;</div>
<div class="line"> </div>
<div class="line">[search_config] # Settings for web search</div>
<div class="line">engine = &quot;DuckDuckGo&quot;</div>
<div class="line"> </div>
<div class="line">[browser_config] # Settings for the browser tool</div>
<div class="line">headless = false</div>
</div><!-- fragment --><p><b>Explanation:</b></p><ul>
<li><code>[llm]</code>, <code>[sandbox]</code>, etc., define sections.</li>
<li><code>model = "gpt-4o"</code> assigns the value <code>"gpt-4o"</code> to the <code>model</code> setting within the <code>llm</code> section.</li>
<li><code>api_key = "YOUR_..."</code> stores your secret key (you should put your real key here and <b>never</b> share this file publicly if it contains secrets!).</li>
<li><code>use_sandbox = true</code> sets a boolean (true/false) value.</li>
</ul>
<p>This file acts as the central "control panel" list for the application's behavior.</p>
<h3><a class="anchor" id="autotoc_md2679"></a>
2. The Settings Manager (<code>Config</code> class in <code>app/config.py</code>)</h3>
<p>Okay, we have the settings file. How does the application <em>use</em> it?</p>
<p>OpenManus has a special Python class called <code>Config</code> (defined in <code>app/config.py</code>). Think of this class as the <b>Settings Manager</b>. Its job is:</p>
<ol type="1">
<li><b>Read the File:</b> When the application starts, the <code>Config</code> manager reads the <code>config.toml</code> file.</li>
<li><b>Parse and Store:</b> It understands the TOML format and stores the settings internally, often using the Pydantic <a class="el" href="../../d6/d4f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_206__schema.html">Schemas</a> we learned about (like <code>LLMSettings</code>, <code>SandboxSettings</code>) to validate the data.</li>
<li><b>Provide Access:</b> It offers a way for any other part of the application to easily ask for a specific setting (e.g., "Give me the LLM model name").</li>
</ol>
<h3><a class="anchor" id="autotoc_md2680"></a>
3. The Singleton Pattern: One Manager to Rule Them All</h3>
<p>The <code>Config</code> class uses a special design pattern called a <b>Singleton</b>. This sounds fancy, but the idea is simple: <b>There is only ever <em>one</em> instance (object) of the <code>Config</code> manager in the entire application.</b></p>
<p><em>Analogy:</em> Think of the principal's office in a school. There's only one principal's office. If any teacher or student needs official school-wide information (like the date of the next holiday), they go to that single, central office. They don't each have their own separate, potentially conflicting, information source.</p>
<p>The <code>Config</code> object is like that principal's office. When any part of OpenManus (like the <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a> class or the <a class="el" href="../../de/da6/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_208__dockersandbox.html">DockerSandbox</a> class) needs a setting, it asks the <em>same</em>, single <code>Config</code> instance. This ensures everyone is using the same configuration values that were loaded at the start.</p>
<h2><a class="anchor" id="autotoc_md2681"></a>
How Do We Use It? (Accessing Settings)</h2>
<p>Because <code>Config</code> is a singleton, accessing settings is straightforward. You import the pre-created instance and ask for the setting you need.</p>
<p>The single instance is created automatically when <code>app/config.py</code> is first loaded and is made available as <code>config</code>.</p>
<div class="fragment"><div class="line"><span class="comment"># Example of how another part of the code might use the config</span></div>
<div class="line"><span class="keyword">from</span> app.config <span class="keyword">import</span> config <span class="comment"># Import the singleton instance</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Access LLM settings</span></div>
<div class="line">default_llm_settings = config.llm.get(<span class="stringliteral">&quot;default&quot;</span>) <span class="comment"># Get the &#39;default&#39; LLM config</span></div>
<div class="line"><span class="keywordflow">if</span> default_llm_settings:</div>
<div class="line">    model_name = default_llm_settings.model</div>
<div class="line">    api_key = default_llm_settings.api_key</div>
<div class="line">    print(f<span class="stringliteral">&quot;LLM Model: {model_name}&quot;</span>)</div>
<div class="line">    <span class="comment"># Don&#39;t print the API key in real code! This is just for illustration.</span></div>
<div class="line">    <span class="comment"># print(f&quot;LLM API Key: {api_key[:4]}...{api_key[-4:]}&quot;)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Access Sandbox settings</span></div>
<div class="line">use_sandbox_flag = config.sandbox.use_sandbox</div>
<div class="line">sandbox_image = config.sandbox.image</div>
<div class="line">print(f<span class="stringliteral">&quot;Use Sandbox: {use_sandbox_flag}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Sandbox Image: {sandbox_image}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Access Search settings (check if it exists)</span></div>
<div class="line"><span class="keywordflow">if</span> config.search_config:</div>
<div class="line">    search_engine = config.search_config.engine</div>
<div class="line">    print(f<span class="stringliteral">&quot;Preferred Search Engine: {search_engine}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Access Browser settings (check if it exists)</span></div>
<div class="line"><span class="keywordflow">if</span> config.browser_config:</div>
<div class="line">    run_headless = config.browser_config.headless</div>
<div class="line">    print(f<span class="stringliteral">&quot;Run Browser Headless: {run_headless}&quot;</span>)</div>
</div><!-- fragment --><p><b>Explanation:</b></p>
<ol type="1">
<li><code>from app.config import config</code>: We import the single, shared <code>config</code> object.</li>
<li><code>config.llm</code>: Accesses the dictionary of all LLM configurations read from the <code>[llm]</code> sections in <code>config.toml</code>. We use <code>.get("default")</code> to get the settings specifically for the LLM named "default".</li>
<li><code>default_llm_settings.model</code>: Accesses the <code>model</code> attribute of the <code>LLMSettings</code> object. Pydantic ensures this attribute exists and is the correct type.</li>
<li><code>config.sandbox.use_sandbox</code>: Directly accesses the <code>use_sandbox</code> attribute within the <code>sandbox</code> settings object (<code>SandboxSettings</code>).</li>
<li>We check if <code>config.search_config</code> and <code>config.browser_config</code> exist before accessing them, as they might be optional sections in the <code>config.toml</code> file.</li>
</ol>
<p><b>Use Case Example: How <code>LLM</code> Gets Its Settings</b></p>
<p>Let's revisit our use case. When an <code>LLM</code> object is created (often inside a <a class="el" href="../../d0/d71/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_203__baseagent.html">BaseAgent</a>), its initialization code (<code>__init__</code>) looks something like this (simplified):</p>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippet from app/llm.py __init__ method</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">from</span> app.config <span class="keyword">import</span> config, LLMSettings <span class="comment"># Import config and the schema</span></div>
<div class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Optional</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>LLM:</div>
<div class="line">    <span class="comment"># ... other methods ...</span></div>
<div class="line">    <span class="keyword">def </span>__init__(self, config_name: str = <span class="stringliteral">&quot;default&quot;</span>, llm_config: Optional[LLMSettings] = <span class="keywordtype">None</span>):</div>
<div class="line">        <span class="comment"># If specific llm_config isn&#39;t provided, get it from the global config</span></div>
<div class="line">        <span class="keywordflow">if</span> llm_config <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line">            <span class="comment"># Ask the global &#39;config&#39; object for the settings</span></div>
<div class="line">            <span class="comment"># corresponding to &#39;config_name&#39; (e.g., &quot;default&quot;)</span></div>
<div class="line">            llm_settings = config.llm.get(config_name)</div>
<div class="line">            <span class="keywordflow">if</span> <span class="keywordflow">not</span> llm_settings: <span class="comment"># Handle case where the name doesn&#39;t exist</span></div>
<div class="line">                 llm_settings = config.llm.get(<span class="stringliteral">&quot;default&quot;</span>) <span class="comment"># Fallback to default</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">else</span>: <span class="comment"># Use the provided config if given</span></div>
<div class="line">            llm_settings = llm_config</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Store the settings read from the config object</span></div>
<div class="line">        self.model = llm_settings.model</div>
<div class="line">        self.api_key = llm_settings.api_key</div>
<div class="line">        self.base_url = llm_settings.base_url</div>
<div class="line">        <span class="comment"># ... store other settings like max_tokens, temperature ...</span></div>
<div class="line"> </div>
<div class="line">        print(f<span class="stringliteral">&quot;LLM initialized with model: {self.model}&quot;</span>)</div>
<div class="line">        <span class="comment"># Initialize the actual API client using these settings</span></div>
<div class="line">        <span class="comment"># self.client = AsyncOpenAI(api_key=self.api_key, base_url=self.base_url)</span></div>
<div class="line">        <span class="comment"># ... rest of initialization ...</span></div>
</div><!-- fragment --><p><b>Explanation:</b></p><ul>
<li>The <code>LLM</code> class imports the global <code>config</code> object.</li>
<li>In its <code>__init__</code>, it uses <code>config.llm.get(config_name)</code> to retrieve the specific settings (like <code>model</code>, <code>api_key</code>) it needs.</li>
<li>It then uses these retrieved values to configure itself and the underlying API client.</li>
</ul>
<p>This way, the <code>LLM</code> class doesn't need the actual values hardcoded inside it. It just asks the central <code>Config</code> manager. If you want to change the model or API key, you only need to update <code>config.toml</code> and restart the application!</p>
<h2><a class="anchor" id="autotoc_md2682"></a>
Under the Hood: Loading and Providing Settings</h2>
<p>What happens when the application starts and the <code>config</code> object is first used?</p>
<ol type="1">
<li><b>First Access:</b> The first time code tries to <code>import config</code> from <code>app.config</code>, Python runs the code in <code>app.config.py</code>.</li>
<li><b>Singleton Check:</b> The <code>Config</code> class's special <code>__new__</code> method checks if an instance (<code>_instance</code>) already exists. If not, it creates a new one. If it <em>does</em> exist, it just returns the existing one. This ensures only one instance is ever made.</li>
<li><b>Initialization (<code>__init__</code>):</b> The <code>__init__</code> method (run only once for the single instance) calls <code>_load_initial_config</code>.</li>
<li><b>Find File (<code>_get_config_path</code>):</b> It looks for <code>config/config.toml</code>. If that doesn't exist, it looks for <code>config/config.example.toml</code> as a fallback.</li>
<li><b>Read File (<code>_load_config</code>):</b> It opens the found <code>.toml</code> file and uses the standard <code>tomllib</code> library to read its contents into a Python dictionary.</li>
<li><b>Parse &amp; Validate:</b> <code>_load_initial_config</code> takes this raw dictionary and carefully organizes it, using Pydantic models (<code>LLMSettings</code>, <code>SandboxSettings</code>, <code>BrowserSettings</code>, <code>SearchSettings</code>, <code>MCPSettings</code>, all defined in <code>app/config.py</code>) to structure and <em>validate</em> the settings. For example, it creates <code>LLMSettings</code> objects for each entry under <code>[llm]</code>. If a required setting is missing or has the wrong type (e.g., <code>max_tokens</code> is text instead of a number), Pydantic will raise an error here, stopping the app from starting with bad configuration.</li>
<li><b>Store Internally:</b> The validated settings (now nicely structured Pydantic objects) are stored within the <code>Config</code> instance (in <code>self._config</code>).</li>
<li><b>Ready for Use:</b> The <code>config</code> instance is now ready. Subsequent accesses simply return the stored, validated settings via properties like <code>config.llm</code>, <code>config.sandbox</code>, etc.</li>
</ol>
<p><b>Sequence Diagram:</b></p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant App as Application Start</div>
<div class="line">    participant CfgMod as app/config.py</div>
<div class="line">    participant Config as Config Singleton Object</div>
<div class="line">    participant TOML as config.toml File</div>
<div class="line">    participant Parser as TOML Parser &amp; Pydantic</div>
<div class="line">    participant OtherMod as e.g., app/llm.py</div>
<div class="line"> </div>
<div class="line">    App-&gt;&gt;+CfgMod: import config</div>
<div class="line">    Note over CfgMod: First time loading module</div>
<div class="line">    CfgMod-&gt;&gt;+Config: Config() called (implicitly via `config = Config()`)</div>
<div class="line">    Config-&gt;&gt;Config: __new__ checks if _instance exists (it doesn&#39;t)</div>
<div class="line">    Config-&gt;&gt;Config: Creates new Config instance (_instance)</div>
<div class="line">    Config-&gt;&gt;Config: Calls __init__ (only runs once)</div>
<div class="line">    Config-&gt;&gt;Config: _load_initial_config()</div>
<div class="line">    Config-&gt;&gt;Config: _get_config_path() -&gt; finds path</div>
<div class="line">    Config-&gt;&gt;+TOML: Opens file</div>
<div class="line">    TOML--&gt;&gt;-Config: Returns file content</div>
<div class="line">    Config-&gt;&gt;+Parser: Parses TOML content into dict</div>
<div class="line">    Parser--&gt;&gt;-Config: Returns raw_config dict</div>
<div class="line">    Config-&gt;&gt;+Parser: Validates dict using Pydantic models (LLMSettings etc.)</div>
<div class="line">    Parser--&gt;&gt;-Config: Returns validated AppConfig object</div>
<div class="line">    Config-&gt;&gt;Config: Stores validated config internally</div>
<div class="line">    Config--&gt;&gt;-CfgMod: Returns the single instance</div>
<div class="line">    CfgMod--&gt;&gt;-App: Provides `config` instance</div>
<div class="line"> </div>
<div class="line">    App-&gt;&gt;+OtherMod: Code runs (e.g., `LLM()`)</div>
<div class="line">    OtherMod-&gt;&gt;+Config: Accesses property (e.g., `config.llm`)</div>
<div class="line">    Config--&gt;&gt;-OtherMod: Returns stored settings (e.g., Dict[str, LLMSettings])</div>
</div><!-- fragment --><p><b>Code Glimpse (<code>app/config.py</code>):</b></p>
<p>Let's look at the key parts:</p>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippet from app/config.py</span></div>
<div class="line"><span class="keyword">import</span> threading</div>
<div class="line"><span class="keyword">import</span> tomllib</div>
<div class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</div>
<div class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</div>
<div class="line"><span class="comment"># ... other imports like typing ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># --- Pydantic Models for Settings ---</span></div>
<div class="line"><span class="keyword">class </span>LLMSettings(BaseModel): <span class="comment"># Defines structure for [llm] section</span></div>
<div class="line">    model: str</div>
<div class="line">    api_key: str</div>
<div class="line">    <span class="comment"># ... other fields like base_url, max_tokens, api_type ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>SandboxSettings(BaseModel): <span class="comment"># Defines structure for [sandbox] section</span></div>
<div class="line">    use_sandbox: bool</div>
<div class="line">    image: str</div>
<div class="line">    <span class="comment"># ... other fields like memory_limit, timeout ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># ... Similar models for BrowserSettings, SearchSettings, MCPSettings ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>AppConfig(BaseModel): <span class="comment"># Holds all validated settings together</span></div>
<div class="line">    llm: Dict[str, LLMSettings]</div>
<div class="line">    sandbox: Optional[SandboxSettings]</div>
<div class="line">    browser_config: Optional[BrowserSettings]</div>
<div class="line">    search_config: Optional[SearchSettings]</div>
<div class="line">    mcp_config: Optional[MCPSettings]</div>
<div class="line"> </div>
<div class="line"><span class="comment"># --- The Singleton Config Class ---</span></div>
<div class="line"><span class="keyword">class </span>Config:</div>
<div class="line">    _instance = <span class="keywordtype">None</span></div>
<div class="line">    _lock = threading.Lock() <span class="comment"># Ensures thread-safety during creation</span></div>
<div class="line">    _initialized = <span class="keyword">False</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>__new__(cls): <span class="comment"># Controls instance creation (Singleton part 1)</span></div>
<div class="line">        <span class="keywordflow">if</span> cls._instance <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line">            <span class="keyword">with</span> cls._lock:</div>
<div class="line">                <span class="keywordflow">if</span> cls._instance <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line">                    cls._instance = super().__new__(cls)</div>
<div class="line">        <span class="keywordflow">return</span> cls._instance</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>__init__(self): <span class="comment"># Initializes the instance (runs only once)</span></div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self._initialized:</div>
<div class="line">            <span class="keyword">with</span> self._lock:</div>
<div class="line">                <span class="keywordflow">if</span> <span class="keywordflow">not</span> self._initialized:</div>
<div class="line">                    self._config: Optional[AppConfig] = <span class="keywordtype">None</span> <span class="comment"># Where settings are stored</span></div>
<div class="line">                    self._load_initial_config() <span class="comment"># Load from file</span></div>
<div class="line">                    self._initialized = <span class="keyword">True</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>_load_config(self) -&gt; dict: <span class="comment"># Reads the TOML file</span></div>
<div class="line">        config_path = self._get_config_path() <span class="comment"># Finds config.toml or example</span></div>
<div class="line">        <span class="keyword">with</span> config_path.open(<span class="stringliteral">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</div>
<div class="line">            <span class="keywordflow">return</span> tomllib.load(f) <span class="comment"># Parses TOML into a dictionary</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>_load_initial_config(self): <span class="comment"># Parses dict and validates with Pydantic</span></div>
<div class="line">        raw_config = self._load_config()</div>
<div class="line">        <span class="comment"># ... (logic to handle defaults and structure the raw_config dict) ...</span></div>
<div class="line">        <span class="comment"># ... (creates LLMSettings, SandboxSettings etc. from raw_config) ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Validate the final structured dict using AppConfig</span></div>
<div class="line">        self._config = AppConfig(**structured_config_dict)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># --- Properties to Access Settings ---</span></div>
<div class="line">    <span class="preprocessor">@property</span></div>
<div class="line">    <span class="keyword">def </span>llm(self) -&gt; Dict[str, LLMSettings]:</div>
<div class="line">        <span class="comment"># Provides easy access like &#39;config.llm&#39;</span></div>
<div class="line">        <span class="keywordflow">return</span> self._config.llm</div>
<div class="line"> </div>
<div class="line">    <span class="preprocessor">@property</span></div>
<div class="line">    <span class="keyword">def </span>sandbox(self) -&gt; SandboxSettings:</div>
<div class="line">        <span class="comment"># Provides easy access like &#39;config.sandbox&#39;</span></div>
<div class="line">        <span class="keywordflow">return</span> self._config.sandbox</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># ... Properties for browser_config, search_config, mcp_config ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># --- Create the Singleton Instance ---</span></div>
<div class="line"><span class="comment"># This line runs when the module is imported, creating the single instance.</span></div>
<div class="line">config = Config()</div>
</div><!-- fragment --><p><b>Explanation:</b></p><ul>
<li>The Pydantic models (<code>LLMSettings</code>, <code>SandboxSettings</code>, <code>AppConfig</code>) define the expected structure and types for the settings read from <code>config.toml</code>.</li>
<li>The <code>Config</code> class uses <code>__new__</code> and <code>_lock</code> to implement the singleton pattern, ensuring only one instance.</li>
<li><code>__init__</code> calls <code>_load_initial_config</code> only once.</li>
<li><code>_load_initial_config</code> reads the TOML file and uses the Pydantic models (within <code>AppConfig</code>) to parse and validate the settings, storing the result in <code>self._config</code>.</li>
<li><code>@property</code> decorators provide clean access (e.g., <code>config.llm</code>) to the stored settings.</li>
<li><code>config = Config()</code> at the end creates the actual singleton instance that gets imported elsewhere.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2683"></a>
Wrapping Up Chapter 7</h2>
<p>We've learned that the <code>Config</code> system is OpenManus's way of managing application settings. It reads configurations from the <code>config.toml</code> file at startup, validates them using Pydantic <a class="el" href="../../d6/d4f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_206__schema.html">Schemas</a>, and makes them available throughout the application via a single, shared <code>config</code> object (using the singleton pattern). This keeps settings separate from code, making the application more flexible, secure, and easier to manage.</p>
<p>Many components rely on these configurations. For instance, when an agent needs to execute code safely, it might use a <code>DockerSandbox</code>. The settings for this sandbox – like which Docker image to use or how much memory to allow – are read directly from the configuration we just discussed.</p>
<p>Let's move on to <a class="el" href="../../de/da6/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_208__dockersandbox.html">Chapter 8: DockerSandbox</a> to see how OpenManus provides a secure environment for running code generated by agents, using settings managed by our <code>Config</code> system.</p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
