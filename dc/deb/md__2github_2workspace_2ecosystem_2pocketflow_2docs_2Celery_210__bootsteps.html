#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 10_bootsteps</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dc/deb/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_210__bootsteps.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">10_bootsteps</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md1153"></a>
autotoc_md1153</h2>
<p>layout: default title: "Bootsteps" parent: "Celery" </p>
<h2><a class="anchor" id="autotoc_md1154"></a>
nav_order: 10</h2>
<h1><a class="anchor" id="autotoc_md1155"></a>
Chapter 10: Bootsteps - How Celery Workers Start Up</h1>
<p>In <a class="el" href="../../d4/daa/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_209__events.html">Chapter 9: Events</a>, we learned how to monitor the real-time activity within our Celery system. We've now covered most of the key parts of Celery: the <a class="el" href="../../d3/d58/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_201__celery__app.html">Celery App</a>, <a class="el" href="../../d5/db8/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_203__task.html">Task</a>s, the <a class="el" href="../../d3/dd5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_204__broker__connection____amqp__.html">Broker Connection (AMQP)</a>, the <a class="el" href="../../dc/d91/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_205__worker.html">Worker</a>, the <a class="el" href="../../d3/d55/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_206__result__backend.html">Result Backend</a>, <a class="el" href="../../dd/d67/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_207__beat____scheduler__.html">Beat (Scheduler)</a>, <a class="el" href="../../dc/d59/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_208__canvas____signatures______primitives__.html">Canvas (Signatures &amp; Primitives)</a>, and <a class="el" href="../../d4/daa/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_209__events.html">Events</a>.</p>
<p>But have you ever wondered how the Celery worker manages to get all these different parts working together when you start it? When you run <code>celery worker</code>, it needs to connect to the broker, set up the execution pool, start listening for tasks, maybe start the event dispatcher, and possibly even start an embedded Beat scheduler. How does it ensure all these things happen in the correct order? That's where <b>Bootsteps</b> come in.</p>
<h2><a class="anchor" id="autotoc_md1156"></a>
What Problem Do Bootsteps Solve?</h2>
<p>Imagine you're assembling a complex piece of furniture. You have many parts and screws, and the instructions list a specific sequence of steps. You can't attach the tabletop before you've built the legs! Similarly, a Celery worker has many internal components that need to be initialized and started in a precise order.</p>
<p>For example, the worker needs to:</p><ol type="1">
<li>Establish a connection to the <a class="el" href="../../d3/dd5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_204__broker__connection____amqp__.html">Broker Connection (AMQP)</a>.</li>
<li><em>Then</em>, start the consumer logic that uses this connection to fetch tasks.</li>
<li>Set up the execution pool (like prefork or eventlet) that will actually run the tasks.</li>
<li>Start optional components like the <a class="el" href="../../d4/daa/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_209__events.html">Events</a> dispatcher or the embedded <a class="el" href="../../dd/d67/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_207__beat____scheduler__.html">Beat (Scheduler)</a>.</li>
</ol>
<p>If these steps happen out of order (e.g., trying to fetch tasks before connecting to the broker), the worker will fail.</p>
<p><b>Bootsteps</b> provide a framework within Celery to define this startup (and shutdown) sequence. It's like the assembly instructions or a detailed checklist for the worker. Each major component or initialization phase is defined as a "step," and steps can declare dependencies on each other (e.g., "Step B requires Step A to be finished"). Celery uses this information to automatically figure out the correct order to start everything up and, just as importantly, the correct reverse order to shut everything down cleanly.</p>
<p>This makes the worker's internal structure more organized, modular, and easier for Celery developers to extend with new features. As a user, you generally don't write bootsteps yourself, but understanding the concept helps demystify the worker's startup process.</p>
<h2><a class="anchor" id="autotoc_md1157"></a>
Key Concepts</h2>
<ol type="1">
<li><b>Step (<code>Step</code>):</b> A single, distinct part of the worker's startup or shutdown logic. Think of it as one instruction in the assembly manual. Examples include initializing the broker connection, starting the execution pool, or starting the component that listens for task messages (the consumer).</li>
<li><b>Blueprint (<code>Blueprint</code>):</b> A collection of related steps that manage a larger component. For instance, the main "Consumer" component within the worker has its own blueprint defining steps for connection, event handling, task fetching, etc.</li>
<li><b>Dependencies (<code>requires</code>):</b> A step can declare that it needs other steps to be completed first. For example, the step that starts fetching tasks (<code>Tasks</code>) <em>requires</em> the step that establishes the broker connection (<code>Connection</code>).</li>
<li><b>Order:</b> Celery analyzes the <code>requires</code> declarations of all steps within a blueprint (and potentially across blueprints) to build a dependency graph. It then sorts this graph to determine the exact order in which steps must be started. Shutdown usually happens in the reverse order.</li>
</ol>
<h2><a class="anchor" id="autotoc_md1158"></a>
How It Works: The Worker Startup Sequence</h2>
<p>You don't typically interact with bootsteps directly, but you see their effect every time you start a worker.</p>
<p>When you run: <code>celery -A your_app worker --loglevel=info</code></p>
<p>Celery initiates the <b>Worker Controller</b> (<code>WorkController</code>). This controller uses the Bootstep framework, specifically a main <b>Blueprint</b>, to manage its initialization.</p>
<p>Here's a simplified idea of what happens under the hood, orchestrated by Bootsteps:</p>
<ol type="1">
<li><b>Load Blueprint:</b> The <code>WorkController</code> loads its main blueprint, which includes steps for core functionalities.</li>
<li><b>Build Graph:</b> Celery looks at all the steps defined in the blueprint (e.g., <code>Connection</code>, <code>Pool</code>, <code>Consumer</code>, <code>Timer</code>, <code>Events</code>, potentially <code>Beat</code>) and their <code>requires</code> attributes. It builds a dependency graph.</li>
<li><b>Determine Order:</b> It calculates the correct startup order from the graph (a "topological sort"). For example, it determines that <code>Connection</code> must start before <code>Consumer</code>, and <code>Pool</code> must start before <code>Consumer</code> can start dispatching tasks to it.</li>
<li><b>Execute Steps:</b> The <code>WorkController</code> iterates through the steps in the determined order and calls each step's <code>start</code> method.<ul>
<li>The <code>Connection</code> step establishes the link to the broker.</li>
<li>The <code>Timer</code> step sets up internal timers.</li>
<li>The <code>Pool</code> step initializes the execution pool (e.g., starts prefork child processes).</li>
<li>The <code>Events</code> step starts the event dispatcher (if <code>-E</code> was used).</li>
<li>The <code>Consumer</code> step (usually last) starts the main loop that fetches tasks from the broker and dispatches them to the pool.</li>
</ul>
</li>
<li><b>Worker Ready:</b> Once all essential bootsteps have successfully started, the worker prints the "ready" message and begins processing tasks.</li>
</ol>
<p>When you stop the worker (e.g., with Ctrl+C), a similar process happens in reverse using the steps' <code>stop</code> or <code>terminate</code> methods, ensuring connections are closed, pools are shut down, etc., in the correct order.</p>
<h2><a class="anchor" id="autotoc_md1159"></a>
Internal Implementation Walkthrough</h2>
<p>Let's visualize the simplified startup flow managed by bootsteps:</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant CLI as `celery worker ...`</div>
<div class="line">    participant WorkerMain as Worker Main Process</div>
<div class="line">    participant Blueprint as Main Worker Blueprint</div>
<div class="line">    participant DepGraph as Dependency Graph Builder</div>
<div class="line">    participant Step1 as Connection Step</div>
<div class="line">    participant Step2 as Pool Step</div>
<div class="line">    participant Step3 as Consumer Step</div>
<div class="line"> </div>
<div class="line">    CLI-&gt;&gt;WorkerMain: Start worker command</div>
<div class="line">    WorkerMain-&gt;&gt;Blueprint: Load blueprint definition (steps &amp; requires)</div>
<div class="line">    Blueprint-&gt;&gt;DepGraph: Define steps and dependencies</div>
<div class="line">    DepGraph-&gt;&gt;Blueprint: Return sorted startup order [Step1, Step2, Step3]</div>
<div class="line">    WorkerMain-&gt;&gt;Blueprint: Iterate through sorted steps</div>
<div class="line">    Blueprint-&gt;&gt;Step1: Call start()</div>
<div class="line">    Step1--&gt;&gt;Blueprint: Connection established</div>
<div class="line">    Blueprint-&gt;&gt;Step2: Call start()</div>
<div class="line">    Step2--&gt;&gt;Blueprint: Pool initialized</div>
<div class="line">    Blueprint-&gt;&gt;Step3: Call start()</div>
<div class="line">    Step3--&gt;&gt;Blueprint: Consumer loop started</div>
<div class="line">    Blueprint--&gt;&gt;WorkerMain: Startup complete</div>
<div class="line">    WorkerMain-&gt;&gt;WorkerMain: Worker is Ready</div>
</div><!-- fragment --><p>The Bootstep framework relies on classes defined mainly in <code>celery/bootsteps.py</code>.</p>
<h2><a class="anchor" id="autotoc_md1160"></a>
Code Dive: Anatomy of a Bootstep</h2>
<p>Bootsteps are defined as classes inheriting from <code>Step</code> or <code>StartStopStep</code>.</p>
<ul>
<li><p class="startli"><b>Defining a Step:</b> A step class defines its logic and dependencies.</p>
<p class="startli">```python </p>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md1161"></a>
Simplified concept from celery/bootsteps.py</h1>
<h1><a class="anchor" id="autotoc_md1162"></a>
Base class for all steps</h1>
<p>class Step: </p>
<h1><a class="anchor" id="autotoc_md1163"></a>
List of other Step classes needed before this one runs</h1>
<p>requires = ()</p>
<p>def <b>init</b>(self, parent, **kwargs): </p>
<h1><a class="anchor" id="autotoc_md1164"></a>
Called when the blueprint is applied to the parent (e.g., Worker)</h1>
<h1><a class="anchor" id="autotoc_md1165"></a>
Can be used to set initial attributes on the parent.</h1>
<p>pass</p>
<p>def create(self, parent): </p>
<h1><a class="anchor" id="autotoc_md1166"></a>
Create the service/component managed by this step.</h1>
<h1><a class="anchor" id="autotoc_md1167"></a>
Often returns an object to be stored.</h1>
<p>pass</p>
<p>def include(self, parent): </p>
<h1><a class="anchor" id="autotoc_md1168"></a>
Logic to add this step to the parent's step list.</h1>
<h1><a class="anchor" id="autotoc_md1169"></a>
Called after <b>init</b>.</h1>
<p>if self.should_include(parent): self.obj = self.create(parent) # Store created object if needed parent.steps.append(self) return True return False</p>
<h1><a class="anchor" id="autotoc_md1170"></a>
A common step type with start/stop/terminate methods</h1>
<p>class StartStopStep(Step): obj = None # Holds the object created by self.create</p>
<p>def start(self, parent): </p>
<h1><a class="anchor" id="autotoc_md1171"></a>
Logic to start the component/service</h1>
<p>if self.obj and hasattr(self.obj, 'start'): self.obj.start()</p>
<p>def stop(self, parent): </p>
<h1><a class="anchor" id="autotoc_md1172"></a>
Logic to stop the component/service gracefully</h1>
<p>if self.obj and hasattr(self.obj, 'stop'): self.obj.stop()</p>
<p>def terminate(self, parent): </p>
<h1><a class="anchor" id="autotoc_md1173"></a>
Logic to force shutdown (if different from stop)</h1>
<p>if self.obj: term_func = getattr(self.obj, 'terminate', None) or getattr(self.obj, 'stop', None) if term_func: term_func()</p>
<h1><a class="anchor" id="autotoc_md1174"></a>
include() method adds self to parent.steps if created</h1>
<p>``<code> **Explanation:** *</code>requires<code>: A tuple of other Step classes that must be fully started *before* this step's</code>start<code>method is called. This defines the dependencies. *</code>__init__<code>,</code>create<code>,</code>include<code>: Methods involved in setting up the step and potentially creating the component it manages. *</code>start<code>,</code>stop<code>,</code>terminate`: Methods called during the worker's lifecycle (startup, graceful shutdown, forced shutdown).</p>
<ul>
<li><p class="startli"><b>Blueprint:</b> Manages a collection of steps.</p>
<p class="startli">```python </p>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md1175"></a>
Simplified concept from celery/bootsteps.py</h1>
<p>from celery.utils.graph import DependencyGraph</p>
<p>class Blueprint: </p>
<h1><a class="anchor" id="autotoc_md1176"></a>
Set of default step classes (or string names) included in this blueprint</h1>
<p>default_steps = <a class="el" href="../../d7/da6/pybind__kv__service_8cpp.html#a26ae8807a2b3217bb2339bd18aaaa4e6">set()</a></p>
<p>def <b>init</b>(self, steps=None, name=None, **kwargs): self.name = name or self.__class__.__name__ </p>
<h1><a class="anchor" id="autotoc_md1177"></a>
Combine default steps with any provided steps</h1>
<p>self.types = set(steps or []) | set(self.default_steps) self.steps = {} # Will hold step instances self.order = [] # Will hold sorted step instances </p>
<h1><a class="anchor" id="autotoc_md1178"></a>
... other callbacks ...</h1>
<p>def apply(self, parent, **kwargs): </p>
<h1><a class="anchor" id="autotoc_md1179"></a>
1. Load step classes from self.types</h1>
<p>step_classes = self.claim_steps() # {name: StepClass, ...}</p>
<h1><a class="anchor" id="autotoc_md1180"></a>
2. Build the dependency graph</h1>
<p>self.graph = DependencyGraph( ((Cls, Cls.requires) for Cls in step_classes.values()), </p>
<h1><a class="anchor" id="autotoc_md1181"></a>
... formatter options ...</h1>
<p>)</p>
<h1><a class="anchor" id="autotoc_md1182"></a>
3. Get the topologically sorted order</h1>
<p>sorted_classes = self.graph.topsort()</p>
<h1><a class="anchor" id="autotoc_md1183"></a>
4. Instantiate and include each step</h1>
<p>self.order = [] for S in sorted_classes: step = S(parent, **kwargs) # Call Step.__init__ self.steps[step.name] = step self.order.append(step) for step in self.order: step.include(parent) # Call Step.include -&gt; Step.create</p>
<p>return self</p>
<p>def start(self, parent): </p>
<h1><a class="anchor" id="autotoc_md1184"></a>
Called by the parent (e.g., Worker) to start all steps</h1>
<p>for step in self.order: # Use the sorted order if hasattr(step, 'start'): step.start(parent)</p>
<p>def stop(self, parent): </p>
<h1><a class="anchor" id="autotoc_md1185"></a>
Called by the parent to stop all steps (in reverse order)</h1>
<p>for step in reversed(self.order): if hasattr(step, 'stop'): step.stop(parent) </p>
<h1><a class="anchor" id="autotoc_md1186"></a>
... other methods like close, terminate, restart ...</h1>
<p>``<code> **Explanation:** *</code>default_steps<code>: Defines the standard components managed by this blueprint. *</code>apply<code>: The core method that takes the step definitions, builds the</code>DependencyGraph<code>based on</code>requires<code>, gets the sorted execution</code>order<code>, and then instantiates and includes each step. *</code>start<code>/</code>stop<code>: Iterate through the calculated</code>order` (or its reverse) to start/stop the components managed by each step.</p>
<ul>
<li><b>Example Usage (Worker Components):</b> The worker's main components are defined as bootsteps in <code>celery/worker/components.py</code>. You can see classes like <code>Pool</code>, <code>Consumer</code>, <code>Timer</code>, <code>Beat</code>, each inheriting from <code>bootsteps.Step</code> or <code>bootsteps.StartStopStep</code> and potentially defining <code>requires</code>. The <code>Consumer</code> blueprint in <code>celery/worker/consumer/consumer.py</code> then lists many of these (<code>Connection</code>, <code>Events</code>, <code>Tasks</code>, etc.) in its <code>default_steps</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md1187"></a>
Conclusion</h2>
<p>You've learned about Bootsteps, the underlying framework that brings order to the Celery worker's startup and shutdown procedures.</p>
<ul>
<li>They act as an <b>assembly guide</b> or <b>checklist</b> for the worker.</li>
<li>Each core function (connecting, starting pool, consuming tasks) is a <b>Step</b>.</li>
<li>Steps declare <b>Dependencies</b> (<code>requires</code>) on each other.</li>
<li>A <b>Blueprint</b> groups related steps.</li>
<li>Celery uses a <b>Dependency Graph</b> to determine the correct <b>order</b> to start and stop steps.</li>
<li>This ensures components like the <a class="el" href="../../d3/dd5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_204__broker__connection____amqp__.html">Broker Connection (AMQP)</a>, <a class="el" href="../../dc/d91/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Celery_205__worker.html">Worker</a> pool, and task consumer initialize and terminate predictably.</li>
</ul>
<p>While you typically don't write bootsteps as an end-user, understanding their role clarifies how the complex machinery of a Celery worker reliably comes to life and shuts down.</p>
<hr  />
<p>This concludes our introductory tour of Celery's core concepts! We hope these chapters have given you a solid foundation for understanding how Celery works and how you can use it to build robust and scalable distributed applications. Happy tasking!</p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
