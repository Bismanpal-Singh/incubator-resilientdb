#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 10_settings</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d6/ddc/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_210__settings.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">10_settings</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md1709"></a>
autotoc_md1709</h2>
<p>layout: default title: "Settings" parent: "DSPy" </p>
<h2><a class="anchor" id="autotoc_md1710"></a>
nav_order: 10</h2>
<h1><a class="anchor" id="autotoc_md1711"></a>
Chapter 10: Settings - Your Program's Control Panel</h1>
<p>Welcome to the final chapter of our introductory DSPy tutorial! In <a class="el" href="../../d3/dc3/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_209__adapter.html">Chapter 9: Adapter</a>, we saw how Adapters act as translators, allowing our DSPy programs to communicate seamlessly with different types of Language Models (LMs).</p>
<p>Throughout the previous chapters, we've seen snippets like <code>dspy.settings.configure(lm=...)</code> and <code>dspy.settings.configure(rm=...)</code>. We mentioned that modules like <code>dspy.Predict</code> or <code>dspy.Retrieve</code> automatically find and use these configured components. But how does this central configuration work? How do we manage these important defaults for our entire project?</p>
<p>That's where <b><code>dspy.settings</code></b> comes in! It's the central control panel for your DSPy project.</p>
<p>Think of <code>dspy.settings</code> like the <b>Defaults menu</b> in a software application:</p><ul>
<li>You set your preferred font, theme, or language once in the settings.</li>
<li>The entire application then uses these defaults unless you specifically choose something different for a particular document or window.</li>
</ul>
<p><code>dspy.settings</code> does the same for your DSPy programs. It holds the default <a class="el" href="../../d9/db7/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_205__lm____language__model__client__.html">LM (Language Model Client)</a>, <a class="el" href="../../d9/d67/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_206__rm____retrieval__model__client__.html">RM (Retrieval Model Client)</a>, and <a class="el" href="../../d3/dc3/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_209__adapter.html">Adapter</a> that your modules will use.</p>
<p>In this chapter, you'll learn:</p>
<ul>
<li>Why a central settings object is useful.</li>
<li>How to configure global defaults using <code>dspy.settings.configure</code>.</li>
<li>How modules automatically use these settings.</li>
<li>How to temporarily override settings for specific parts of your code using <code>dspy.context</code>.</li>
</ul>
<p>Let's learn how to manage our program's defaults!</p>
<h2><a class="anchor" id="autotoc_md1712"></a>
Why Use <code>dspy.settings</code>?</h2>
<p>Imagine building a complex DSPy <a class="el" href="../../d8/d9f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_201__module______program.html">Program</a> with many sub-modules that need to call an LM or an RM. Without a central settings object, you might have to pass the LM and RM instances explicitly to every single module during initialization or when calling them. This would be tedious and make your code harder to manage.</p>
<div class="fragment"><div class="line"><span class="comment"># --- WITHOUT dspy.settings (Conceptual - DON&#39;T DO THIS) ---</span></div>
<div class="line"><span class="keyword">import</span> dspy</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Assume lm_instance and rm_instance are created somewhere</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>GenerateSearchQuery(dspy.Module):</div>
<div class="line">    <span class="keyword">def </span>__init__(self, lm): <span class="comment"># Needs LM passed in</span></div>
<div class="line">        self.predictor = dspy.Predict(<span class="stringliteral">&#39;question -&gt; query&#39;</span>, lm=lm) <span class="comment"># Pass LM to Predict</span></div>
<div class="line">    <span class="comment"># ... forward ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>RetrieveContext(dspy.Module):</div>
<div class="line">    <span class="keyword">def </span>__init__(self, rm): <span class="comment"># Needs RM passed in</span></div>
<div class="line">        self.retriever = dspy.Retrieve(rm=rm, k=3) <span class="comment"># Pass RM to Retrieve</span></div>
<div class="line">    <span class="comment"># ... forward ...</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># ... other modules needing lm or rm ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ComplexRAG(dspy.Module):</div>
<div class="line">    <span class="keyword">def </span>__init__(self, lm, rm): <span class="comment"># Needs LM and RM passed in</span></div>
<div class="line">        self.gen_query = GenerateSearchQuery(lm=lm) <span class="comment"># Pass LM down</span></div>
<div class="line">        self.retrieve = RetrieveContext(rm=rm)    <span class="comment"># Pass RM down</span></div>
<div class="line">        <span class="comment"># ... other sub-modules needing lm or rm ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>forward(self, question, lm=None, rm=None): <span class="comment"># Maybe pass them here too? Messy!</span></div>
<div class="line">        <span class="comment"># ... use sub-modules ...</span></div>
</div><!-- fragment --><p> This gets complicated quickly!</p>
<p><code>dspy.settings</code> solves this by providing a single, global place to store these configurations. You configure it once, and all DSPy modules can access the defaults they need automatically.</p>
<h2><a class="anchor" id="autotoc_md1713"></a>
Configuring Global Defaults</h2>
<p>The primary way to set defaults is using the <code>dspy.settings.configure</code> method. You typically do this once near the beginning of your script or application.</p>
<p>Let's set up a default LM and RM:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> dspy</div>
<div class="line"> </div>
<div class="line"><span class="comment"># 1. Create your LM and RM instances (as seen in Chapters 5 &amp; 6)</span></div>
<div class="line"><span class="comment"># Example using OpenAI and a dummy RM</span></div>
<div class="line"><span class="keywordflow">try</span>:</div>
<div class="line">    <span class="comment"># Assumes OPENAI_API_KEY is set</span></div>
<div class="line">    turbo = dspy.LM(model=<span class="stringliteral">&#39;openai/gpt-3.5-turbo-instruct&#39;</span>, max_tokens=100)</div>
<div class="line"><span class="keywordflow">except</span> ImportError:</div>
<div class="line">    print(<span class="stringliteral">&quot;Note: dspy[openai] not installed. Using dummy LM.&quot;</span>)</div>
<div class="line">    <span class="comment"># Define a dummy LM if OpenAI isn&#39;t available</span></div>
<div class="line">    <span class="keyword">class </span>DummyLM(dspy.LM):</div>
<div class="line">        <span class="keyword">def </span>__init__(self): super().__init__(model=<span class="stringliteral">&quot;dummy&quot;</span>)</div>
<div class="line">        <span class="keyword">def </span>basic_request(self, prompt, **kwargs): <span class="keywordflow">return</span> {<span class="stringliteral">&quot;choices&quot;</span>: [{<span class="stringliteral">&quot;text&quot;</span>: <span class="stringliteral">&quot;Dummy LM Response&quot;</span>}]}</div>
<div class="line">        <span class="keyword">def </span>__call__(self, prompt, **kwargs): <span class="keywordflow">return</span> [<span class="stringliteral">&quot;Dummy LM Response&quot;</span>]</div>
<div class="line">    turbo = DummyLM()</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment"># Dummy RM for demonstration</span></div>
<div class="line"><span class="keyword">class </span>DummyRM(dspy.Retrieve):</div>
<div class="line">     <span class="keyword">def </span>__init__(self, k=3): super().__init__(k=k)</div>
<div class="line">     <span class="keyword">def </span>forward(self, query, k=None):</div>
<div class="line">         k = k <span class="keywordflow">if</span> k <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> self.k</div>
<div class="line">         <span class="keywordflow">return</span> dspy.Prediction(passages=[f<span class="stringliteral">&quot;Dummy passage {i+1} for &#39;{query}&#39;&quot;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(k)])</div>
<div class="line">my_rm = DummyRM(k=3)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># 2. Configure dspy.settings with these instances</span></div>
<div class="line">dspy.settings.configure(lm=turbo, rm=my_rm)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># That&#39;s it! Defaults are now set globally.</span></div>
<div class="line">print(f<span class="stringliteral">&quot;Default LM: {dspy.settings.lm}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Default RM: {dspy.settings.rm}&quot;</span>)</div>
</div><!-- fragment --><p><b>Output (example):</b></p>
<div class="fragment"><div class="line">Default LM: LM(model=&#39;openai/gpt-3.5-turbo-instruct&#39;, temperature=0.0, max_tokens=100, ...) # Or DummyLM</div>
<div class="line">Default RM: Retrieve(k=3) # Or DummyRM</div>
</div><!-- fragment --><p>Now, any <code>dspy.Predict</code>, <code>dspy.ChainOfThought</code>, or <code>dspy.Retrieve</code> module created <em>after</em> this configuration will automatically use <code>turbo</code> as the LM and <code>my_rm</code> as the RM, unless told otherwise explicitly.</p>
<h2><a class="anchor" id="autotoc_md1714"></a>
How Modules Use the Settings</h2>
<p>Modules like <code>dspy.Predict</code> and <code>dspy.Retrieve</code> are designed to look for their required components (LM or RM) in <code>dspy.settings</code> if they aren't provided directly.</p>
<p>Consider <code>dspy.Predict</code>:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> dspy</div>
<div class="line"><span class="comment"># Assume settings were configured as above</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create a Predict module WITHOUT passing &#39;lm&#39; explicitly</span></div>
<div class="line">simple_predictor = dspy.Predict(<span class="stringliteral">&#39;input -&gt; output&#39;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># When we call it, it will automatically use dspy.settings.lm</span></div>
<div class="line">result = simple_predictor(input=<span class="stringliteral">&quot;Tell me a fact.&quot;</span>)</div>
<div class="line">print(result.output)</div>
</div><!-- fragment --><p><b>Output (using DummyLM):</b></p>
<div class="fragment"><div class="line">Dummy LM Response</div>
</div><!-- fragment --><p>Inside its <code>forward</code> method, <code>dspy.Predict</code> essentially does this (simplified):</p>
<div class="fragment"><div class="line"><span class="comment"># Simplified internal logic of dspy.Predict.forward()</span></div>
<div class="line"><span class="keyword">def </span>forward(self, **kwargs):</div>
<div class="line">  <span class="comment"># ... get signature, demos, config ...</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment"># Get the LM: Use &#39;lm&#39; passed in kwargs, OR self.lm (if set), OR dspy.settings.lm</span></div>
<div class="line">  lm_to_use = kwargs.pop(<span class="stringliteral">&quot;lm&quot;</span>, self.lm) <span class="keywordflow">or</span> dspy.settings.lm</div>
<div class="line">  <span class="keyword">assert</span> lm_to_use <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>, <span class="stringliteral">&quot;No LM configured!&quot;</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment"># ... format prompt using signature/demos/inputs ...</span></div>
<div class="line">  <span class="comment"># ... call lm_to_use(prompt, ...) ...</span></div>
<div class="line">  <span class="comment"># ... parse output ...</span></div>
<div class="line">  <span class="comment"># ... return Prediction ...</span></div>
</div><!-- fragment --><p>Similarly, <code>dspy.Retrieve</code> looks for <code>dspy.settings.rm</code>:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> dspy</div>
<div class="line"><span class="comment"># Assume settings were configured as above</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create a Retrieve module WITHOUT passing &#39;rm&#39; explicitly</span></div>
<div class="line">retriever = dspy.Retrieve() <span class="comment"># Uses default k=3 from DummyRM initialization</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># When called, it uses dspy.settings.rm</span></div>
<div class="line">results = retriever(query=<span class="stringliteral">&quot;DSPy benefits&quot;</span>)</div>
<div class="line">print(results.passages)</div>
</div><!-- fragment --><p><b>Output (using DummyRM):</b></p>
<div class="fragment"><div class="line">[&quot;Dummy passage 1 for &#39;DSPy benefits&#39;&quot;, &quot;Dummy passage 2 for &#39;DSPy benefits&#39;&quot;, &quot;Dummy passage 3 for &#39;DSPy benefits&#39;&quot;]</div>
</div><!-- fragment --><p>This automatic lookup makes your program code much cleaner, as you don't need to thread the <code>lm</code> and <code>rm</code> objects through every part of your application.</p>
<h2><a class="anchor" id="autotoc_md1715"></a>
Temporary Overrides with <code>dspy.context</code></h2>
<p>Sometimes, you might want to use a <em>different</em> LM or RM for just a specific part of your code, without changing the global default. For example, maybe you want to use a more powerful (and expensive) LM like GPT-4 for a critical reasoning step, while using a cheaper LM like GPT-3.5 for the rest of the program.</p>
<p>You can achieve this using the <code>dspy.settings.context</code> context manager. Changes made inside a <code>with dspy.settings.context(...)</code> block are <b>thread-local</b> and only last until the block exits.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> dspy</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Assume global settings have &#39;turbo&#39; (GPT-3.5 or Dummy) as the LM</span></div>
<div class="line"><span class="comment"># dspy.settings.configure(lm=turbo, rm=my_rm)</span></div>
<div class="line"> </div>
<div class="line">print(f<span class="stringliteral">&quot;Outside context: {dspy.settings.lm}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Let&#39;s create a more powerful (dummy) LM for demonstration</span></div>
<div class="line"><span class="keyword">class </span>DummyGPT4(dspy.LM):</div>
<div class="line">    <span class="keyword">def </span>__init__(self): super().__init__(model=<span class="stringliteral">&quot;dummy-gpt4&quot;</span>)</div>
<div class="line">    <span class="keyword">def </span>basic_request(self, prompt, **kwargs): <span class="keywordflow">return</span> {<span class="stringliteral">&quot;choices&quot;</span>: [{<span class="stringliteral">&quot;text&quot;</span>: <span class="stringliteral">&quot;GPT-4 Dummy Response&quot;</span>}]}</div>
<div class="line">    <span class="keyword">def </span>__call__(self, prompt, **kwargs): <span class="keywordflow">return</span> [<span class="stringliteral">&quot;GPT-4 Dummy Response&quot;</span>]</div>
<div class="line">gpt4_dummy = DummyGPT4()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Use dspy.context to temporarily switch the LM</span></div>
<div class="line"><span class="keyword">with</span> dspy.settings.context(lm=gpt4_dummy, rm=<span class="keywordtype">None</span>): <span class="comment"># Temporarily set lm, unset rm</span></div>
<div class="line">    print(f<span class="stringliteral">&quot;Inside context: {dspy.settings.lm}&quot;</span>)</div>
<div class="line">    print(f<span class="stringliteral">&quot;Inside context (RM): {dspy.settings.rm}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Modules used inside this block will use the temporary settings</span></div>
<div class="line">    predictor_in_context = dspy.Predict(<span class="stringliteral">&#39;input -&gt; output&#39;</span>)</div>
<div class="line">    result_in_context = predictor_in_context(input=<span class="stringliteral">&quot;Complex reasoning task&quot;</span>)</div>
<div class="line">    print(f<span class="stringliteral">&quot;Prediction in context: {result_in_context.output}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># Trying to use RM here would fail as it&#39;s None in this context</span></div>
<div class="line">    <span class="comment"># retriever_in_context = dspy.Retrieve()</span></div>
<div class="line">    <span class="comment"># retriever_in_context(query=&quot;something&quot;) # This would raise an error</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Settings revert back automatically outside the block</span></div>
<div class="line">print(f<span class="stringliteral">&quot;Outside context again: {dspy.settings.lm}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Outside context again (RM): {dspy.settings.rm}&quot;</span>)</div>
</div><!-- fragment --><p><b>Output (example):</b></p>
<div class="fragment"><div class="line">Outside context: LM(model=&#39;openai/gpt-3.5-turbo-instruct&#39;, ...) # Or DummyLM</div>
<div class="line">Inside context: LM(model=&#39;dummy-gpt4&#39;, ...)</div>
<div class="line">Inside context (RM): None</div>
<div class="line">Prediction in context: GPT-4 Dummy Response</div>
<div class="line">Outside context again: LM(model=&#39;openai/gpt-3.5-turbo-instruct&#39;, ...) # Or DummyLM</div>
<div class="line">Outside context again (RM): Retrieve(k=3) # Or DummyRM</div>
</div><!-- fragment --><p>Inside the <code>with</code> block, <code>dspy.settings.lm</code> temporarily pointed to <code>gpt4_dummy</code>, and <code>dspy.settings.rm</code> was temporarily <code>None</code>. The <code>predictor_in_context</code> used the temporary LM. Once the block ended, the settings automatically reverted to the global defaults.</p>
<p>This is crucial for writing clean code where different parts might need different configurations, and also essential for how DSPy's optimizers (<a class="el" href="../../dc/d0a/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_208__teleprompter______optimizer.html">Chapter 8: Teleprompter / Optimizer</a>) work internally to manage different model configurations during optimization.</p>
<h2><a class="anchor" id="autotoc_md1716"></a>
How It Works Under the Hood</h2>
<p><code>dspy.settings</code> uses a combination of global variables and thread-local storage to manage configurations.</p>
<ol type="1">
<li><b>Global Defaults:</b> There's a primary configuration dictionary (<code>main_thread_config</code>) that holds the settings configured by <code>dspy.settings.configure()</code>.</li>
<li><b>Ownership:</b> To prevent race conditions in multi-threaded applications, only the <em>first</em> thread that calls <code>configure</code> becomes the "owner" and is allowed to make further global changes using <code>configure</code>.</li>
<li><b>Thread-Local Overrides:</b> <code>dspy.settings.context()</code> uses Python's <code>threading.local</code> storage. When you enter a <code>with dspy.settings.context(...)</code> block, it stores the specified overrides (<code>lm=gpt4_dummy</code>, etc.) in a place specific to the current thread.</li>
<li><b>Attribute Access:</b> When code accesses <code>dspy.settings.lm</code>, the <code>Settings</code> object first checks if there's an override for <code>lm</code> in the current thread's local storage.<ul>
<li>If yes, it returns the thread-local override.</li>
<li>If no, it returns the value from the global <code>main_thread_config</code>.</li>
</ul>
</li>
<li><b>Context Exit:</b> When the <code>with</code> block finishes, the <code>context</code> manager restores the thread-local storage to its state <em>before</em> the block was entered, effectively removing the temporary overrides for that thread.</li>
</ol>
<p><b>Sequence Diagram: Module Accessing Settings</b></p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant User</div>
<div class="line">    participant Module as Your Module (e.g., Predict)</div>
<div class="line">    participant Settings as dspy.settings</div>
<div class="line">    participant ThreadLocalStorage as Thread-Local Storage</div>
<div class="line">    participant GlobalConfig as Global Defaults</div>
<div class="line"> </div>
<div class="line">    User-&gt;&gt;Module: Call module(input=...)</div>
<div class="line">    Module-&gt;&gt;Settings: Get configured lm (`settings.lm`)</div>
<div class="line">    Settings-&gt;&gt;ThreadLocalStorage: Check for &#39;lm&#39; override?</div>
<div class="line">    alt Override Exists</div>
<div class="line">        ThreadLocalStorage--&gt;&gt;Settings: Return thread-local lm</div>
<div class="line">        Settings--&gt;&gt;Module: Return thread-local lm</div>
<div class="line">    else No Override</div>
<div class="line">        ThreadLocalStorage--&gt;&gt;Settings: No override found</div>
<div class="line">        Settings-&gt;&gt;GlobalConfig: Get global &#39;lm&#39;</div>
<div class="line">        GlobalConfig--&gt;&gt;Settings: Return global lm</div>
<div class="line">        Settings--&gt;&gt;Module: Return global lm</div>
<div class="line">    end</div>
<div class="line">    Module-&gt;&gt;Module: Use the returned lm for processing...</div>
<div class="line">    Module--&gt;&gt;User: Return result</div>
</div><!-- fragment --><p>This mechanism ensures that global settings are the default, but thread-specific overrides via <code>dspy.context</code> take precedence when active, providing both convenience and flexibility.</p>
<p><b>Relevant Code Files:</b></p>
<ul>
<li><code>dspy/dsp/utils/settings.py</code>: Defines the <code>Settings</code> class, the <code>DEFAULT_CONFIG</code>, manages global state (<code>main_thread_config</code>, <code>config_owner_thread_id</code>), uses <code>threading.local</code> for overrides, and implements the <code>configure</code> method and the <code>context</code> context manager.</li>
</ul>
<div class="fragment"><div class="line"><span class="comment"># Simplified view from dspy/dsp/utils/settings.py</span></div>
<div class="line"><span class="keyword">import</span> copy</div>
<div class="line"><span class="keyword">import</span> threading</div>
<div class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</div>
<div class="line"><span class="comment"># from dspy.dsp.utils.utils import dotdict # Simplified as dict</span></div>
<div class="line"> </div>
<div class="line">DEFAULT_CONFIG = dict(lm=<span class="keywordtype">None</span>, rm=<span class="keywordtype">None</span>, adapter=<span class="keywordtype">None</span>, ...) <span class="comment"># Default values</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Global state</span></div>
<div class="line">main_thread_config = copy.deepcopy(DEFAULT_CONFIG)</div>
<div class="line">config_owner_thread_id = <span class="keywordtype">None</span></div>
<div class="line">global_lock = threading.Lock()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Thread-local storage for overrides</span></div>
<div class="line"><span class="keyword">class </span>ThreadLocalOverrides(threading.local):</div>
<div class="line">    <span class="keyword">def </span>__init__(self):</div>
<div class="line">        self.overrides = {}</div>
<div class="line">thread_local_overrides = ThreadLocalOverrides()</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Settings:</div>
<div class="line">    _instance = <span class="keywordtype">None</span></div>
<div class="line">    <span class="keyword">def </span>__new__(cls): <span class="comment"># Singleton pattern</span></div>
<div class="line">        <span class="keywordflow">if</span> cls._instance <span class="keywordflow">is</span> <span class="keywordtype">None</span>: cls._instance = super().__new__(cls)</div>
<div class="line">        <span class="keywordflow">return</span> cls._instance</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># When you access settings.lm or settings[&#39;lm&#39;]</span></div>
<div class="line">    <span class="keyword">def </span>__getattr__(self, name):</div>
<div class="line">        <span class="comment"># Check thread-local overrides first</span></div>
<div class="line">        overrides = getattr(thread_local_overrides, <span class="stringliteral">&quot;overrides&quot;</span>, {})</div>
<div class="line">        <span class="keywordflow">if</span> name <span class="keywordflow">in</span> overrides: <span class="keywordflow">return</span> overrides[name]</div>
<div class="line">        <span class="comment"># Fall back to global config</span></div>
<div class="line">        <span class="keywordflow">elif</span> name <span class="keywordflow">in</span> main_thread_config: <span class="keywordflow">return</span> main_thread_config[name]</div>
<div class="line">        <span class="keywordflow">else</span>: <span class="keywordflow">raise</span> AttributeError(f<span class="stringliteral">&quot;&#39;Settings&#39; object has no attribute &#39;{name}&#39;&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>__getitem__(self, key): <span class="keywordflow">return</span> self.__getattr__(key)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># dspy.settings.configure(...)</span></div>
<div class="line">    <span class="keyword">def </span>configure(self, **kwargs):</div>
<div class="line">        <span class="keyword">global</span> main_thread_config, config_owner_thread_id</div>
<div class="line">        current_thread_id = threading.get_ident()</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">with</span> global_lock: <span class="comment"># Ensure thread safety for configuration</span></div>
<div class="line">            <span class="keywordflow">if</span> config_owner_thread_id <span class="keywordflow">is</span> <span class="keywordtype">None</span>: config_owner_thread_id = current_thread_id</div>
<div class="line">            <span class="keywordflow">elif</span> config_owner_thread_id != current_thread_id:</div>
<div class="line">                <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&quot;dspy.settings can only be changed by the thread that initially configured it.&quot;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Update global config</span></div>
<div class="line">        <span class="keywordflow">for</span> k, v <span class="keywordflow">in</span> kwargs.items(): main_thread_config[k] = v</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># with dspy.settings.context(...)</span></div>
<div class="line">    <span class="preprocessor">@contextmanager</span></div>
<div class="line">    <span class="keyword">def </span>context(self, **kwargs):</div>
<div class="line">        <span class="comment"># Save current overrides</span></div>
<div class="line">        original_overrides = getattr(thread_local_overrides, <span class="stringliteral">&quot;overrides&quot;</span>, {}).copy()</div>
<div class="line">        <span class="comment"># Create new overrides for this context (combining global + old local + new)</span></div>
<div class="line">        new_overrides = {**main_thread_config, **original_overrides, **kwargs}</div>
<div class="line">        <span class="comment"># Apply new overrides to thread-local storage</span></div>
<div class="line">        thread_local_overrides.overrides = new_overrides</div>
<div class="line">        <span class="keywordflow">try</span>:</div>
<div class="line">            <span class="keywordflow">yield</span> <span class="comment"># Code inside the &#39;with&#39; block runs here</span></div>
<div class="line">        <span class="keywordflow">finally</span>:</div>
<div class="line">            <span class="comment"># Restore original overrides when exiting the block</span></div>
<div class="line">            thread_local_overrides.overrides = original_overrides</div>
<div class="line"> </div>
<div class="line"><span class="comment"># The global instance you use</span></div>
<div class="line">settings = Settings()</div>
</div><!-- fragment --><p>This structure elegantly handles both global defaults and safe, temporary, thread-specific overrides.</p>
<h2><a class="anchor" id="autotoc_md1717"></a>
Conclusion</h2>
<p>Congratulations! You've reached the end of this introductory DSPy tutorial and learned about <code>dspy.settings</code>, the central control panel.</p>
<ul>
<li><code>dspy.settings</code> holds <b>global default configurations</b> like the <a class="el" href="../../d9/db7/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_205__lm____language__model__client__.html">LM</a>, <a class="el" href="../../d9/d67/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_206__rm____retrieval__model__client__.html">RM</a>, and <a class="el" href="../../d3/dc3/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_209__adapter.html">Adapter</a>.</li>
<li>You configure it <b>once</b> using <code>dspy.settings.configure(lm=..., rm=...)</code>.</li>
<li>DSPy modules like <code>dspy.Predict</code> and <code>dspy.Retrieve</code> automatically <b>use these defaults</b>, simplifying your code.</li>
<li><code>dspy.context</code> allows for <b>temporary, thread-local overrides</b>, providing flexibility without affecting the global state.</li>
</ul>
<p>By mastering these 10 chapters, you've gained a solid foundation in the core concepts of DSPy:</p>
<ol type="1">
<li>Structuring programs with <a class="el" href="../../d8/d9f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_201__module______program.html">Modules and Programs</a>.</li>
<li>Defining tasks with <a class="el" href="../../d4/dfe/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_202__signature.html">Signatures</a>.</li>
<li>Representing data with <a class="el" href="../../dc/db9/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_203__example.html">Examples</a>.</li>
<li>Making basic LM calls with <a class="el" href="../../d5/d3c/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_204__predict.html">Predict</a>.</li>
<li>Connecting to AI brains with <a class="el" href="../../d9/db7/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_205__lm____language__model__client__.html">LM Clients</a>.</li>
<li>Accessing external knowledge with <a class="el" href="../../d9/d67/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_206__rm____retrieval__model__client__.html">RM Clients</a>.</li>
<li>Measuring performance with <a class="el" href="../../d5/daa/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_207__evaluate.html">Evaluate</a>.</li>
<li>Automating optimization with <a class="el" href="../../dc/d0a/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_208__teleprompter______optimizer.html">Teleprompters</a>.</li>
<li>Ensuring compatibility with <a class="el" href="../../d3/dc3/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_209__adapter.html">Adapters</a>.</li>
<li>Managing configuration with <a class="el" href="../../d6/ddc/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2DSPy_210__settings.html">Settings</a>.</li>
</ol>
<p>You're now equipped to start building, evaluating, and optimizing your own sophisticated language model pipelines with DSPy. Happy programming!</p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
