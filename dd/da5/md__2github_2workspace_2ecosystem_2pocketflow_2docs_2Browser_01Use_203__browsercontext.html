#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 03_browsercontext</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dd/da5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Browser_01Use_203__browsercontext.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">03_browsercontext</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md884"></a>
autotoc_md884</h2>
<p>layout: default title: "BrowserContext" parent: "Browser Use" </p>
<h2><a class="anchor" id="autotoc_md885"></a>
nav_order: 3</h2>
<h1><a class="anchor" id="autotoc_md886"></a>
Chapter 3: BrowserContext - The Agent's Isolated Workspace</h1>
<p>In the <a class="el" href="../../dd/d81/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Browser_01Use_202__system__prompt.html">previous chapter</a>, we learned how the <code>System Prompt</code> acts as the rulebook for the AI assistant (LLM) that guides our <code>Agent</code>. We know the Agent uses the LLM to decide <em>what</em> to do next based on the current situation in the browser.</p>
<p>But <em>where</em> does the Agent actually "see" the webpage and perform its actions? How does it keep track of the current website address (URL), the page content, and things like cookies, all while staying focused on its specific task without getting mixed up with your other browsing?</p>
<p>This is where the <b>BrowserContext</b> comes in.</p>
<h2><a class="anchor" id="autotoc_md887"></a>
What Problem Does BrowserContext Solve?</h2>
<p>Imagine you ask your <code>Agent</code> to log into a specific online shopping website and check your order status. You might already be logged into that same website in your regular browser window with your personal account.</p>
<p>If the Agent just used your main browser window, it might:</p><ol type="1">
<li>Get confused by your existing login.</li>
<li>Accidentally use your personal cookies or saved passwords.</li>
<li>Interfere with other tabs you have open.</li>
</ol>
<p>We need a way to give the Agent its <em>own</em>, clean, separate browsing environment for each task. It needs an isolated "workspace" where it can open websites, log in, click buttons, and manage its own cookies without affecting anything else.</p>
<p>The <code>BrowserContext</code> solves this by representing a single, isolated browser session.</p>
<h2><a class="anchor" id="autotoc_md888"></a>
Meet the BrowserContext: Your Agent's Private Browser Window</h2>
<p>Think of a <code>BrowserContext</code> like opening a brand new <b>Incognito Window</b> or creating a <b>separate User Profile</b> in your web browser (like Chrome or Firefox).</p>
<ul>
<li><b>It's Isolated:</b> What happens in one <code>BrowserContext</code> doesn't affect others or your main browser session. It has its own cookies, its own history (for that session), and its own set of tabs.</li>
<li><b>It Manages State:</b> It keeps track of everything important about the current web session the Agent is working on:<ul>
<li>The current URL.</li>
<li>Which tabs are open within its "window".</li>
<li>Cookies specific to that session.</li>
<li>The structure and content of the current webpage (the DOM - Document Object Model, which we'll explore in the <a class="el" href="../../d0/df8/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Browser_01Use_204__dom__representation.html">next chapter</a>).</li>
</ul>
</li>
<li><b>It's the Agent's Viewport:</b> The <code>Agent</code> looks through the <code>BrowserContext</code> to "see" the current state of the webpage. When the Agent decides to perform an action (like clicking a button), it tells the <a class="el" href="../../de/dc1/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Browser_01Use_205__action__controller______registry.html">Action Controller</a> to perform it <em>within</em> that specific <code>BrowserContext</code>.</li>
</ul>
<p>Essentially, the <code>BrowserContext</code> is like a dedicated, clean desk or workspace given to the Agent for its specific job.</p>
<h2><a class="anchor" id="autotoc_md889"></a>
Using the BrowserContext</h2>
<p>Before we can have an isolated session (<code>BrowserContext</code>), we first need the main browser application itself. This is handled by the <code>Browser</code> class. Think of <code>Browser</code> as the entire Chrome or Firefox application installed on your computer, while <code>BrowserContext</code> is just one window or profile within that application.</p>
<p>Here's a simplified example of how you might set up a <code>Browser</code> and then create a <code>BrowserContext</code> to navigate to a page:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> asyncio</div>
<div class="line"><span class="comment"># Import necessary classes</span></div>
<div class="line"><span class="keyword">from</span> browser_use <span class="keyword">import</span> Browser, BrowserConfig, BrowserContext, BrowserContextConfig</div>
<div class="line"> </div>
<div class="line"><span class="keyword">async def </span><a class="code hl_namespace" href="../../d2/dc1/namespacemain.html">main</a>():</div>
<div class="line">    <span class="comment"># 1. Configure the main browser application (optional, defaults are usually fine)</span></div>
<div class="line">    browser_config = BrowserConfig(headless=<span class="keyword">False</span>) <span class="comment"># Show the browser window</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment"># 2. Create the main Browser instance</span></div>
<div class="line">    <span class="comment"># This might launch a browser application in the background (or connect to one)</span></div>
<div class="line">    browser = Browser(config=browser_config)</div>
<div class="line">    print(<span class="stringliteral">&quot;Browser application instance created.&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># 3. Configure the specific session/window (optional)</span></div>
<div class="line">    context_config = BrowserContextConfig(</div>
<div class="line">        user_agent=<span class="stringliteral">&quot;MyCoolAgent/1.0&quot;</span>, <span class="comment"># Example: Set a custom user agent</span></div>
<div class="line">        cookies_file=<span class="stringliteral">&quot;my_session_cookies.json&quot;</span> <span class="comment"># Example: Save/load cookies</span></div>
<div class="line">    )</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># 4. Create the isolated BrowserContext (like opening an incognito window)</span></div>
<div class="line">    <span class="comment"># We use &#39;async with&#39; to ensure it cleans up automatically afterwards</span></div>
<div class="line">    <span class="keyword">async</span> <span class="keyword">with</span> browser.new_context(config=context_config) <span class="keyword">as</span> browser_context:</div>
<div class="line">        print(f<span class="stringliteral">&quot;BrowserContext created (ID: {browser_context.context_id}).&quot;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 5. Use the context to interact with the browser session</span></div>
<div class="line">        start_url = <span class="stringliteral">&quot;https://example.com&quot;</span></div>
<div class="line">        print(f<span class="stringliteral">&quot;Navigating to: {start_url}&quot;</span>)</div>
<div class="line">        await browser_context.navigate_to(start_url)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 6. Get information *from* the context</span></div>
<div class="line">        current_state = await browser_context.get_state() <span class="comment"># Get current page info</span></div>
<div class="line">        print(f<span class="stringliteral">&quot;Current page title: {current_state.title}&quot;</span>)</div>
<div class="line">        print(f<span class="stringliteral">&quot;Current page URL: {current_state.url}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># The Agent would use this &#39;browser_context&#39; object to see the page</span></div>
<div class="line">        <span class="comment"># and tell the Controller to perform actions within it.</span></div>
<div class="line"> </div>
<div class="line">    print(<span class="stringliteral">&quot;BrowserContext closed automatically.&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># 7. Close the main browser application when done</span></div>
<div class="line">    await browser.close()</div>
<div class="line">    print(<span class="stringliteral">&quot;Browser application closed.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Run the asynchronous code</span></div>
<div class="line">asyncio.run(<a class="code hl_namespace" href="../../d2/dc1/namespacemain.html">main</a>())</div>
<div class="ttc" id="anamespacemain_html"><div class="ttname"><a href="../../d2/dc1/namespacemain.html">main</a></div><div class="ttdef"><b>Definition</b> <a href="../../dc/dba/main_8py_source.html#l00001">main.py:1</a></div></div>
</div><!-- fragment --><p><b>What happens here?</b></p>
<ol type="1">
<li>We set up a <code>BrowserConfig</code> (telling it <em>not</em> to run headless so we can see the window).</li>
<li>We create a <code>Browser</code> instance, which represents the overall browser program.</li>
<li>We create a <code>BrowserContextConfig</code> to specify settings for our isolated session (like a custom name or where to save cookies).</li>
<li>Crucially, <code>browser.new_context(...)</code> creates our isolated session. The <code>async with</code> block ensures this session is properly closed later.</li>
<li>We use methods <em>on the <code>browser_context</code> object</em> like <code>navigate_to()</code> to control <em>this specific session</em>.</li>
<li>We use <code>browser_context.get_state()</code> to get information about the current page within <em>this session</em>. The <code>Agent</code> heavily relies on this method.</li>
<li>After the <code>async with</code> block finishes, the <code>browser_context</code> is closed (like closing the incognito window), and finally, we close the main <code>browser</code> application.</li>
</ol>
<h2><a class="anchor" id="autotoc_md890"></a>
How it Works Under the Hood</h2>
<p>When the <code>Agent</code> needs to understand the current situation to decide the next step, it asks the <code>BrowserContext</code> for the latest state using the <code>get_state()</code> method. What happens then?</p>
<ol type="1">
<li><b>Wait for Stability:</b> The <code>BrowserContext</code> first waits for the webpage to finish loading and for network activity to settle down (<code>_wait_for_page_and_frames_load</code>). This prevents the Agent from acting on an incomplete page.</li>
<li><b>Analyze the Page:</b> It then uses the <a class="el" href="../../d0/df8/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Browser_01Use_204__dom__representation.html">DOM Representation</a> service (<code>DomService</code>) to analyze the current HTML structure of the page. This service figures out which elements are visible, interactive (buttons, links, input fields), and where they are.</li>
<li><b>Capture Visuals:</b> It often takes a screenshot of the current view (<code>take_screenshot</code>). This can be helpful for advanced agents or debugging.</li>
<li><b>Gather Metadata:</b> It gets the current URL, page title, and information about any other tabs open <em>within this context</em>.</li>
<li><b>Package the State:</b> All this information (DOM structure, URL, title, screenshot, etc.) is bundled into a <code>BrowserState</code> object.</li>
<li><b>Return to Agent:</b> The <code>BrowserContext</code> returns this <code>BrowserState</code> object to the <code>Agent</code>. The Agent then uses this information (often sending it to the LLM) to plan its next action.</li>
</ol>
<p>Here's a simplified diagram of the <code>get_state()</code> process:</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant Agent</div>
<div class="line">    participant BC as BrowserContext</div>
<div class="line">    participant PlaywrightPage as Underlying Browser Page</div>
<div class="line">    participant DomService as DOM Service</div>
<div class="line"> </div>
<div class="line">    Agent-&gt;&gt;BC: get_state()</div>
<div class="line">    Note over BC: Wait for page to be ready...</div>
<div class="line">    BC-&gt;&gt;PlaywrightPage: Ensure page/network is stable</div>
<div class="line">    PlaywrightPage--&gt;&gt;BC: Page is ready</div>
<div class="line">    Note over BC: Analyze the page content...</div>
<div class="line">    BC-&gt;&gt;DomService: Get simplified DOM structure + interactive elements</div>
<div class="line">    DomService--&gt;&gt;BC: DOMState (element tree, etc.)</div>
<div class="line">    Note over BC: Get visuals and metadata...</div>
<div class="line">    BC-&gt;&gt;PlaywrightPage: Take screenshot()</div>
<div class="line">    PlaywrightPage--&gt;&gt;BC: Screenshot data</div>
<div class="line">    BC-&gt;&gt;PlaywrightPage: Get URL, Title</div>
<div class="line">    PlaywrightPage--&gt;&gt;BC: URL, Title data</div>
<div class="line">    Note over BC: Combine everything...</div>
<div class="line">    BC-&gt;&gt;BC: Create BrowserState object</div>
<div class="line">    BC--&gt;&gt;Agent: Return BrowserState</div>
</div><!-- fragment --><p>Let's look at some simplified code snippets from the library.</p>
<p>The <code>BrowserContext</code> is initialized (<code>__init__</code> in <code>browser/context.py</code>) with its configuration and a reference to the main <code>Browser</code> instance that created it.</p>
<div class="fragment"><div class="line"><span class="comment"># --- File: browser/context.py (Simplified __init__) ---</span></div>
<div class="line"><span class="keyword">import</span> uuid</div>
<div class="line"><span class="comment"># ... other imports ...</span></div>
<div class="line"><span class="keywordflow">if</span> TYPE_CHECKING:</div>
<div class="line">    <span class="keyword">from</span> browser_use.browser.browser <span class="keyword">import</span> Browser <span class="comment"># Link to the Browser class</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">@dataclass</span></div>
<div class="line"><span class="keyword">class </span>BrowserContextConfig: <span class="comment"># Configuration settings</span></div>
<div class="line">    <span class="comment"># ... various settings like user_agent, cookies_file, window_size ...</span></div>
<div class="line">    <span class="keywordflow">pass</span></div>
<div class="line"> </div>
<div class="line">@dataclass</div>
<div class="line"><span class="keyword">class </span>BrowserSession: <span class="comment"># Holds the actual Playwright context</span></div>
<div class="line">    context: PlaywrightBrowserContext <span class="comment"># The underlying Playwright object</span></div>
<div class="line">    cached_state: Optional[BrowserState] = <span class="keywordtype">None</span> <span class="comment"># Stores the last known state</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>BrowserContext:</div>
<div class="line">    <span class="keyword">def </span>__init__(</div>
<div class="line">        self,</div>
<div class="line">        browser: <span class="stringliteral">&#39;Browser&#39;</span>, <span class="comment"># Reference to the main Browser instance</span></div>
<div class="line">        config: BrowserContextConfig = BrowserContextConfig(),</div>
<div class="line">        <span class="comment"># ... other optional state ...</span></div>
<div class="line">    ):</div>
<div class="line">        self.context_id = str(uuid.uuid4()) <span class="comment"># Unique ID for this session</span></div>
<div class="line">        self.config = config <span class="comment"># Store the configuration</span></div>
<div class="line">        self.browser = browser <span class="comment"># Store the reference to the parent Browser</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># The actual Playwright session is created later, when needed</span></div>
<div class="line">        self.session: BrowserSession | <span class="keywordtype">None</span> = <span class="keywordtype">None</span></div>
<div class="line">        logger.debug(f<span class="stringliteral">&quot;BrowserContext object created (ID: {self.context_id}). Session not yet initialized.&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># The &#39;async with&#39; statement calls __aenter__ which initializes the session</span></div>
<div class="line">    <span class="keyword">async def </span>__aenter__(self):</div>
<div class="line">        await self._initialize_session() <span class="comment"># Creates the actual browser window/tab</span></div>
<div class="line">        <span class="keywordflow">return</span> self</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>_initialize_session(self):</div>
<div class="line">        <span class="comment"># ... (complex setup code happens here) ...</span></div>
<div class="line">        <span class="comment"># Gets the main Playwright browser from self.browser</span></div>
<div class="line">        playwright_browser = await self.browser.get_playwright_browser()</div>
<div class="line">        <span class="comment"># Creates the isolated Playwright context (like the incognito window)</span></div>
<div class="line">        context = await self._create_context(playwright_browser)</div>
<div class="line">        <span class="comment"># Creates the BrowserSession to hold the context and state</span></div>
<div class="line">        self.session = BrowserSession(context=context, cached_state=<span class="keywordtype">None</span>)</div>
<div class="line">        logger.debug(f<span class="stringliteral">&quot;BrowserContext session initialized (ID: {self.context_id}).&quot;</span>)</div>
<div class="line">        <span class="comment"># ... (sets up the initial page) ...</span></div>
<div class="line">        <span class="keywordflow">return</span> self.session</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># ... other methods like navigate_to, close, etc. ...</span></div>
</div><!-- fragment --><p>The <code>get_state</code> method orchestrates fetching the current information from the browser session.</p>
<div class="fragment"><div class="line"><span class="comment"># --- File: browser/context.py (Simplified get_state and helpers) ---</span></div>
<div class="line"><span class="comment"># ... other imports ...</span></div>
<div class="line"><span class="keyword">from</span> browser_use.dom.service <span class="keyword">import</span> DomService <span class="comment"># Imports the DOM analyzer</span></div>
<div class="line"><span class="keyword">from</span> browser_use.browser.views <span class="keyword">import</span> BrowserState <span class="comment"># Imports the state structure</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>BrowserContext:</div>
<div class="line">    <span class="comment"># ... (init, aenter, etc.) ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>get_state(self) -&gt; BrowserState:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Get the current state of the browser session.&quot;&quot;&quot;</span></div>
<div class="line">        logger.debug(f<span class="stringliteral">&quot;Getting state for context {self.context_id}...&quot;</span>)</div>
<div class="line">        <span class="comment"># 1. Make sure the page is loaded and stable</span></div>
<div class="line">        await self._wait_for_page_and_frames_load()</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 2. Get the actual Playwright session object</span></div>
<div class="line">        session = await self.get_session()</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 3. Update the state (this does the heavy lifting)</span></div>
<div class="line">        session.cached_state = await self._update_state()</div>
<div class="line">        logger.debug(f<span class="stringliteral">&quot;State update complete for {self.context_id}.&quot;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 4. Optionally save cookies if configured</span></div>
<div class="line">        <span class="keywordflow">if</span> self.config.cookies_file:</div>
<div class="line">            asyncio.create_task(self.save_cookies())</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> session.cached_state</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>_wait_for_page_and_frames_load(self, timeout_overwrite: float | <span class="keywordtype">None</span> = <span class="keywordtype">None</span>):</div>
<div class="line">         <span class="stringliteral">&quot;&quot;&quot;Ensures page is fully loaded before continuing.&quot;&quot;&quot;</span></div>
<div class="line">         <span class="comment"># ... (complex logic to wait for network idle, minimum times) ...</span></div>
<div class="line">         page = await self.get_current_page()</div>
<div class="line">         await page.wait_for_load_state(<span class="stringliteral">&#39;load&#39;</span>, timeout=5000) <span class="comment"># Simplified wait</span></div>
<div class="line">         logger.debug(<span class="stringliteral">&quot;Page load/network stability checks passed.&quot;</span>)</div>
<div class="line">         await asyncio.sleep(self.config.minimum_wait_page_load_time) <span class="comment"># Ensure minimum wait</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>_update_state(self) -&gt; BrowserState:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Fetches all info and builds the BrowserState.&quot;&quot;&quot;</span></div>
<div class="line">        session = await self.get_session()</div>
<div class="line">        page = await self.get_current_page() <span class="comment"># Get the active Playwright page object</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">try</span>:</div>
<div class="line">            <span class="comment"># Use DomService to analyze the page content</span></div>
<div class="line">            dom_service = DomService(page)</div>
<div class="line">            <span class="comment"># Get the simplified DOM tree and interactive elements map</span></div>
<div class="line">            content_info = await dom_service.get_clickable_elements(</div>
<div class="line">                highlight_elements=self.config.highlight_elements,</div>
<div class="line">                <span class="comment"># ... other DOM options ...</span></div>
<div class="line">            )</div>
<div class="line"> </div>
<div class="line">            <span class="comment"># Take a screenshot</span></div>
<div class="line">            screenshot_b64 = await self.take_screenshot()</div>
<div class="line"> </div>
<div class="line">            <span class="comment"># Get URL, Title, Tabs, Scroll info etc.</span></div>
<div class="line">            url = page.url</div>
<div class="line">            title = await page.title()</div>
<div class="line">            tabs = await self.get_tabs_info()</div>
<div class="line">            pixels_above, pixels_below = await self.get_scroll_info(page)</div>
<div class="line"> </div>
<div class="line">            <span class="comment"># Create the BrowserState object</span></div>
<div class="line">            browser_state = BrowserState(</div>
<div class="line">                element_tree=content_info.element_tree,</div>
<div class="line">                selector_map=content_info.selector_map,</div>
<div class="line">                url=url,</div>
<div class="line">                title=title,</div>
<div class="line">                tabs=tabs,</div>
<div class="line">                screenshot=screenshot_b64,</div>
<div class="line">                pixels_above=pixels_above,</div>
<div class="line">                pixels_below=pixels_below,</div>
<div class="line">            )</div>
<div class="line">            <span class="keywordflow">return</span> browser_state</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line">            logger.error(f<span class="stringliteral">&#39;Failed to update state: {str(e)}&#39;</span>)</div>
<div class="line">            <span class="comment"># Maybe return old state or raise error</span></div>
<div class="line">            <span class="keywordflow">raise</span> BrowserError(<span class="stringliteral">&quot;Failed to get browser state&quot;</span>) <span class="keyword">from</span> e</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>take_screenshot(self, full_page: bool = <span class="keyword">False</span>) -&gt; str:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Takes a screenshot and returns base64 encoded string.&quot;&quot;&quot;</span></div>
<div class="line">        page = await self.get_current_page()</div>
<div class="line">        screenshot_bytes = await page.screenshot(full_page=full_page, animations=<span class="stringliteral">&#39;disabled&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span> base64.b64encode(screenshot_bytes).decode(<span class="stringliteral">&#39;utf-8&#39;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># ... many other helper methods (_get_current_page, get_tabs_info, etc.) ...</span></div>
</div><!-- fragment --><p> This shows how <code>BrowserContext</code> acts as a manager for a specific browser session, using underlying tools (like Playwright and <code>DomService</code>) to gather the necessary information (<code>BrowserState</code>) that the <code>Agent</code> needs to operate.</p>
<h2><a class="anchor" id="autotoc_md891"></a>
Conclusion</h2>
<p>The <code>BrowserContext</code> is a fundamental concept in <code>Browser Use</code>. It provides the necessary <b>isolated environment</b> for the <code>Agent</code> to perform its tasks, much like an incognito window or a separate browser profile. It manages the session's state (URL, cookies, tabs, page content) and provides the <code>Agent</code> with a snapshot of the current situation via the <code>get_state()</code> method.</p>
<p>Understanding the <code>BrowserContext</code> helps clarify <em>where</em> the Agent works. Now, how does the Agent actually understand the <em>content</em> of the webpage within that context? How is the complex structure of a webpage represented in a way the Agent (and the LLM) can understand?</p>
<p>In the next chapter, we'll dive into exactly that: the <a class="el" href="../../d0/df8/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Browser_01Use_204__dom__representation.html">DOM Representation</a>.</p>
<p><a class="el" href="../../d0/df8/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Browser_01Use_204__dom__representation.html">Next Chapter: DOM Representation</a></p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
