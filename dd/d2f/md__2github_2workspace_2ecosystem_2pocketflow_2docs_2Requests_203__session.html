#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 03_session</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dd/d2f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_203__session.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">03_session</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md2905"></a>
autotoc_md2905</h2>
<p>layout: default title: "Session" parent: "Requests" </p>
<h2><a class="anchor" id="autotoc_md2906"></a>
nav_order: 3</h2>
<h1><a class="anchor" id="autotoc_md2907"></a>
Chapter 3: Remembering Things - The Session Object</h1>
<p>In <a class="el" href="../../d8/da9/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_201__functional__api.html">Chapter 1</a>, we learned the easiest way to make web requests using functions like <code>requests.get()</code>. In <a class="el" href="../../dd/d7e/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_202__request______response__models.html">Chapter 2</a>, we looked at the <code>Request</code> and <code>Response</code> objects that structure our communication with web servers.</p>
<p>We also saw that the simple functional API methods like <code>requests.get()</code> are great for single, one-off requests. But what if you need to talk to the <em>same website</em> multiple times? For example, maybe you need to:</p>
<ol type="1">
<li>Log in to a website (which gives you a "session cookie" to prove you're logged in).</li>
<li>Make several requests to access different pages that <em>require</em> you to be logged in (using that cookie).</li>
</ol>
<p>If you use <code>requests.get()</code> for each step, you'll have a problem. Remember how <code>requests.get()</code> creates a <em>temporary</em> setup for each call and then throws it away? This means it forgets the login cookie immediately after the login request! Your next request will be like visiting the site as a brand new, logged-out user.</p>
<p>How can we make <code>Requests</code> remember things between requests, just like your web browser does when you navigate around a logged-in site?</p>
<h2><a class="anchor" id="autotoc_md2908"></a>
Meet the <code>Session</code> Object: Your Persistent Browser Tab</h2>
<p>This is where the <code>requests.Session</code> object comes in!</p>
<p>Think of a <code>Session</code> object as a dedicated browser tab you've opened just for interacting with a specific website or web service. What does a browser tab do?</p>
<ul>
<li><b>Remembers Cookies:</b> If you log in on a website in one tab, that tab remembers your login cookie. When you click a link <em>within that same tab</em>, the browser automatically sends the cookie back, keeping you logged in.</li>
<li><b>Keeps Connections Warm:</b> Your browser often keeps the underlying network connection (TCP connection) to the website open for a little while. This makes clicking links and loading subsequent pages much faster because it doesn't have to establish a new connection every single time. This is called <b>connection pooling</b>.</li>
<li><b>Applies Consistent Settings:</b> You might have browser extensions that add specific headers to your requests, or your browser sends a consistent "User-Agent" string identifying itself.</li>
</ul>
<p>A <code>requests.Session</code> object does all of these things for your Python script:</p>
<ol type="1">
<li><b>Cookie Persistence:</b> It automatically stores cookies sent by the server and sends them back on subsequent requests to the same domain.</li>
<li><b>Connection Pooling:</b> It reuses the underlying TCP connections for requests to the same host, significantly speeding up multiple requests. This is managed by components called <a class="el" href="../../d5/d83/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_207__transport__adapters.html">Transport Adapters</a>.</li>
<li><b>Default Data:</b> You can set default headers, authentication details, query parameters, or proxy settings directly on the <code>Session</code> object, and they will be applied to all requests made through that session.</li>
</ol>
<h2><a class="anchor" id="autotoc_md2909"></a>
Using a <code>Session</code></h2>
<p>Using a <code>Session</code> is almost as easy as using the functional API. Instead of calling <code>requests.get()</code>, you first create a <code>Session</code> object, and then call methods like <code><a class="el" href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get()</a></code> or <code>post()</code> on <em>that object</em>.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> requests</div>
<div class="line"> </div>
<div class="line"><span class="comment"># 1. Create a Session object</span></div>
<div class="line">s = requests.Session()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Let&#39;s try accessing a page that requires a login (we&#39;re not logged in yet)</span></div>
<div class="line">login_required_url = <span class="stringliteral">&#39;https://httpbin.org/cookies&#39;</span> <span class="comment"># This page shows cookies sent to it</span></div>
<div class="line">print(<span class="stringliteral">&quot;Trying to access protected page without login...&quot;</span>)</div>
<div class="line">response1 = s.get(login_required_url)</div>
<div class="line">print(<span class="stringliteral">&quot;Cookies sent (should be none):&quot;</span>, response1.json()) <span class="comment"># httpbin returns JSON</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Now, let&#39;s simulate &#39;logging in&#39; by visiting a page that sets a cookie</span></div>
<div class="line">cookie_setter_url = <span class="stringliteral">&#39;https://httpbin.org/cookies/set/sessioncookie/123456789&#39;</span></div>
<div class="line">print(<span class="stringliteral">&quot;\nSimulating login by getting a cookie...&quot;</span>)</div>
<div class="line">response2 = s.get(cookie_setter_url)</div>
<div class="line"><span class="comment"># The session automatically stored the cookie! Check the session&#39;s cookie jar:</span></div>
<div class="line">print(<span class="stringliteral">&quot;Session cookies after setting:&quot;</span>, s.cookies.get_dict())</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Now, try accessing the &#39;protected&#39; page again using the SAME session</span></div>
<div class="line">print(<span class="stringliteral">&quot;\nTrying to access protected page AGAIN with the session...&quot;</span>)</div>
<div class="line">response3 = s.get(login_required_url)</div>
<div class="line">print(<span class="stringliteral">&quot;Cookies sent (should have sessioncookie):&quot;</span>, response3.json())</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Compare with using the functional API (which forgets cookies)</span></div>
<div class="line">print(<span class="stringliteral">&quot;\nTrying the same with functional API (will fail)...&quot;</span>)</div>
<div class="line">response4 = requests.get(cookie_setter_url) <span class="comment"># Gets cookie, but immediately forgets</span></div>
<div class="line">response5 = requests.get(login_required_url)</div>
<div class="line">print(<span class="stringliteral">&quot;Cookies sent via functional API (should be none):&quot;</span>, response5.json())</div>
</div><!-- fragment --><p><b>What happened here?</b></p>
<ol type="1">
<li><code>s = requests.Session()</code>: We created our "persistent browser tab".</li>
<li><code>response1 = s.get(login_required_url)</code>: Our first request sent no cookies, as expected.</li>
<li><code>response2 = s.get(cookie_setter_url)</code>: We visited a URL designed to send back a <code>Set-Cookie</code> header. The <code>Session</code> object automatically noticed this and stored the <code>sessioncookie</code> in its internal <a class="el" href="../../d1/df9/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_204__cookie__jar.html">Cookie Jar</a>.</li>
<li><code>s.cookies.get_dict()</code>: We peeked inside the session's cookie storage and saw the cookie was indeed saved.</li>
<li><code>response3 = s.get(login_required_url)</code>: We made <em>another</em> request using the <em>same</em> session <code>s</code>. This time, the session automatically included the <code>sessioncookie</code> in the request headers. The server received it!</li>
<li>The last part shows that if we used <code>requests.get()</code> instead, the cookie from <code>response4</code> would be lost, and <code>response5</code> would fail to send it. The <code>Session</code> was crucial for remembering the cookie.</li>
</ol>
<h2><a class="anchor" id="autotoc_md2910"></a>
Persistent Settings: Headers, Auth, etc.</h2>
<p>Besides cookies, you can set other things on the <code>Session</code> that will apply to all its requests.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> requests</div>
<div class="line"><span class="keyword">import</span> os <span class="comment"># To get environment variables for auth example</span></div>
<div class="line"> </div>
<div class="line">s = requests.Session()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Set a default header for all requests made by this session</span></div>
<div class="line">s.headers.update({<span class="stringliteral">&#39;X-My-Custom-Header&#39;</span>: <span class="stringliteral">&#39;HelloSession&#39;</span>})</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Set default authentication (using basic auth from environment variables for example)</span></div>
<div class="line"><span class="comment"># NOTE: Replace with actual username/password or use httpbin&#39;s basic-auth endpoint</span></div>
<div class="line"><span class="comment"># For httpbin, the user/pass is &#39;user&#39;/&#39;pass&#39;</span></div>
<div class="line"><span class="comment"># s.auth = (&#39;user&#39;, &#39;passwd&#39;) # Set directly if needed</span></div>
<div class="line">httpbin_user = os.environ.get(<span class="stringliteral">&quot;HTTPBIN_USER&quot;</span>, <span class="stringliteral">&quot;testuser&quot;</span>) <span class="comment"># Fake user if not set</span></div>
<div class="line">httpbin_pass = os.environ.get(<span class="stringliteral">&quot;HTTPBIN_PASS&quot;</span>, <span class="stringliteral">&quot;testpass&quot;</span>) <span class="comment"># Fake pass if not set</span></div>
<div class="line">s.auth = (httpbin_user, httpbin_pass)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Set default query parameters</span></div>
<div class="line">s.params.update({<span class="stringliteral">&#39;session_param&#39;</span>: <span class="stringliteral">&#39;persistent&#39;</span>})</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Now make a request</span></div>
<div class="line">url = <span class="stringliteral">&#39;https://httpbin.org/get&#39;</span> <span class="comment"># Changed endpoint to see params</span></div>
<div class="line">print(f<span class="stringliteral">&quot;Making request with persistent session settings to: {url}&quot;</span>)</div>
<div class="line">response = s.get(url)</div>
<div class="line"> </div>
<div class="line">print(f<span class="stringliteral">&quot;\nStatus Code: {response.status_code}&quot;</span>)</div>
<div class="line"><span class="comment"># Check the response (httpbin.org/get echoes back request details)</span></div>
<div class="line">response_data = response.json()</div>
<div class="line">print(<span class="stringliteral">&quot;\nHeaders sent (look for X-My-Custom-Header):&quot;</span>)</div>
<div class="line">print(response_data[<span class="stringliteral">&#39;headers&#39;</span>])</div>
<div class="line"><span class="comment"># print(&quot;\nAuth info sent (if using httpbin basic-auth):&quot;)</span></div>
<div class="line"><span class="comment"># print(response_data.get(&#39;authenticated&#39;), response_data.get(&#39;user&#39;)) # Won&#39;t show here for /get</span></div>
<div class="line">print(<span class="stringliteral">&quot;\nQuery parameters sent (look for session_param):&quot;</span>)</div>
<div class="line">print(response_data[<span class="stringliteral">&#39;args&#39;</span>])</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Make another request to a different endpoint using the same session</span></div>
<div class="line">headers_url = <span class="stringliteral">&#39;https://httpbin.org/headers&#39;</span></div>
<div class="line">print(f<span class="stringliteral">&quot;\nMaking request to {headers_url}...&quot;</span>)</div>
<div class="line">response_headers = s.get(headers_url)</div>
<div class="line">print(<span class="stringliteral">&quot;Headers received by second request (still has custom header):&quot;</span>)</div>
<div class="line">print(response_headers.json()[<span class="stringliteral">&#39;headers&#39;</span>])</div>
</div><!-- fragment --><p><b>What we see:</b></p>
<ul>
<li>The <code>X-My-Custom-Header</code> we set on <code>s.headers</code> was automatically added to both requests.</li>
<li>The <code>session_param</code> we added to <code>s.params</code> was included in the query string of the first request.</li>
<li>If we had used a real authentication endpoint, the <code>s.auth</code> details would have been used automatically.</li>
<li>We didn't have to specify these details on each <code>s.get()</code> call! The <code>Session</code> handled it.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2911"></a>
Using Sessions with <code>with</code> (Context Manager)</h2>
<p>Sessions manage resources like network connections. It's good practice to explicitly close them when you're done. The easiest way to ensure this happens is to use the <code>Session</code> as a context manager with the <code>with</code> statement.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> requests</div>
<div class="line"> </div>
<div class="line">url = <span class="stringliteral">&#39;https://httpbin.org/cookies&#39;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Use the Session as a context manager</span></div>
<div class="line"><span class="keyword">with</span> requests.Session() <span class="keyword">as</span> s:</div>
<div class="line">    s.get(<span class="stringliteral">&#39;https://httpbin.org/cookies/set/contextcookie/abc&#39;</span>)</div>
<div class="line">    response = s.get(url)</div>
<div class="line">    print(<span class="stringliteral">&quot;Cookies sent within &#39;with&#39; block:&quot;</span>, response.json())</div>
<div class="line"> </div>
<div class="line"><span class="comment"># After the &#39;with&#39; block, the session &#39;s&#39; is automatically closed.</span></div>
<div class="line"><span class="comment"># Making a request now might fail or use a new connection pool if s was reused (not recommended)</span></div>
<div class="line"><span class="comment"># print(&quot;\nTrying to use session after &#39;with&#39; block (might not work as expected)...&quot;)</span></div>
<div class="line"><span class="comment"># try:</span></div>
<div class="line"><span class="comment">#    response_after = s.get(url)</span></div>
<div class="line"><span class="comment">#    print(response_after.text)</span></div>
<div class="line"><span class="comment"># except Exception as e:</span></div>
<div class="line"><span class="comment">#    print(f&quot;Error using session after close: {e}&quot;)</span></div>
<div class="line"> </div>
<div class="line">print(<span class="stringliteral">&quot;\nSession automatically closed after &#39;with&#39; block.&quot;</span>)</div>
</div><!-- fragment --><p>The <code>with</code> statement ensures that <code>s.close()</code> is called automatically at the end of the block, even if errors occur. This cleans up the underlying connections managed by the <a class="el" href="../../d5/d83/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_207__transport__adapters.html">Transport Adapters</a>.</p>
<h2><a class="anchor" id="autotoc_md2912"></a>
How It Works Internally</h2>
<p>So, how does the <code>Session</code> actually achieve this persistence and efficiency?</p>
<ol type="1">
<li><b>State Storage:</b> The <code>Session</code> object itself holds onto configuration like <code>headers</code>, <code>cookies</code> (in a <a class="el" href="../../d1/df9/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_204__cookie__jar.html">Cookie Jar</a>), <code>auth</code>, <code>params</code>, etc.</li>
<li><b>Request Preparation:</b> When you call a method like <code>s.get(url, headers=...)</code>, the <code>Session</code> takes your request details <em>and</em> its own stored settings and merges them together. It uses these merged settings to create the <code>PreparedRequest</code> object we saw in <a class="el" href="../../dd/d7e/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_202__request______response__models.html">Chapter 2</a>. Session cookies and headers get added automatically during this step (<code>Session.prepare_request</code>).</li>
<li><b>Transport Adapters &amp; Pooling:</b> The <code>Session</code> doesn't directly handle network sockets. It delegates the sending of the <code>PreparedRequest</code> to a suitable <b>Transport Adapter</b> (usually <code>HTTPAdapter</code> for HTTP/HTTPS). Each <code>Session</code> typically keeps instances of these adapters. The <em>adapter</em> is responsible for managing the pool of underlying network connections (<code>urllib3</code>'s connection pool). When you make a request to <code><a href="https://example.com">https://example.com</a></code>, the adapter checks if it already has an open, reusable connection to that host in its pool. If yes, it uses it (much faster!). If not, it creates a new one and potentially adds it to the pool for future reuse.</li>
<li><b>Response Processing:</b> When the adapter receives the response, it builds the <code>Response</code> object. The <code>Session</code> then gets the <code>Response</code> back from the adapter. Crucially, it inspects the response headers (like <code>Set-Cookie</code>) and updates its own state (e.g., adds new cookies to its <code>Cookie Jar</code>).</li>
</ol>
<p>Here's a simplified diagram showing two requests using a <code>Session</code>:</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant User as Your Code</div>
<div class="line">    participant Sess as Session Object</div>
<div class="line">    participant PrepReq as PreparedRequest</div>
<div class="line">    participant Adapter as Transport Adapter (holds connection pool)</div>
<div class="line">    participant Server as Web Server</div>
<div class="line"> </div>
<div class="line">    User-&gt;&gt;Sess: Create Session()</div>
<div class="line">    User-&gt;&gt;Sess: s.get(url1, headers={&#39;User-Header&#39;: &#39;A&#39;})</div>
<div class="line">    Sess-&gt;&gt;Sess: Merge s.headers, s.cookies, s.auth... with User&#39;s headers/data</div>
<div class="line">    Sess-&gt;&gt;PrepReq: prepare_request(merged_settings)</div>
<div class="line">    Sess-&gt;&gt;Adapter: send(prepared_request)</div>
<div class="line">    Adapter-&gt;&gt;Adapter: Get connection from pool (or create new)</div>
<div class="line">    Adapter-&gt;&gt;Server: Send HTTP Request 1 (with session+user headers, session cookies)</div>
<div class="line">    Server--&gt;&gt;Adapter: Send HTTP Response 1 (sets cookie &#39;C&#39;)</div>
<div class="line">    Adapter-&gt;&gt;Sess: Return Response 1</div>
<div class="line">    Sess-&gt;&gt;Sess: Extract cookie &#39;C&#39; into s.cookies</div>
<div class="line">    Sess--&gt;&gt;User: Return Response 1</div>
<div class="line"> </div>
<div class="line">    User-&gt;&gt;Sess: s.get(url2)</div>
<div class="line">    Sess-&gt;&gt;Sess: Merge s.headers, s.cookies (&#39;C&#39;), s.auth...</div>
<div class="line">    Sess-&gt;&gt;PrepReq: prepare_request(merged_settings)</div>
<div class="line">    Sess-&gt;&gt;Adapter: send(prepared_request)</div>
<div class="line">    Adapter-&gt;&gt;Adapter: Get REUSED connection from pool</div>
<div class="line">    Adapter-&gt;&gt;Server: Send HTTP Request 2 (with session headers, cookie &#39;C&#39;)</div>
<div class="line">    Server--&gt;&gt;Adapter: Send HTTP Response 2</div>
<div class="line">    Adapter-&gt;&gt;Sess: Return Response 2</div>
<div class="line">    Sess--&gt;&gt;User: Return Response 2</div>
</div><!-- fragment --><p>You can see the core logic in <code>requests/sessions.py</code>. The <code>Session.request</code> method orchestrates the process:</p>
<div class="fragment"><div class="line"><span class="comment"># File: requests/sessions.py (Simplified View)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># [...] imports and helper functions</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Session(SessionRedirectMixin):</div>
<div class="line">    <span class="keyword">def </span>__init__(self):</div>
<div class="line">        <span class="comment"># Stores persistent headers, cookies, auth, etc.</span></div>
<div class="line">        self.headers = default_headers()</div>
<div class="line">        self.cookies = cookiejar_from_dict({})</div>
<div class="line">        self.auth = <span class="keywordtype">None</span></div>
<div class="line">        self.params = {}</div>
<div class="line">        <span class="comment"># [...] other defaults like verify, proxies, max_redirects</span></div>
<div class="line">        self.adapters = OrderedDict() <span class="comment"># Holds Transport Adapters</span></div>
<div class="line">        self.mount(<span class="stringliteral">&#39;https://&#39;</span>, HTTPAdapter()) <span class="comment"># Default adapter for HTTPS</span></div>
<div class="line">        self.mount(<span class="stringliteral">&#39;http://&#39;</span>, HTTPAdapter())  <span class="comment"># Default adapter for HTTP</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>prepare_request(self, request):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Prepares a Request object with Session settings.&quot;&quot;&quot;</span></div>
<div class="line">        p = PreparedRequest()</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># MERGE session settings with request settings</span></div>
<div class="line">        merged_cookies = merge_cookies(RequestsCookieJar(), self.cookies)</div>
<div class="line">        <span class="keywordflow">if</span> request.cookies:</div>
<div class="line">            merged_cookies = merge_cookies(merged_cookies, cookiejar_from_dict(request.cookies))</div>
<div class="line"> </div>
<div class="line">        merged_headers = merge_setting(request.headers, self.headers, dict_class=CaseInsensitiveDict)</div>
<div class="line">        merged_params = merge_setting(request.params, self.params)</div>
<div class="line">        merged_auth = merge_setting(request.auth, self.auth)</div>
<div class="line">        <span class="comment"># [...] merge other settings like hooks</span></div>
<div class="line"> </div>
<div class="line">        p.prepare(</div>
<div class="line">            method=request.method.upper(),</div>
<div class="line">            url=request.url,</div>
<div class="line">            headers=merged_headers,</div>
<div class="line">            files=request.files,</div>
<div class="line">            data=request.data,</div>
<div class="line">            json=request.json,</div>
<div class="line">            params=merged_params,</div>
<div class="line">            auth=merged_auth,</div>
<div class="line">            cookies=merged_cookies, <span class="comment"># Pass merged cookies to PreparedRequest</span></div>
<div class="line">            hooks=merge_hooks(request.hooks, self.hooks),</div>
<div class="line">        )</div>
<div class="line">        <span class="keywordflow">return</span> p</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>request(self, method, url, **kwargs):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Constructs a Request, prepares it, sends it.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># Create the initial Request object from user args</span></div>
<div class="line">        req = Request(method=method.upper(), url=url, **kwargs) <span class="comment"># Simplified</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Prepare the request, merging session state</span></div>
<div class="line">        prep = self.prepare_request(req)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Get environment settings (proxies, verify, cert) merged with session settings</span></div>
<div class="line">        proxies = kwargs.get(<span class="stringliteral">&#39;proxies&#39;</span>) <span class="keywordflow">or</span> {}</div>
<div class="line">        settings = self.merge_environment_settings(prep.url, proxies,</div>
<div class="line">                                                  kwargs.get(<span class="stringliteral">&#39;stream&#39;</span>),</div>
<div class="line">                                                  kwargs.get(<span class="stringliteral">&#39;verify&#39;</span>),</div>
<div class="line">                                                  kwargs.get(<span class="stringliteral">&#39;cert&#39;</span>))</div>
<div class="line">        send_kwargs = {<span class="stringliteral">&#39;timeout&#39;</span>: kwargs.get(<span class="stringliteral">&#39;timeout&#39;</span>),</div>
<div class="line">                       <span class="stringliteral">&#39;allow_redirects&#39;</span>: kwargs.get(<span class="stringliteral">&#39;allow_redirects&#39;</span>, <span class="keyword">True</span>)}</div>
<div class="line">        send_kwargs.update(settings)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Send the prepared request using the appropriate adapter</span></div>
<div class="line">        resp = self.send(prep, **send_kwargs)</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> resp</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>send(self, request, **kwargs):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Sends a PreparedRequest object.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># [...] set default kwargs if needed</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Get the right adapter (e.g., HTTPAdapter) based on URL</span></div>
<div class="line">        adapter = self.get_adapter(url=request.url)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># The adapter sends the request (using connection pooling)</span></div>
<div class="line">        r = adapter.send(request, **kwargs)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># [...] response hook processing</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># IMPORTANT: Extract cookies from the response and store them in the session&#39;s cookie jar</span></div>
<div class="line">        extract_cookies_to_jar(self.cookies, request, r.raw)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># [...] redirect handling (which also extracts cookies)</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> r</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>get_adapter(self, url):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Finds the Transport Adapter for the URL (e.g., HTTPAdapter).&quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># ... loops through self.adapters ...</span></div>
<div class="line">        <span class="comment"># Simplified: return self.adapters[&#39;http://&#39;] or self.adapters[&#39;https://&#39;]</span></div>
<div class="line">        <span class="keywordflow">for</span> prefix, adapter <span class="keywordflow">in</span> self.adapters.items():</div>
<div class="line">            <span class="keywordflow">if</span> url.lower().startswith(prefix.lower()):</div>
<div class="line">                <span class="keywordflow">return</span> adapter</div>
<div class="line">        <span class="keywordflow">raise</span> InvalidSchema(f<span class="stringliteral">&quot;No connection adapters were found for {url!r}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>mount(self, prefix, adapter):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Attaches a Transport Adapter to handle URLs starting with &#39;prefix&#39;.&quot;&quot;&quot;</span></div>
<div class="line">        self.adapters[prefix] = adapter</div>
<div class="line">        <span class="comment"># [...] sort adapters by prefix length</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>close(self):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Closes the session and all its adapters (and connections).&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">for</span> adapter <span class="keywordflow">in</span> self.adapters.values():</div>
<div class="line">            adapter.close()</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># [...] other methods like get(), post(), put(), delete() which call self.request()</span></div>
<div class="line">    <span class="comment"># [...] redirect handling logic in SessionRedirectMixin</span></div>
</div><!-- fragment --><p>The key takeaways are:</p><ul>
<li>The <code>Session</code> object holds the state (<code>headers</code>, <code>cookies</code>, <code>auth</code>).</li>
<li><code>prepare_request</code> merges this state with the details of the specific request you're making.</li>
<li><code>send</code> uses a <code>Transport Adapter</code> (like <code>HTTPAdapter</code>) which handles the actual network communication and connection pooling.</li>
<li>After a response is received, <code>send</code> (and the redirection logic) updates the <code>Session</code>'s cookies.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2913"></a>
Conclusion</h2>
<p>You've learned about the <code>requests.Session</code> object, a powerful tool for making multiple requests to the same host efficiently. You saw how it automatically handles <b>cookie persistence</b> and provides significant performance benefits through <b>connection pooling</b> (via <a class="el" href="../../d5/d83/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_207__transport__adapters.html">Transport Adapters</a>). You also learned how to set persistent <code>headers</code>, <code>auth</code>, and other settings on a session. Using a <code>Session</code> is the recommended approach when your script needs to interact with a website more than once.</p>
<p>We mentioned that the <code>Session</code> stores cookies in a "Cookie Jar". What exactly is that, and can we interact with it more directly? Let's find out.</p>
<p><b>Next:</b> <a class="el" href="../../d1/df9/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_204__cookie__jar.html">Chapter 4: The Cookie Jar</a></p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
