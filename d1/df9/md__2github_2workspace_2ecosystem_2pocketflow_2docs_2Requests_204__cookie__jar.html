#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 04_cookie_jar</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d1/df9/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_204__cookie__jar.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">04_cookie_jar</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md2915"></a>
autotoc_md2915</h2>
<p>layout: default title: "Cookie Jar" parent: "Requests" </p>
<h2><a class="anchor" id="autotoc_md2916"></a>
nav_order: 4</h2>
<h1><a class="anchor" id="autotoc_md2917"></a>
Chapter 4: The Cookie Jar - Remembering Website Visits</h1>
<p>In <a class="el" href="../../dd/d2f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_203__session.html">Chapter 3: Remembering Things - The Session Object</a>, we saw how <code>Session</code> objects are super useful for making multiple requests to the same website. A big reason they work so well is that they automatically remember <b>cookies</b> sent by the server, just like your web browser does.</p>
<p>But <em>how</em> does a <code>Session</code> remember these cookies? Where does it keep them? Welcome to the <b>Cookie Jar</b>!</p>
<h2><a class="anchor" id="autotoc_md2918"></a>
What's the Problem? Staying Logged In</h2>
<p>Imagine you log in to a website. The website usually sends back a special piece of information called a <b>cookie</b>. This cookie is like a temporary ID card. When you visit other pages on that <em>same</em> website, your browser automatically shows this ID card (sends the cookie back) so the website knows you're still logged in.</p>
<p>If you used the simple <code>requests.get()</code> function from <a class="el" href="../../d8/da9/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_201__functional__api.html">Chapter 1</a> for each step, it would forget the ID card immediately after logging in. Your next request would be treated as if you were a stranger.</p>
<p><code>Session</code> objects solve this by using a <b>Cookie Jar</b> to hold onto those ID cards (cookies) for you.</p>
<h2><a class="anchor" id="autotoc_md2919"></a>
What are Cookies (Briefly)?</h2>
<p>Think of cookies as little notes or name tags that websites give to your browser (or your <code>requests</code> script).</p>
<ul>
<li><b>Website:</b> "Hi, you just logged in. Here's a name tag that says 'User123'." (Sends a <code>Set-Cookie</code> header)</li>
<li><b>Your Browser / Session:</b> "Okay, I'll keep this 'User123' tag." (Stores the cookie)</li>
<li><b>You:</b> (Click on another page on the same website)</li>
<li><b>Your Browser / Session:</b> "Hi website, I'd like this page. By the way, here's my name tag: 'User123'." (Sends a <code>Cookie</code> header)</li>
<li><b>Website:</b> "Ah, User123, I remember you. Here's the page you asked for."</li>
</ul>
<p>Cookies are used to remember login status, user preferences, items in a shopping cart, etc., between different page visits.</p>
<h2><a class="anchor" id="autotoc_md2920"></a>
The Cookie Jar Analogy üç™</h2>
<p><code>Requests</code> uses an object called a <code>RequestsCookieJar</code> to store and manage cookies. It's very much like the cookie jar you might have in your kitchen:</p>
<ol type="1">
<li><b>Collects Cookies:</b> When a website sends you a cookie (like after you log in), the <code>Session</code> automatically puts it into its <code>Cookie Jar</code>.</li>
<li><b>Stores Them Safely:</b> The jar keeps all the cookies collected from different websites (domains).</li>
<li><b>Sends the Right Ones Back:</b> When you make <em>another</em> request to a website using the <em>same</em> <code>Session</code>, the <code>Session</code> looks into the <code>Cookie Jar</code>, finds any cookies that belong to that website's domain, and automatically sends them back.</li>
</ol>
<p>This happens seamlessly when you use a <code>Session</code> object.</p>
<h2><a class="anchor" id="autotoc_md2921"></a>
Meet <code>RequestsCookieJar</code></h2>
<p>The specific object <code>requests</code> uses is <code>requests.cookies.RequestsCookieJar</code>. It's designed to work just like Python's standard <code>http.cookiejar.CookieJar</code> but adds some convenient features, like acting like a dictionary.</p>
<p>Every <code>Session</code> object has its own <code>Cookie Jar</code> accessible via the <code>s.cookies</code> attribute.</p>
<p>Let's see it in action, revisiting the example from Chapter 3:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> requests</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create a Session object (which has its own empty Cookie Jar)</span></div>
<div class="line">s = requests.Session()</div>
<div class="line">print(f<span class="stringliteral">&quot;Initial session cookies: {s.cookies.get_dict()}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Visit a page that sets a cookie</span></div>
<div class="line">cookie_setter_url = <span class="stringliteral">&#39;https://httpbin.org/cookies/set/fruit/apple&#39;</span></div>
<div class="line">print(f<span class="stringliteral">&quot;\nVisiting {cookie_setter_url}...&quot;</span>)</div>
<div class="line">response1 = s.get(cookie_setter_url)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Check the Session&#39;s Cookie Jar - it should have the cookie now!</span></div>
<div class="line">print(f<span class="stringliteral">&quot;Session cookies after setting: {s.cookies.get_dict()}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Visit another page on the same domain (httpbin.org)</span></div>
<div class="line">cookie_viewer_url = <span class="stringliteral">&#39;https://httpbin.org/cookies&#39;</span></div>
<div class="line">print(f<span class="stringliteral">&quot;\nVisiting {cookie_viewer_url}...&quot;</span>)</div>
<div class="line">response2 = s.get(cookie_viewer_url)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># This page shows the cookies it received. Let&#39;s see if our &#39;fruit&#39; cookie was sent.</span></div>
<div class="line">print(<span class="stringliteral">&quot;Cookies received by the server:&quot;</span>)</div>
<div class="line">print(response2.text) <span class="comment"># httpbin.org/cookies returns JSON showing received cookies</span></div>
</div><!-- fragment --><p><b>Output:</b></p>
<div class="fragment"><div class="line">Initial session cookies: {}</div>
<div class="line"> </div>
<div class="line">Visiting https://httpbin.org/cookies/set/fruit/apple...</div>
<div class="line">Session cookies after setting: {&#39;fruit&#39;: &#39;apple&#39;}</div>
<div class="line"> </div>
<div class="line">Visiting https://httpbin.org/cookies...</div>
<div class="line">Cookies received by the server:</div>
<div class="line">{</div>
<div class="line">  &quot;cookies&quot;: {</div>
<div class="line">    &quot;fruit&quot;: &quot;apple&quot;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Explanation:</b></p>
<ol type="1">
<li>We started with an empty <code>Session</code> and an empty cookie jar (<code>{}</code>).</li>
<li>We visited <code>/cookies/set/fruit/apple</code>. The server sent back a <code>Set-Cookie: fruit=apple; Path=/</code> header.</li>
<li>The <code>Session</code> object <code>s</code> automatically saw this header and stored the <code>fruit=apple</code> cookie in its jar (<code>s.cookies</code>). We confirmed this by printing <code>s.cookies.get_dict()</code>.</li>
<li>We then visited <code>/cookies</code> using the <em>same session</em> <code>s</code>.</li>
<li>The <code>Session</code> automatically looked in <code>s.cookies</code>, found the <code>fruit</code> cookie (since it's for the <code>httpbin.org</code> domain), and added a <code>Cookie: fruit=apple</code> header to the request.</li>
<li>The server at <code>/cookies</code> received this header and echoed it back, confirming our cookie was sent!</li>
</ol>
<p>The <code>Session</code> and its <code>Cookie Jar</code> handled the persistence automatically.</p>
<h2><a class="anchor" id="autotoc_md2922"></a>
Cookies in the Response</h2>
<p>While the <code>Session</code> cookie jar (<code>s.cookies</code>) holds <em>all</em> cookies collected during the session's lifetime, the <a class="el" href="../../dd/d7e/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_202__request______response__models.html">Request &amp; Response Models</a> also have a <code>cookies</code> attribute.</p>
<p>The <code>response.cookies</code> attribute (also a <code>RequestsCookieJar</code>) contains <em>only</em> the cookies that were set or updated by <em>that specific response</em>. It doesn't know about cookies from previous responses in the session.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> requests</div>
<div class="line"> </div>
<div class="line">s = requests.Session()</div>
<div class="line"> </div>
<div class="line">url_set_a = <span class="stringliteral">&#39;https://httpbin.org/cookies/set/cookieA/valueA&#39;</span></div>
<div class="line">url_set_b = <span class="stringliteral">&#39;https://httpbin.org/cookies/set/cookieB/valueB&#39;</span></div>
<div class="line"> </div>
<div class="line">print(f<span class="stringliteral">&quot;Visiting {url_set_a}&quot;</span>)</div>
<div class="line">response_a = s.get(url_set_a)</div>
<div class="line">print(f<span class="stringliteral">&quot;Cookies SET by response A: {response_a.cookies.get_dict()}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;ALL session cookies after A: {s.cookies.get_dict()}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">print(f<span class="stringliteral">&quot;\nVisiting {url_set_b}&quot;</span>)</div>
<div class="line">response_b = s.get(url_set_b)</div>
<div class="line">print(f<span class="stringliteral">&quot;Cookies SET by response B: {response_b.cookies.get_dict()}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;ALL session cookies after B: {s.cookies.get_dict()}&quot;</span>)</div>
</div><!-- fragment --><p><b>Output:</b></p>
<div class="fragment"><div class="line">Visiting https://httpbin.org/cookies/set/cookieA/valueA</div>
<div class="line">Cookies SET by response A: {&#39;cookieA&#39;: &#39;valueA&#39;}</div>
<div class="line">ALL session cookies after A: {&#39;cookieA&#39;: &#39;valueA&#39;}</div>
<div class="line"> </div>
<div class="line">Visiting https://httpbin.org/cookies/set/cookieB/valueB</div>
<div class="line">Cookies SET by response B: {&#39;cookieB&#39;: &#39;valueB&#39;}</div>
<div class="line">ALL session cookies after B: {&#39;cookieA&#39;: &#39;valueA&#39;, &#39;cookieB&#39;: &#39;valueB&#39;}</div>
</div><!-- fragment --><p><b>Explanation:</b></p>
<ul>
<li><code>response_a.cookies</code> only contains <code>cookieA</code>, because that's the cookie set by <em>that specific response</em>.</li>
<li><code>s.cookies</code> contains <code>cookieA</code> after the first request.</li>
<li><code>response_b.cookies</code> only contains <code>cookieB</code>.</li>
<li><code>s.cookies</code> contains <em>both</em> <code>cookieA</code> and <code>cookieB</code> after the second request, because the <code>Session</code> accumulates cookies.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2923"></a>
Using the Cookie Jar Like a Dictionary</h2>
<p>The <code>RequestsCookieJar</code> is extra friendly because you can treat it much like a Python dictionary to access or modify cookies directly.</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> requests</div>
<div class="line"> </div>
<div class="line">jar = requests.cookies.RequestsCookieJar()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Set cookies using dictionary-like assignment or set()</span></div>
<div class="line">jar.set(<span class="stringliteral">&#39;username&#39;</span>, <span class="stringliteral">&#39;Nate&#39;</span>, domain=<span class="stringliteral">&#39;httpbin.org&#39;</span>, path=<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line">jar[<span class="stringliteral">&#39;session_id&#39;</span>] = <span class="stringliteral">&#39;abcdef123&#39;</span> <span class="comment"># Sets for default domain/path (&#39;&#39;)</span></div>
<div class="line"> </div>
<div class="line">print(f<span class="stringliteral">&quot;Jar contents: {jar.get_dict()}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Get cookies using dictionary-like access or get()</span></div>
<div class="line">print(f<span class="stringliteral">&quot;Username: {jar[&#39;username&#39;]}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Session ID: {jar.get(&#39;session_id&#39;)}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;API Key (default None): {jar.get(&#39;api_key&#39;, default=&#39;NoKey&#39;)}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Iterate over cookies</span></div>
<div class="line">print(<span class="stringliteral">&quot;\nIterating:&quot;</span>)</div>
<div class="line"><span class="keywordflow">for</span> name, value <span class="keywordflow">in</span> jar.items():</div>
<div class="line">    print(f<span class="stringliteral">&quot; - {name}: {value}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Delete a cookie</span></div>
<div class="line">del jar[<span class="stringliteral">&#39;session_id&#39;</span>]</div>
<div class="line">print(f<span class="stringliteral">&quot;\nJar after deleting session_id: {jar.get_dict()}&quot;</span>)</div>
</div><!-- fragment --><p><b>Output:</b></p>
<div class="fragment"><div class="line">Jar contents: {&#39;session_id&#39;: &#39;abcdef123&#39;, &#39;username&#39;: &#39;Nate&#39;}</div>
<div class="line">Username: Nate</div>
<div class="line">Session ID: abcdef123</div>
<div class="line">API Key (default None): NoKey</div>
<div class="line"> </div>
<div class="line">Iterating:</div>
<div class="line"> - session_id: abcdef123</div>
<div class="line"> - username: Nate</div>
<div class="line"> </div>
<div class="line">Jar after deleting session_id: {&#39;username&#39;: &#39;Nate&#39;}</div>
</div><!-- fragment --><p>This makes it easy to manually inspect, add, or modify cookies if needed, although the <code>Session</code> usually handles the common cases automatically.</p>
<p><b>Important Note:</b> Cookies often have specific <code>domain</code> and <code>path</code> attributes. If you have multiple cookies with the <em>same name</em> but for different domains or paths (e.g., <code>user=A</code> for <code>site1.com</code> and <code>user=B</code> for <code>site2.com</code>), using the simple dictionary access &lsquo;jar['user&rsquo;]<code>might be ambiguous or raise an error. In such cases, use the</code><a class="el" href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get()</a><code>or</code><a class="el" href="../../d7/da6/pybind__kv__service_8cpp.html#a26ae8807a2b3217bb2339bd18aaaa4e6">set()</a><code>methods with the</code>domain<code>and</code>path` arguments for more precision:</p>
<div class="fragment"><div class="line">jar.set(<span class="stringliteral">&#39;pref&#39;</span>, <span class="stringliteral">&#39;dark&#39;</span>, domain=<span class="stringliteral">&#39;example.com&#39;</span>, path=<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line">jar.set(<span class="stringliteral">&#39;pref&#39;</span>, <span class="stringliteral">&#39;compact&#39;</span>, domain=<span class="stringliteral">&#39;test.com&#39;</span>, path=<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Get the specific cookie for example.com</span></div>
<div class="line">pref_example = jar.get(<span class="stringliteral">&#39;pref&#39;</span>, domain=<span class="stringliteral">&#39;example.com&#39;</span>, path=<span class="stringliteral">&#39;/&#39;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Pref for example.com: {pref_example}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Simple access might be ambiguous or pick one arbitrarily</span></div>
<div class="line"><span class="comment"># print(jar[&#39;pref&#39;]) # Could raise CookieConflictError or return one</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2924"></a>
How It Works Internally</h2>
<p>How does the <code>Session</code> manage this cookie magic?</p>
<ol type="1">
<li><b>Sending Request:</b> When you call <code>s.get(...)</code> or <code>s.post(...)</code>, the <code>Session.prepare_request</code> method is called.<ul>
<li>It creates a <code>PreparedRequest</code> object.</li>
<li>It merges cookies from your request (<code>cookies=...</code>), the session (<code>self.cookies</code>), and potentially environment settings.</li>
<li>It calls <code>get_cookie_header(merged_cookies, prepared_request)</code> (from <code>requests.cookies</code>). This function checks the cookie jar for cookies that match the request's domain and path.</li>
<li>It generates the <code>Cookie</code> header string (e.g., <code>Cookie: fruit=apple; username=Nate</code>) and adds it to the <code>PreparedRequest.headers</code>.</li>
<li>The request (with the <code>Cookie</code> header) is then sent via a <a class="el" href="../../d5/d83/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_207__transport__adapters.html">Transport Adapter</a>.</li>
</ul>
</li>
<li><b>Receiving Response:</b> When the <a class="el" href="../../d5/d83/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_207__transport__adapters.html">Transport Adapter</a> receives the raw HTTP response from the server:<ul>
<li>It builds the <code>Response</code> object.</li>
<li>The <code>Session.send</code> method (or redirection logic) gets this <code>Response</code>.</li>
<li>It calls <code>extract_cookies_to_jar(self.cookies, request, response.raw)</code> (from <code>requests.cookies</code>). This function looks for <code>Set-Cookie</code> headers in the raw response.</li>
<li>It parses any <code>Set-Cookie</code> headers and adds/updates the corresponding cookies in the <code>Session</code>'s cookie jar (<code>self.cookies</code>).</li>
<li>The final <code>Response</code> object is returned to you.</li>
</ul>
</li>
</ol>
<p>Here's a simplified diagram focusing on the cookie flow:</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant User as Your Code</div>
<div class="line">    participant Sess as Session Object</div>
<div class="line">    participant Jar as Cookie Jar (s.cookies)</div>
<div class="line">    participant Adapter as Transport Adapter</div>
<div class="line">    participant Server as Web Server</div>
<div class="line"> </div>
<div class="line">    User-&gt;&gt;Sess: s.get(url)</div>
<div class="line">    Sess-&gt;&gt;Jar: get_cookie_header(url)</div>
<div class="line">    Jar--&gt;&gt;Sess: Return matching cookie header string (e.g., &quot;fruit=apple&quot;)</div>
<div class="line">    Sess-&gt;&gt;Adapter: send(request with &#39;Cookie&#39; header)</div>
<div class="line">    Adapter-&gt;&gt;Server: Send HTTP Request (with Cookie: fruit=apple)</div>
<div class="line">    Server--&gt;&gt;Adapter: Send HTTP Response (e.g., with Set-Cookie: new=cookie)</div>
<div class="line">    Adapter-&gt;&gt;Sess: Return raw response</div>
<div class="line">    Sess-&gt;&gt;Jar: extract_cookies_to_jar(raw response)</div>
<div class="line">    Jar-&gt;&gt;Jar: Add/Update &#39;new=cookie&#39;</div>
<div class="line">    Sess-&gt;&gt;User: Return Response object</div>
</div><!-- fragment --><p>You can see parts of this logic in <code>requests/sessions.py</code> and <code>requests/cookies.py</code>:</p>
<div class="fragment"><div class="line"><span class="comment"># File: requests/sessions.py (Simplified View)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">from</span> .cookies <span class="keyword">import</span> extract_cookies_to_jar, merge_cookies, RequestsCookieJar, cookiejar_from_dict</div>
<div class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> PreparedRequest</div>
<div class="line"><span class="keyword">from</span> .utils <span class="keyword">import</span> to_key_val_list</div>
<div class="line"><span class="keyword">from</span> .structures <span class="keyword">import</span> CaseInsensitiveDict</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Session:</div>
<div class="line">    <span class="keyword">def </span>__init__(self):</div>
<div class="line">        <span class="comment"># ... other attributes ...</span></div>
<div class="line">        self.cookies = cookiejar_from_dict({}) <span class="comment"># The Session&#39;s main Cookie Jar</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>prepare_request(self, request):</div>
<div class="line">        <span class="comment"># ... merge headers, params, auth ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Merge session cookies with request-specific cookies</span></div>
<div class="line">        merged_cookies = merge_cookies(</div>
<div class="line">            merge_cookies(RequestsCookieJar(), self.cookies),</div>
<div class="line">            cookiejar_from_dict(request.cookies <span class="keywordflow">or</span> {})</div>
<div class="line">        )</div>
<div class="line"> </div>
<div class="line">        p = PreparedRequest()</div>
<div class="line">        p.prepare(</div>
<div class="line">            <span class="comment"># ... other args ...</span></div>
<div class="line">            cookies=merged_cookies, <span class="comment"># Pass merged jar to PreparedRequest</span></div>
<div class="line">        )</div>
<div class="line">        <span class="keywordflow">return</span> p</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>send(self, request, **kwargs):</div>
<div class="line">        <span class="comment"># ... prepare sending ...</span></div>
<div class="line">        adapter = self.get_adapter(url=request.url)</div>
<div class="line">        response = adapter.send(request, **kwargs) <span class="comment"># Adapter gets raw response</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># ... hooks ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># EXTRACT cookies from the response and put them in the session jar!</span></div>
<div class="line">        extract_cookies_to_jar(self.cookies, request, response.raw)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># ... redirect handling (also extracts cookies) ...</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> response</div>
<div class="line"> </div>
<div class="line"><span class="comment"># --- File: requests/models.py (Simplified View) ---</span></div>
<div class="line"><span class="keyword">from</span> .cookies <span class="keyword">import</span> get_cookie_header, _copy_cookie_jar, cookiejar_from_dict</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>PreparedRequest:</div>
<div class="line">    <span class="keyword">def </span>prepare_cookies(self, cookies):</div>
<div class="line">        <span class="comment"># Store the jar potentially passed from Session.prepare_request</span></div>
<div class="line">        <span class="keywordflow">if</span> isinstance(cookies, cookielib.CookieJar):</div>
<div class="line">            self._cookies = cookies</div>
<div class="line">        <span class="keywordflow">else</span>:</div>
<div class="line">            self._cookies = cookiejar_from_dict(cookies)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Generate the Cookie header string</span></div>
<div class="line">        cookie_header = get_cookie_header(self._cookies, self)</div>
<div class="line">        <span class="keywordflow">if</span> cookie_header <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line">            self.headers[<span class="stringliteral">&#39;Cookie&#39;</span>] = cookie_header</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Response:</div>
<div class="line">    <span class="keyword">def </span>__init__(self):</div>
<div class="line">        <span class="comment"># ... other attributes ...</span></div>
<div class="line">        <span class="comment"># This jar holds cookies SET by *this* response only</span></div>
<div class="line">        self.cookies = cookiejar_from_dict({})</div>
<div class="line"> </div>
<div class="line"><span class="comment"># --- File: requests/cookies.py (Simplified View) ---</span></div>
<div class="line"><span class="keyword">import</span> cookielib</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MockRequest: <span class="comment"># Helper to adapt requests.Request for cookielib</span></div>
<div class="line">    <span class="comment"># ... implementation ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>MockResponse: <span class="comment"># Helper to adapt response headers for cookielib</span></div>
<div class="line">    <span class="comment"># ... implementation ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>extract_cookies_to_jar(jar, request, response):</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;Extract Set-Cookie headers from response into jar.&quot;&quot;&quot;</span></div>
<div class="line">    <span class="keywordflow">if</span> <span class="keywordflow">not</span> hasattr(response, <span class="stringliteral">&#39;_original_response&#39;</span>) <span class="keywordflow">or</span> <span class="keywordflow">not</span> response._original_response:</div>
<div class="line">        <span class="keywordflow">return</span> <span class="comment"># Need the underlying httplib response</span></div>
<div class="line"> </div>
<div class="line">    req = MockRequest(request) <span class="comment"># Adapt request for cookielib</span></div>
<div class="line">    res = MockResponse(response._original_response.msg) <span class="comment"># Adapt headers for cookielib</span></div>
<div class="line">    jar.extract_cookies(res, req) <span class="comment"># Use cookielib&#39;s extraction logic</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">def </span>get_cookie_header(jar, request):</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;Generate the Cookie header string for the request.&quot;&quot;&quot;</span></div>
<div class="line">    r = MockRequest(request)</div>
<div class="line">    jar.add_cookie_header(r) <span class="comment"># Use cookielib to add the header to the mock request</span></div>
<div class="line">    <span class="keywordflow">return</span> r.get_new_headers().<a class="code hl_function" href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get</a>(<span class="stringliteral">&#39;Cookie&#39;</span>) <span class="comment"># Retrieve the generated header</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>RequestsCookieJar(cookielib.CookieJar, MutableMapping):</div>
<div class="line">    <span class="comment"># Dictionary-like methods (get, set, __getitem__, etc.)</span></div>
<div class="line">    <span class="keyword">def </span><a class="code hl_function" href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get</a>(self, name, default=None, domain=None, path=None):</div>
<div class="line">       <span class="comment"># ... find cookie, handle conflicts ...</span></div>
<div class="line">       <span class="keywordflow">pass</span></div>
<div class="line">    <span class="keyword">def </span><a class="code hl_function" href="../../d7/da6/pybind__kv__service_8cpp.html#a26ae8807a2b3217bb2339bd18aaaa4e6">set</a>(self, name, value, **kwargs):</div>
<div class="line">       <span class="comment"># ... create or update cookie ...</span></div>
<div class="line">       <span class="keywordflow">pass</span></div>
<div class="line">    <span class="comment"># ... other dict methods ...</span></div>
<div class="ttc" id="apybind__kv__service_8cpp_html_a26ae8807a2b3217bb2339bd18aaaa4e6"><div class="ttname"><a href="../../d7/da6/pybind__kv__service_8cpp.html#a26ae8807a2b3217bb2339bd18aaaa4e6">set</a></div><div class="ttdeci">bool set(std::string key, std::string value, std::string config_path)</div><div class="ttdef"><b>Definition</b> <a href="../../d7/da6/pybind__kv__service_8cpp_source.html#l00051">pybind_kv_service.cpp:51</a></div></div>
<div class="ttc" id="apybind__kv__service_8cpp_html_abe6524afb3a69dc9a4c314e11f96f29f"><div class="ttname"><a href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get</a></div><div class="ttdeci">std::string get(std::string key, std::string config_path)</div><div class="ttdef"><b>Definition</b> <a href="../../d7/da6/pybind__kv__service_8cpp_source.html#l00039">pybind_kv_service.cpp:39</a></div></div>
</div><!-- fragment --><p>The key is that <code>Session.send</code> calls <code>extract_cookies_to_jar</code> after receiving a response, and <code>PreparedRequest.prepare_cookies</code> (called via <code>Session.prepare_request</code>) calls <code>get_cookie_header</code> before sending the next one.</p>
<h2><a class="anchor" id="autotoc_md2925"></a>
Conclusion</h2>
<p>You've learned about the <b>Cookie Jar</b> (<code>RequestsCookieJar</code>), the mechanism <code>requests</code> (especially <code>Session</code> objects) uses to store and manage cookies. You saw:</p>
<ul>
<li>How <code>Session</code> objects automatically use their cookie jar (<code>s.cookies</code>) to persist cookies across requests.</li>
<li>How <code>response.cookies</code> contains cookies set by a specific response.</li>
<li>How to interact with a <code>RequestsCookieJar</code> using its dictionary-like interface.</li>
<li>A glimpse into how <code>requests</code> extracts cookies from <code>Set-Cookie</code> headers and adds them back via the <code>Cookie</code> header.</li>
</ul>
<p>Understanding the cookie jar helps explain how sessions maintain state and interact with websites that require logins or remember preferences.</p>
<p>Speaking of logging in, while cookies are often involved, sometimes websites require more explicit forms of identification, like usernames and passwords sent directly with the request. How does <code>requests</code> handle those?</p>
<p><b>Next:</b> <a class="el" href="../../d7/df0/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2Requests_205__authentication__handlers.html">Chapter 5: Authentication Handlers</a></p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
