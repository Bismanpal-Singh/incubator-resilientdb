#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 05_baseflow</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d0/d93/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_205__baseflow.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">05_baseflow</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md2629"></a>
autotoc_md2629</h2>
<p>layout: default title: "BaseFlow" parent: "OpenManus" </p>
<h2><a class="anchor" id="autotoc_md2630"></a>
nav_order: 5</h2>
<h1><a class="anchor" id="autotoc_md2631"></a>
Chapter 5: BaseFlow - Managing Multi-Step Projects</h1>
<p>In <a class="el" href="../../de/db0/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_204__tool______toolcollection.html">Chapter 4: Tool / ToolCollection</a>, we saw how to give agents specific skills like web searching or running code using Tools. Now, imagine you have a task that requires multiple steps, maybe even using different skills (tools) or agents along the way. How do you coordinate this complex work?</p>
<p>That's where <b>Flows</b> come in!</p>
<h2><a class="anchor" id="autotoc_md2632"></a>
What Problem Does <code>BaseFlow</code> Solve?</h2>
<p>Think about a simple agent, maybe one equipped with a web search tool. You could ask it, "What's the capital of France?" and it could use its tool and answer "Paris." That's a single-step task.</p>
<p>But what if you ask something more complex, like: "Research the pros and cons of electric cars and then write a short blog post summarizing them."</p>
<p>This isn't a single action. It involves:</p><ol type="1">
<li><b>Planning:</b> Figuring out the steps needed (e.g., search for pros, search for cons, structure blog post, write draft, review draft).</li>
<li><b>Executing Step 1:</b> Using a web search tool to find pros.</li>
<li><b>Executing Step 2:</b> Using a web search tool to find cons.</li>
<li><b>Executing Step 3:</b> Maybe using the <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a> brain to outline the blog post.</li>
<li><b>Executing Step 4:</b> Using the LLM to write the post based on the research and outline.</li>
<li><b>Executing Step 5:</b> Perhaps a final review step.</li>
</ol>
<p>A single <a class="el" href="../../d0/d71/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_203__baseagent.html">BaseAgent</a> <em>might</em> be able to handle this if it's very sophisticated, but it's often clearer and more manageable to have a dedicated <b>orchestrator</b> or <b>project manager</b> overseeing the process.</p>
<p><b>This is the job of a <code>Flow</code>.</b> Specifically, <code>BaseFlow</code> is the blueprint for these orchestrators. It defines a structure that can manage multiple agents and coordinate their work to achieve a larger goal according to a specific strategy (like following a pre-defined plan).</p>
<p><b>Use Case:</b> Let's stick with our "Research and Write" task. We need something to manage the overall process: first the research, then the writing. A <code>PlanningFlow</code> (a specific type of Flow built on <code>BaseFlow</code>) is perfect for this. It will first create a plan (like the steps above) and then execute each step, potentially assigning different steps to different specialized agents if needed.</p>
<h2><a class="anchor" id="autotoc_md2633"></a>
Key Concepts: Flow, Agents, and Strategy</h2>
<ol type="1">
<li><b><code>BaseFlow</code> (<code>app/flow/base.py</code>):</b><ul>
<li>This is the <b>abstract blueprint</b> for all flows. Think of it as the job description for a project manager â€“ it says a manager needs to know their team (agents) and have a way to run the project (<code>execute</code> method), but it doesn't dictate <em>how</em> they manage.</li>
<li>It mainly holds a dictionary of available <code>agents</code> that can be used within the flow.</li>
<li>You don't use <code>BaseFlow</code> directly; you use specific implementations.</li>
</ul>
</li>
<li><b>Concrete Flows (e.g., <code>PlanningFlow</code> in <code>app/flow/planning.py</code>):</b><ul>
<li>These are the <b>specific strategies</b> for managing the project. They <em>inherit</em> from <code>BaseFlow</code>.</li>
<li><code>PlanningFlow</code> is a key example. Its strategy is:<ol type="a">
<li>Receive the overall goal.</li>
<li>Use an LLM and a special <code>PlanningTool</code> to break the goal down into a sequence of steps (the "plan").</li>
<li>Execute each step in the plan, one by one, usually by calling the <code>run()</code> method of an appropriate <a class="el" href="../../d0/d71/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_203__baseagent.html">BaseAgent</a>.</li>
<li>Track the status of each step (e.g., not started, in progress, completed).</li>
</ol>
</li>
</ul>
</li>
<li><b>Agents within the Flow:</b><ul>
<li>These are the "workers" or "specialists" managed by the flow.</li>
<li>A flow holds one or more <a class="el" href="../../d0/d71/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_203__baseagent.html">BaseAgent</a> instances.</li>
<li>In a <code>PlanningFlow</code>, one agent might be designated as the primary agent (often responsible for helping create the plan), while others (or maybe the same one) act as "executors" for the plan steps. The flow decides which agent is best suited for each step.</li>
</ul>
</li>
</ol>
<p>Think of it like building a house:</p><ul>
<li><code>BaseFlow</code> is the concept of a "General Contractor".</li>
<li><code>PlanningFlow</code> is a specific <em>type</em> of General Contractor who always starts by creating a detailed architectural plan and then hires specialists for each phase.</li>
<li>The <code>agents</code> are the specialists: the plumber, the electrician, the carpenter, etc.</li>
<li>The overall goal ("Build a house") is given to the <code>PlanningFlow</code> (Contractor).</li>
<li>The <code>PlanningFlow</code> creates the plan (foundation, framing, plumbing, electrical...).</li>
<li>The <code>PlanningFlow</code> then calls the appropriate <code>agent</code> (specialist) for each step in the plan.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2634"></a>
How Do We Use Flows?</h2>
<p>You typically use a <code>FlowFactory</code> to create a specific type of flow, providing it with the agents it needs.</p>
<p>Let's set up a simple <code>PlanningFlow</code> with one agent called "Manus" (which is a general-purpose agent in OpenManus).</p>
<div class="fragment"><div class="line"><span class="comment"># Import necessary classes</span></div>
<div class="line"><span class="keyword">from</span> app.agent.manus <span class="keyword">import</span> Manus <span class="comment"># A capable agent</span></div>
<div class="line"><span class="keyword">from</span> app.flow.flow_factory <span class="keyword">import</span> FlowFactory, FlowType</div>
<div class="line"><span class="keyword">import</span> asyncio <span class="comment"># Needed for async execution</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># 1. Create the agent(s) we want the flow to manage</span></div>
<div class="line"><span class="comment"># We can give agents specific keys (names) within the flow</span></div>
<div class="line">agents_for_flow = {</div>
<div class="line">    <span class="stringliteral">&quot;research_writer&quot;</span>: Manus() <span class="comment"># Use Manus agent for all tasks</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment"># 2. Create the flow using the factory</span></div>
<div class="line"><span class="comment"># We specify the type (PLANNING) and provide the agents</span></div>
<div class="line">planning_flow_instance = FlowFactory.create_flow(</div>
<div class="line">    flow_type=FlowType.PLANNING,</div>
<div class="line">    agents=agents_for_flow,</div>
<div class="line">    <span class="comment"># Optional: specify which agent is primary (if not first)</span></div>
<div class="line">    <span class="comment"># primary_agent_key=&quot;research_writer&quot;</span></div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">print(f<span class="stringliteral">&quot;Created a {type(planning_flow_instance).__name__}&quot;</span>)</div>
<div class="line">print(f<span class="stringliteral">&quot;Primary agent: {planning_flow_instance.primary_agent.name}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># 3. Define the overall goal for the flow</span></div>
<div class="line">overall_goal = <span class="stringliteral">&quot;Research the main benefits of solar power and write a short summary.&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Define an async function to run the flow</span></div>
<div class="line"><span class="keyword">async def </span>run_the_flow():</div>
<div class="line">    print(f<span class="stringliteral">&quot;\nExecuting flow with goal: &#39;{overall_goal}&#39;&quot;</span>)</div>
<div class="line">    <span class="comment"># 4. Execute the flow with the goal</span></div>
<div class="line">    final_result = await planning_flow_instance.execute(overall_goal)</div>
<div class="line">    print(<span class="stringliteral">&quot;\n--- Flow Execution Finished ---&quot;</span>)</div>
<div class="line">    print(f<span class="stringliteral">&quot;Final Result:\n{final_result}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Run the async function</span></div>
<div class="line"><span class="comment"># asyncio.run(run_the_flow()) # Uncomment to run</span></div>
</div><!-- fragment --><p><b>Explanation:</b></p>
<ol type="1">
<li>We import the agent we want to use (<code>Manus</code>) and the <code>FlowFactory</code> plus <code>FlowType</code>.</li>
<li>We create a dictionary <code>agents_for_flow</code> mapping a key ("research\_writer") to an instance of our <code>Manus</code> agent. This tells the flow which workers are available.</li>
<li>We use <code>FlowFactory.create_flow()</code> specifying <code>FlowType.PLANNING</code> and passing our <code>agents_for_flow</code>. The factory handles constructing the <code>PlanningFlow</code> object correctly.</li>
<li>We define the high-level task (<code>overall_goal</code>).</li>
<li>We call <code>await planning_flow_instance.execute(overall_goal)</code>. This is where the magic happens! The <code>PlanningFlow</code> takes over.</li>
</ol>
<p><b>Expected Outcome (High Level):</b></p>
<p>When you run this (if uncommented), you won't just get an immediate answer. You'll likely see output indicating:</p><ul>
<li>A plan is being created (e.g., Step 1: Search for benefits, Step 2: Synthesize findings, Step 3: Write summary).</li>
<li>The agent ("research\_writer") starting to execute Step 1. This might involve output from the agent using its web search tool.</li>
<li>The agent moving on to Step 2, then Step 3, potentially showing LLM thinking or writing output.</li>
<li>Finally, the <code>execute</code> call will return a string containing the results of the steps and possibly a final summary generated by the flow or the agent.</li>
</ul>
<p>The <code>PlanningFlow</code> manages this entire multi-step process automatically based on the initial goal.</p>
<h2><a class="anchor" id="autotoc_md2635"></a>
Under the Hood: How <code>PlanningFlow.execute</code> Works</h2>
<p>Let's peek behind the curtain of the <code>PlanningFlow</code>'s <code>execute</code> method. What happens when you call it?</p>
<p><b>High-Level Walkthrough:</b></p>
<ol type="1">
<li><b>Receive Goal:</b> The <code>execute</code> method gets the <code>input_text</code> (our overall goal).</li>
<li><b>Create Plan (<code>_create_initial_plan</code>):</b><ul>
<li>It constructs messages for the <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a>, including a system message asking it to act as a planner.</li>
<li>It tells the LLM about the <code>PlanningTool</code> (a special <a class="el" href="../../de/db0/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_204__tool______toolcollection.html">Tool</a> designed for creating and managing plans).</li>
<li>It calls the LLM's <code>ask_tool</code> method, essentially asking: "Please use the PlanningTool to create a plan for this goal: *{input\_text}*".</li>
<li>The <code>PlanningTool</code> (when called by the LLM) stores the generated steps (e.g., ["Search benefits", "Write summary"]) associated with a unique <code>plan_id</code>.</li>
</ul>
</li>
<li><b>Execution Loop:</b> The flow enters a loop to execute the plan steps.<ul>
<li><b>Get Next Step (<code>_get_current_step_info</code>):</b> It checks the stored plan (using the <code>PlanningTool</code>) to find the first step that isn't marked as "completed". It gets the step's text and index.</li>
<li><b>Check for Completion:</b> If no non-completed steps are found, the plan is finished! The loop breaks.</li>
<li><b>Select Executor (<code>get_executor</code>):</b> It determines which agent should perform the current step. In our simple example, it will always select our "research\_writer" agent. More complex flows could choose based on step type (e.g., a "[CODE]" step might go to a coding agent).</li>
<li><b>Execute Step (<code>_execute_step</code>):</b><ul>
<li>It prepares a prompt for the selected executor agent, including the current plan status and the specific instruction for the current step (e.g., "You are working on step 0: 'Search benefits'. Please execute this step.").</li>
<li>It calls the executor agent's <code>run()</code> method with this prompt: <code>await executor.run(step_prompt)</code>. The agent then does its work (which might involve using its own tools, memory, and LLM).</li>
<li>It gets the result back from the agent's <code>run()</code>.</li>
</ul>
</li>
<li><b>Mark Step Complete (<code>_mark_step_completed</code>):</b> It tells the <code>PlanningTool</code> to update the status of the current step to "completed".</li>
<li><b>Loop:</b> Go back to find the next step.</li>
</ul>
</li>
<li><b>Finalize (<code>_finalize_plan</code>):</b> Once the loop finishes, it might generate a final summary of the completed plan (potentially using the LLM again).</li>
<li><b>Return Result:</b> The accumulated results from executing all the steps are returned as a string.</li>
</ol>
<p><b>Sequence Diagram:</b></p>
<p>Here's a simplified view of the process:</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant User</div>
<div class="line">    participant PF as PlanningFlow</div>
<div class="line">    participant LLM_Planner as LLM (for Planning)</div>
<div class="line">    participant PlanTool as PlanningTool</div>
<div class="line">    participant Executor as Executor Agent (e.g., Manus)</div>
<div class="line">    participant AgentLLM as Agent&#39;s LLM (for Execution)</div>
<div class="line"> </div>
<div class="line">    User-&gt;&gt;+PF: execute(&quot;Research &amp; Summarize Solar Power&quot;)</div>
<div class="line">    PF-&gt;&gt;+LLM_Planner: ask_tool(&quot;Create plan...&quot;, tools=[PlanTool])</div>
<div class="line">    LLM_Planner-&gt;&gt;+PlanTool: execute(command=&#39;create&#39;, steps=[&#39;Search&#39;, &#39;Summarize&#39;], ...)</div>
<div class="line">    PlanTool--&gt;&gt;-LLM_Planner: Plan created (ID: plan_123)</div>
<div class="line">    LLM_Planner--&gt;&gt;-PF: Plan created successfully</div>
<div class="line">    Note over PF: Start Execution Loop</div>
<div class="line">    loop Plan Steps</div>
<div class="line">        PF-&gt;&gt;+PlanTool: get_next_step(plan_id=&#39;plan_123&#39;)</div>
<div class="line">        PlanTool--&gt;&gt;-PF: Step 0: &quot;Search&quot;</div>
<div class="line">        PF-&gt;&gt;PF: Select Executor (Manus)</div>
<div class="line">        PF-&gt;&gt;+Executor: run(&quot;Execute step 0: &#39;Search&#39;...&quot;)</div>
<div class="line">        Executor-&gt;&gt;+AgentLLM: ask/ask_tool (e.g., use web search)</div>
<div class="line">        AgentLLM--&gt;&gt;-Executor: Search results</div>
<div class="line">        Executor--&gt;&gt;-PF: Step 0 result (&quot;Found benefits X, Y, Z...&quot;)</div>
<div class="line">        PF-&gt;&gt;+PlanTool: mark_step(plan_id=&#39;plan_123&#39;, step=0, status=&#39;completed&#39;)</div>
<div class="line">        PlanTool--&gt;&gt;-PF: Step marked</div>
<div class="line">        PF-&gt;&gt;+PlanTool: get_next_step(plan_id=&#39;plan_123&#39;)</div>
<div class="line">        PlanTool--&gt;&gt;-PF: Step 1: &quot;Summarize&quot;</div>
<div class="line">        PF-&gt;&gt;PF: Select Executor (Manus)</div>
<div class="line">        PF-&gt;&gt;+Executor: run(&quot;Execute step 1: &#39;Summarize&#39;...&quot;)</div>
<div class="line">        Executor-&gt;&gt;+AgentLLM: ask(&quot;Summarize: X, Y, Z...&quot;)</div>
<div class="line">        AgentLLM--&gt;&gt;-Executor: Summary text</div>
<div class="line">        Executor--&gt;&gt;-PF: Step 1 result (&quot;Solar power benefits include...&quot;)</div>
<div class="line">        PF-&gt;&gt;+PlanTool: mark_step(plan_id=&#39;plan_123&#39;, step=1, status=&#39;completed&#39;)</div>
<div class="line">        PlanTool--&gt;&gt;-PF: Step marked</div>
<div class="line">        PF-&gt;&gt;+PlanTool: get_next_step(plan_id=&#39;plan_123&#39;)</div>
<div class="line">        PlanTool--&gt;&gt;-PF: No more steps</div>
<div class="line">    end</div>
<div class="line">    Note over PF: End Execution Loop</div>
<div class="line">    PF-&gt;&gt;PF: Finalize (optional summary)</div>
<div class="line">    PF--&gt;&gt;-User: Final combined result string</div>
</div><!-- fragment --><p><b>Code Glimpse:</b></p>
<p>Let's look at simplified snippets from the flow files.</p>
<ul>
<li><b><code>app/flow/base.py</code>:</b> The blueprint just holds agents.</li>
</ul>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippet from app/flow/base.py</span></div>
<div class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</div>
<div class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Dict, List, Optional, Union</div>
<div class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</div>
<div class="line"><span class="keyword">from</span> app.agent.base <span class="keyword">import</span> BaseAgent</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>BaseFlow(BaseModel, ABC):</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;Base class for execution flows supporting multiple agents&quot;&quot;&quot;</span></div>
<div class="line">    agents: Dict[str, BaseAgent] <span class="comment"># Holds the agents</span></div>
<div class="line">    primary_agent_key: Optional[str] = <span class="keywordtype">None</span> <span class="comment"># Key for the main agent</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment"># ... __init__ handles setting up the agents dictionary ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="preprocessor">@property</span></div>
<div class="line">    <span class="keyword">def </span>primary_agent(self) -&gt; Optional[BaseAgent]:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Get the primary agent for the flow&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">return</span> self.agents.<a class="code hl_function" href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get</a>(self.primary_agent_key)</div>
<div class="line"> </div>
<div class="line">    <span class="preprocessor">@abstractmethod</span> <span class="comment"># Subclasses MUST implement execute</span></div>
<div class="line">    <span class="keyword">async def </span>execute(self, input_text: str) -&gt; str:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Execute the flow with given input&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">pass</span></div>
<div class="ttc" id="apybind__kv__service_8cpp_html_abe6524afb3a69dc9a4c314e11f96f29f"><div class="ttname"><a href="../../d7/da6/pybind__kv__service_8cpp.html#abe6524afb3a69dc9a4c314e11f96f29f">get</a></div><div class="ttdeci">std::string get(std::string key, std::string config_path)</div><div class="ttdef"><b>Definition</b> <a href="../../d7/da6/pybind__kv__service_8cpp_source.html#l00039">pybind_kv_service.cpp:39</a></div></div>
</div><!-- fragment --><ul>
<li><b><code>app/flow/flow_factory.py</code>:</b> Creates the specific flow.</li>
</ul>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippet from app/flow/flow_factory.py</span></div>
<div class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</div>
<div class="line"><span class="keyword">from</span> app.agent.base <span class="keyword">import</span> BaseAgent</div>
<div class="line"><span class="keyword">from</span> app.flow.base <span class="keyword">import</span> BaseFlow</div>
<div class="line"><span class="keyword">from</span> app.flow.planning <span class="keyword">import</span> PlanningFlow <span class="comment"># Import specific flows</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>FlowType(str, Enum):</div>
<div class="line">    PLANNING = <span class="stringliteral">&quot;planning&quot;</span> <span class="comment"># Add other flow types here</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>FlowFactory:</div>
<div class="line">    <span class="preprocessor">@staticmethod</span></div>
<div class="line">    <span class="keyword">def </span>create_flow(flow_type: FlowType, agents, **kwargs) -&gt; BaseFlow:</div>
<div class="line">        flows = { <span class="comment"># Maps type enum to the actual class</span></div>
<div class="line">            FlowType.PLANNING: PlanningFlow,</div>
<div class="line">        }</div>
<div class="line">        flow_class = flows.get(flow_type)</div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> flow_class:</div>
<div class="line">            <span class="keywordflow">raise</span> ValueError(f<span class="stringliteral">&quot;Unknown flow type: {flow_type}&quot;</span>)</div>
<div class="line">        <span class="comment"># Creates an instance of PlanningFlow(agents, **kwargs)</span></div>
<div class="line">        <span class="keywordflow">return</span> flow_class(agents, **kwargs)</div>
</div><!-- fragment --><ul>
<li><b><code>app/flow/planning.py</code>:</b> The core planning and execution logic.</li>
</ul>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippets from app/flow/planning.py</span></div>
<div class="line"><span class="keyword">from</span> app.flow.base <span class="keyword">import</span> BaseFlow</div>
<div class="line"><span class="keyword">from</span> app.tool <span class="keyword">import</span> PlanningTool</div>
<div class="line"><span class="keyword">from</span> app.agent.base <span class="keyword">import</span> BaseAgent</div>
<div class="line"><span class="keyword">from</span> app.schema <span class="keyword">import</span> Message <span class="comment"># Assuming Message is imported</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>PlanningFlow(BaseFlow):</div>
<div class="line">    planning_tool: PlanningTool = Field(default_factory=PlanningTool)</div>
<div class="line">    <span class="comment"># ... other fields like llm, active_plan_id ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>execute(self, input_text: str) -&gt; str:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Execute the planning flow with agents.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="comment"># 1. Create the plan if input is provided</span></div>
<div class="line">        <span class="keywordflow">if</span> input_text:</div>
<div class="line">            await self._create_initial_plan(input_text)</div>
<div class="line">            <span class="comment"># Check if plan exists...</span></div>
<div class="line"> </div>
<div class="line">        result_accumulator = <span class="stringliteral">&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">while</span> <span class="keyword">True</span>:</div>
<div class="line">            <span class="comment"># 2. Get the next step to execute</span></div>
<div class="line">            step_index, step_info = await self._get_current_step_info()</div>
<div class="line"> </div>
<div class="line">            <span class="comment"># 3. Exit if no more steps</span></div>
<div class="line">            <span class="keywordflow">if</span> step_index <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line">                result_accumulator += await self._finalize_plan()</div>
<div class="line">                <span class="keywordflow">break</span></div>
<div class="line"> </div>
<div class="line">            <span class="comment"># 4. Get the agent to execute the step</span></div>
<div class="line">            executor_agent = self.get_executor(step_info.get(<span class="stringliteral">&quot;type&quot;</span>))</div>
<div class="line"> </div>
<div class="line">            <span class="comment"># 5. Execute the step using the agent</span></div>
<div class="line">            step_result = await self._execute_step(executor_agent, step_info)</div>
<div class="line">            result_accumulator += step_result + <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line"> </div>
<div class="line">            <span class="comment"># Mark step as completed (done inside _execute_step or here)</span></div>
<div class="line">            <span class="comment"># await self._mark_step_completed(step_index) # Simplified</span></div>
<div class="line"> </div>
<div class="line">            <span class="comment"># Maybe check if agent finished early...</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> result_accumulator</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>_create_initial_plan(self, request: str):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Uses LLM and PlanningTool to create the plan.&quot;&quot;&quot;</span></div>
<div class="line">        logger.info(f<span class="stringliteral">&quot;Creating plan for: {request}&quot;</span>)</div>
<div class="line">        system_msg = Message.system_message(<span class="stringliteral">&quot;You are a planner...&quot;</span>)</div>
<div class="line">        user_msg = Message.user_message(f<span class="stringliteral">&quot;Create a plan for: {request}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Ask LLM to use the planning tool</span></div>
<div class="line">        response = await self.llm.ask_tool(</div>
<div class="line">            messages=[user_msg],</div>
<div class="line">            system_msgs=[system_msg],</div>
<div class="line">            tools=[self.planning_tool.to_param()], <span class="comment"># Provide the tool spec</span></div>
<div class="line">            <span class="comment"># Force LLM to use a tool (often planning tool)</span></div>
<div class="line">            <span class="comment"># tool_choice=ToolChoice.AUTO # Or specify planning tool name</span></div>
<div class="line">        )</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Process LLM response to execute the planning tool call</span></div>
<div class="line">        <span class="comment"># Simplified: Assume LLM calls planning_tool.execute(...)</span></div>
<div class="line">        <span class="comment"># to store the plan steps.</span></div>
<div class="line">        <span class="comment"># ... logic to handle response and tool execution ...</span></div>
<div class="line">        logger.info(<span class="stringliteral">&quot;Plan created.&quot;</span>)</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>_execute_step(self, executor: BaseAgent, step_info: dict) -&gt; str:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Execute a single step using the executor agent.&quot;&quot;&quot;</span></div>
<div class="line">        step_text = step_info.get(<span class="stringliteral">&quot;text&quot;</span>, <span class="stringliteral">&quot;Current step&quot;</span>)</div>
<div class="line">        plan_status = await self._get_plan_text() <span class="comment"># Get current plan state</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Construct prompt for the agent</span></div>
<div class="line">        step_prompt = f<span class="stringliteral">&quot;Current Plan:\n{plan_status}\n\nYour Task:\nExecute step: {step_text}&quot;</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Call the agent&#39;s run method!</span></div>
<div class="line">        step_result = await executor.run(step_prompt)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Mark step completed after execution</span></div>
<div class="line">        await self._mark_step_completed()</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> step_result</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>_mark_step_completed(self):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Update the planning tool state for the current step.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> self.current_step_index <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line">            await self.planning_tool.execute(</div>
<div class="line">                command=<span class="stringliteral">&quot;mark_step&quot;</span>,</div>
<div class="line">                plan_id=self.active_plan_id,</div>
<div class="line">                step_index=self.current_step_index,</div>
<div class="line">                step_status=<span class="stringliteral">&quot;completed&quot;</span> <span class="comment"># Simplified status</span></div>
<div class="line">            )</div>
<div class="line">            logger.info(f<span class="stringliteral">&quot;Step {self.current_step_index} marked complete.&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment"># ... other helper methods like _get_current_step_info, get_executor ...</span></div>
</div><!-- fragment --><p><b>Explanation of Snippets:</b></p>
<ul>
<li><code>BaseFlow</code> defines the <code>agents</code> dictionary and the abstract <code>execute</code> method.</li>
<li><code>FlowFactory</code> looks at the requested <code>FlowType</code> and returns an instance of the corresponding class (<code>PlanningFlow</code>).</li>
<li><code>PlanningFlow.execute</code> orchestrates the overall process: create plan, loop through steps, get executor, execute step via <code>agent.run()</code>, mark complete.</li>
<li><code>_create_initial_plan</code> shows interaction with the <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a> and the <code>PlanningTool</code> to generate the initial steps.</li>
<li><code>_execute_step</code> shows how the flow prepares a prompt and then delegates the actual work for a specific step to an agent by calling <code>executor.run()</code>.</li>
<li><code>_mark_step_completed</code> updates the plan state using the <code>PlanningTool</code>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md2636"></a>
Wrapping Up Chapter 5</h2>
<p>We've seen that <code>BaseFlow</code> provides a way to manage complex, multi-step tasks that might involve multiple agents or tools. It acts as an orchestrator or project manager. We focused on <code>PlanningFlow</code>, a specific strategy where a plan is created first, and then each step is executed sequentially by designated agents. This allows OpenManus to tackle much larger and more complex goals than a single agent could handle alone.</p>
<p>So far, we've covered the core components: LLMs, Memory, Agents, Tools, and Flows. But how do we define the structure of data that these components pass around, like the format of tool parameters or agent configurations? That's where schemas come in.</p>
<p>Let's move on to <a class="el" href="../../d6/d4f/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_206__schema.html">Chapter 6: Schema</a> to understand how OpenManus defines and validates data structures.</p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
