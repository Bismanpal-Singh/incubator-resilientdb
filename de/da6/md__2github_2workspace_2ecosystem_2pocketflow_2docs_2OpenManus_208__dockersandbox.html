#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#  http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ResilientDB: 08_dockersandbox</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../logo.png"/></td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('de/da6/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_208__dockersandbox.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">08_dockersandbox</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md2686"></a>
autotoc_md2686</h2>
<p>layout: default title: "DockerSandbox" parent: "OpenManus" </p>
<h2><a class="anchor" id="autotoc_md2687"></a>
nav_order: 8</h2>
<h1><a class="anchor" id="autotoc_md2688"></a>
Chapter 8: DockerSandbox - A Safe Play Area for Code</h1>
<p>Welcome to Chapter 8! In <a class="el" href="../../d5/d05/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_207__configuration____config__.html">Chapter 7: Configuration (Config)</a>, we learned how OpenManus manages settings using the <code>config.toml</code> file and the <code>Config</code> object. We saw settings for the <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a>, search tools, and something called <code>[sandbox]</code>. Now, let's dive into what that sandbox is!</p>
<h2><a class="anchor" id="autotoc_md2689"></a>
What Problem Does <code>DockerSandbox</code> Solve?</h2>
<p>Imagine our agent, powered by a smart <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a>, needs to test a piece of code it just wrote, or run a shell command to check something on the system. For example, the user asks: "Write a Python script that calculates 2 plus 2 and run it."</p>
<p>The agent might generate the code <code>print(2 + 2)</code>. But where should it run this code?</p>
<p>Running code generated by an AI, especially one connected to the internet, directly on your own computer is <b>risky</b>! What if the AI accidentally (or if tricked) generates harmful code like <code>delete_all_my_files()</code>? That would be disastrous!</p>
<p>We need a safe, isolated place to run potentially untrusted commands or code – a place where even if something goes wrong, it doesn't affect our main system.</p>
<p><b>This is exactly what the <code>DockerSandbox</code> provides.</b> Think of it as a <b>secure laboratory sandbox</b> or a disposable, locked room. Inside this room, the agent can perform potentially messy or dangerous experiments (like running code) without any risk to the outside environment (your computer).</p>
<p><b>Use Case:</b> Our agent needs to execute the Python code <code>print(2 + 2)</code>. Instead of running it directly, it will ask the <code>DockerSandbox</code> to run it inside a secure container. The sandbox will execute the code, capture the output ("4"), and report it back, all without giving the code access to the host machine's files or settings.</p>
<h2><a class="anchor" id="autotoc_md2690"></a>
Key Concepts: Secure Execution with Docker</h2>
<ol type="1">
<li><b>Isolation via Docker:</b> <code>DockerSandbox</code> uses <b>Docker containers</b> to achieve isolation. Docker is a technology that allows packaging applications and their dependencies into lightweight, self-contained units called containers. Crucially, these containers run isolated from the host system and each other. They have their own restricted view of files, network, and processes. It's like giving the code its own mini-computer to run on, completely separate from yours.</li>
<li><b>The Sandbox Container:</b> When needed, the <code>DockerSandbox</code> system creates a specific Docker container based on settings in your <code>config.toml</code>. This container is the actual "sandbox" environment.</li>
<li><b>Lifecycle Management:</b> The <code>DockerSandbox</code> system handles the entire life of the container:<ul>
<li><b>Creation:</b> Starting up a fresh container when needed.</li>
<li><b>Command Execution:</b> Running commands (like <code>python script.py</code> or <code>ls</code>) inside the container.</li>
<li><b>File Transfers:</b> Safely copying files into or out of the container if needed (e.g., putting a script file in, getting a result file out).</li>
<li><b>Cleanup:</b> Stopping and removing the container automatically when it's no longer needed or after a period of inactivity, ensuring no resources are wasted.</li>
</ul>
</li>
<li><b>Configuration (<code>config.toml</code>):</b> As we saw in the <a class="el" href="../../d5/d05/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_207__configuration____config__.html">previous chapter</a>, the <code>[sandbox]</code> section in <code>config.toml</code> controls how the sandbox behaves:<ul>
<li><code>use_sandbox = true</code>: Turns the sandbox feature on. If <code>false</code>, code might run directly on the host (less safe!).</li>
<li><code>image = "python:3.12-slim"</code>: Specifies which Docker base image to use (e.g., a minimal Python environment).</li>
<li><code>memory_limit = "512m"</code>: Restricts how much memory the container can use.</li>
<li><code>cpu_limit = 1.0</code>: Restricts how much CPU power the container can use.</li>
<li><code>timeout = 300</code>: Sets a default time limit (in seconds) for commands.</li>
<li><code>network_enabled = false</code>: Controls whether the container can access the internet (often disabled for extra security).</li>
</ul>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md2691"></a>
How Do We Use It? (Via Tools and Clients)</h2>
<p>Typically, you don't interact with the <code>DockerSandbox</code> class directly. Instead, <a class="el" href="../../de/db0/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_204__tool______toolcollection.html">Tools</a> that need to execute code, like <code>Bash</code> (<code>app/tool/bash.py</code>) or <code>PythonExecute</code> (<code>app/tool/python_execute.py</code>), often use a helper called a <b>Sandbox Client</b> to interact with the sandbox environment <em>if</em> it's enabled in the configuration.</p>
<p>OpenManus provides a ready-to-use client instance: <code>SANDBOX_CLIENT</code> (from <code>app/sandbox/client.py</code>).</p>
<p>Let's see conceptually how a tool might use <code>SANDBOX_CLIENT</code> to run our <code>print(2 + 2)</code> example safely.</p>
<p><b>1. Check Configuration:</b> First, the system checks if the sandbox is enabled.</p>
<div class="fragment"><div class="line"><span class="comment"># Check the configuration loaded in Chapter 7</span></div>
<div class="line"><span class="keyword">from</span> app.config <span class="keyword">import</span> config</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> config.sandbox <span class="keywordflow">and</span> config.sandbox.use_sandbox:</div>
<div class="line">    print(<span class="stringliteral">&quot;Sandbox is ENABLED. Code will run inside a container.&quot;</span>)</div>
<div class="line">    <span class="comment"># Proceed with using the sandbox client...</span></div>
<div class="line"><span class="keywordflow">else</span>:</div>
<div class="line">    print(<span class="stringliteral">&quot;Sandbox is DISABLED. Code might run directly on the host (potentially unsafe).&quot;</span>)</div>
<div class="line">    <span class="comment"># Fallback or raise an error...</span></div>
</div><!-- fragment --><p><b>Explanation:</b></p><ul>
<li>We import the global <code>config</code> object.</li>
<li>We check <code>config.sandbox</code> (to see if the section exists) and <code>config.sandbox.use_sandbox</code>. This value comes directly from your <code>config.toml</code> file.</li>
</ul>
<p><b>2. Use the Sandbox Client:</b> If the sandbox is enabled, a tool would use the shared <code>SANDBOX_CLIENT</code> to execute the command.</p>
<div class="fragment"><div class="line"><span class="comment"># Example of using the sandbox client (simplified)</span></div>
<div class="line"><span class="keyword">from</span> app.sandbox.client <span class="keyword">import</span> SANDBOX_CLIENT</div>
<div class="line"><span class="keyword">import</span> asyncio</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Assume sandbox is enabled based on the config check above</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># The Python code our agent wants to run</span></div>
<div class="line">python_code = <span class="stringliteral">&quot;print(2 + 2)&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create a temporary script file content</span></div>
<div class="line"><span class="comment"># We wrap the code to make it executable via &#39;python script.py&#39;</span></div>
<div class="line">script_content = f<span class="stringliteral">&quot;{python_code}&quot;</span></div>
<div class="line">script_name = <span class="stringliteral">&quot;temp_script.py&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Define the command to run inside the sandbox</span></div>
<div class="line">command_to_run = f<span class="stringliteral">&quot;python {script_name}&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">async def </span>run_in_sandbox():</div>
<div class="line">    <span class="keywordflow">try</span>:</div>
<div class="line">        print(f<span class="stringliteral">&quot;Asking sandbox to run: {command_to_run}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 1. Create the sandbox container (if not already running)</span></div>
<div class="line">        <span class="comment"># The client handles this automatically based on config</span></div>
<div class="line">        <span class="comment"># (Simplified: Actual creation might be handled by a manager)</span></div>
<div class="line">        <span class="comment"># await SANDBOX_CLIENT.create(config=config.sandbox) # Often implicit</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 2. Write the script file into the sandbox</span></div>
<div class="line">        await SANDBOX_CLIENT.write_file(script_name, script_content)</div>
<div class="line">        print(f<span class="stringliteral">&quot;Wrote &#39;{script_name}&#39; to sandbox.&quot;</span>)</div>
<div class="line"> </div>
<div class="line">        <span class="comment"># 3. Execute the command inside the sandbox</span></div>
<div class="line">        output = await SANDBOX_CLIENT.run_command(command_to_run)</div>
<div class="line">        print(f<span class="stringliteral">&quot;Sandbox execution output: {output}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line">        print(f<span class="stringliteral">&quot;An error occurred: {e}&quot;</span>)</div>
<div class="line">    <span class="comment"># finally:</span></div>
<div class="line">        <span class="comment"># 4. Cleanup (often handled automatically by a manager or context)</span></div>
<div class="line">        <span class="comment"># await SANDBOX_CLIENT.cleanup()</span></div>
<div class="line">        <span class="comment"># print(&quot;Sandbox cleaned up.&quot;)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Run the async function</span></div>
<div class="line"><span class="comment"># asyncio.run(run_in_sandbox()) # Uncomment to run</span></div>
</div><!-- fragment --><p><b>Explanation:</b></p>
<ol type="1">
<li>We import the pre-configured <code>SANDBOX_CLIENT</code>.</li>
<li>We define the Python code and the command (<code>python temp_script.py</code>) needed to execute it.</li>
<li><code>SANDBOX_CLIENT.write_file(script_name, script_content)</code>: This copies our Python code into a file <em>inside</em> the isolated container. The path <code>script_name</code> refers to a path <em>within</em> the sandbox.</li>
<li><code>SANDBOX_CLIENT.run_command(command_to_run)</code>: This is the core step! It tells the Docker container to execute <code>python temp_script.py</code>. The client waits for the command to finish and captures its output (stdout).</li>
<li>The <code>output</code> variable receives the result ("4\n" in this case).</li>
<li><b>Crucially</b>, the actual container creation and cleanup might be managed automatically in the background (by the <code>SandboxManager</code>, see <code>app/sandbox/core/manager.py</code>) or handled when the client is used within a specific context, so explicit <code>create()</code> and <code>cleanup()</code> calls might not always be needed directly in the tool's code.</li>
</ol>
<p><b>Expected Output (High Level):</b></p>
<div class="fragment"><div class="line">Sandbox is ENABLED. Code will run inside a container.</div>
<div class="line">Asking sandbox to run: python temp_script.py</div>
<div class="line">Wrote &#39;temp_script.py&#39; to sandbox.</div>
<div class="line">Sandbox execution output: 4</div>
<div class="line"> </div>
<div class="line"># (Cleanup messages might appear depending on implementation)</div>
</div><!-- fragment --><p>The important part is that <code>print(2 + 2)</code> was executed securely <em>inside</em> the Docker container, managed by the sandbox system, without exposing the host machine.</p>
<h2><a class="anchor" id="autotoc_md2692"></a>
Under the Hood: How Sandbox Execution Works</h2>
<p>Let's trace the simplified journey when a tool uses <code>SANDBOX_CLIENT.run_command("python script.py")</code>:</p>
<ol type="1">
<li><b>Request:</b> The tool (e.g., <code>PythonExecute</code>) calls <code>SANDBOX_CLIENT.run_command(...)</code>.</li>
<li><b>Check/Create Container:</b> The <code>SANDBOX_CLIENT</code> (likely using <code>DockerSandbox</code> internally, possibly managed by <code>SandboxManager</code>) checks if a suitable sandbox container is already running. If not, it creates one based on the <code>SandboxSettings</code> from the <code>config</code> object (pulling the image, setting resource limits, etc.). This uses the Docker engine installed on your host machine.</li>
<li><b>Execute Command:</b> The client sends the command (<code>python script.py</code>) to the running Docker container for execution.</li>
<li><b>Docker Runs Command:</b> The Docker engine runs the command <em>inside</em> the isolated container environment. The script executes.</li>
<li><b>Capture Output:</b> The <code>DockerSandbox</code> infrastructure captures the standard output (stdout) and standard error (stderr) produced by the command within the container.</li>
<li><b>Return Result:</b> The captured output is sent back to the <code>SANDBOX_CLIENT</code>.</li>
<li><b>Client Returns:</b> The <code>SANDBOX_CLIENT</code> returns the output string to the calling tool.</li>
<li><b>(Later) Cleanup:</b> The <code>SandboxManager</code> or context eventually decides to stop and remove the idle container to free up resources.</li>
</ol>
<p><b>Sequence Diagram:</b></p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant Tool as Tool (e.g., PythonExecute)</div>
<div class="line">    participant Client as SANDBOX_CLIENT</div>
<div class="line">    participant Sandbox as DockerSandbox</div>
<div class="line">    participant Docker as Docker Engine (Host)</div>
<div class="line">    participant Container as Docker Container</div>
<div class="line"> </div>
<div class="line">    Tool-&gt;&gt;+Client: run_command(&quot;python script.py&quot;)</div>
<div class="line">    Client-&gt;&gt;+Sandbox: run_command(&quot;python script.py&quot;)</div>
<div class="line">    Note over Sandbox: Checks if container exists. Assume No.</div>
<div class="line">    Sandbox-&gt;&gt;+Docker: Create Container Request (using config: image, limits)</div>
<div class="line">    Docker-&gt;&gt;+Container: Creates &amp; Starts Container</div>
<div class="line">    Container--&gt;&gt;-Docker: Container Ready</div>
<div class="line">    Docker--&gt;&gt;-Sandbox: Container Created (ID: abc)</div>
<div class="line">    Sandbox-&gt;&gt;+Docker: Execute Command Request (in Container abc: &quot;python script.py&quot;)</div>
<div class="line">    Docker-&gt;&gt;+Container: Runs &quot;python script.py&quot;</div>
<div class="line">    Note over Container: script prints &quot;4&quot;</div>
<div class="line">    Container--&gt;&gt;-Docker: Command Output (&quot;4\n&quot;)</div>
<div class="line">    Docker--&gt;&gt;-Sandbox: Command Result (&quot;4\n&quot;)</div>
<div class="line">    Sandbox--&gt;&gt;-Client: Returns &quot;4\n&quot;</div>
<div class="line">    Client--&gt;&gt;-Tool: Returns &quot;4\n&quot;</div>
<div class="line"> </div>
<div class="line">    Note over Tool, Container: ... Later (idle timeout or explicit cleanup) ...</div>
<div class="line">    Client-&gt;&gt;+Sandbox: cleanup() (or Manager does it)</div>
<div class="line">    Sandbox-&gt;&gt;+Docker: Stop Container Request (ID: abc)</div>
<div class="line">    Docker-&gt;&gt;Container: Stops Container</div>
<div class="line">    Container--&gt;&gt;Docker: Stopped</div>
<div class="line">    Sandbox-&gt;&gt;+Docker: Remove Container Request (ID: abc)</div>
<div class="line">    Docker-&gt;&gt;Docker: Removes Container abc</div>
<div class="line">    Docker--&gt;&gt;-Sandbox: Container Removed</div>
<div class="line">    Sandbox--&gt;&gt;-Client: Cleanup Done</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2693"></a>
Code Glimpse: Sandbox Components</h2>
<p>Let's look at simplified snippets of the key parts.</p>
<p><b>1. <code>SandboxSettings</code> in <code>app/config.py</code>:</b> This Pydantic model defines the structure for the <code>[sandbox]</code> section in <code>config.toml</code>.</p>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippet from app/config.py</span></div>
<div class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>SandboxSettings(BaseModel):</div>
<div class="line">    <span class="stringliteral">&quot;&quot;&quot;Configuration for the execution sandbox&quot;&quot;&quot;</span></div>
<div class="line">    use_sandbox: bool = Field(<span class="keyword">False</span>, description=<span class="stringliteral">&quot;Whether to use the sandbox&quot;</span>)</div>
<div class="line">    image: str = Field(<span class="stringliteral">&quot;python:3.12-slim&quot;</span>, description=<span class="stringliteral">&quot;Base image&quot;</span>)</div>
<div class="line">    work_dir: str = Field(<span class="stringliteral">&quot;/workspace&quot;</span>, description=<span class="stringliteral">&quot;Container working directory&quot;</span>)</div>
<div class="line">    memory_limit: str = Field(<span class="stringliteral">&quot;512m&quot;</span>, description=<span class="stringliteral">&quot;Memory limit&quot;</span>)</div>
<div class="line">    cpu_limit: float = Field(1.0, description=<span class="stringliteral">&quot;CPU limit&quot;</span>)</div>
<div class="line">    timeout: int = Field(300, description=<span class="stringliteral">&quot;Default command timeout (seconds)&quot;</span>)</div>
<div class="line">    network_enabled: bool = Field(<span class="keyword">False</span>, description=<span class="stringliteral">&quot;Whether network access is allowed&quot;</span>)</div>
</div><!-- fragment --><p><b>Explanation:</b> This defines the expected settings and their types, which <code>Config</code> uses to validate <code>config.toml</code>.</p>
<p><b>2. <code>LocalSandboxClient</code> in <code>app/sandbox/client.py</code>:</b> This class provides a convenient interface to the underlying <code>DockerSandbox</code>.</p>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippet from app/sandbox/client.py</span></div>
<div class="line"><span class="keyword">from</span> app.config <span class="keyword">import</span> SandboxSettings</div>
<div class="line"><span class="keyword">from</span> app.sandbox.core.sandbox <span class="keyword">import</span> DockerSandbox</div>
<div class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Optional</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>LocalSandboxClient: <span class="comment"># Implements BaseSandboxClient</span></div>
<div class="line">    <span class="keyword">def </span>__init__(self):</div>
<div class="line">        self.sandbox: Optional[DockerSandbox] = <span class="keywordtype">None</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>create(self, config: Optional[SandboxSettings] = <span class="keywordtype">None</span>, ...):</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Creates a sandbox if one doesn&#39;t exist.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.sandbox:</div>
<div class="line">            <span class="comment"># Create the actual DockerSandbox instance</span></div>
<div class="line">            self.sandbox = DockerSandbox(config, ...)</div>
<div class="line">            await self.sandbox.create() <span class="comment"># Start the container</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>run_command(self, command: str, timeout: Optional[int] = <span class="keywordtype">None</span>) -&gt; str:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Runs command in the sandbox.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.sandbox:</div>
<div class="line">            <span class="comment"># Simplified: In reality, might auto-create or raise error</span></div>
<div class="line">            await self.create() <span class="comment"># Ensure sandbox exists</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment"># Delegate the command execution to the DockerSandbox instance</span></div>
<div class="line">        <span class="keywordflow">return</span> await self.sandbox.run_command(command, timeout)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>write_file(self, path: str, content: str) -&gt; <span class="keywordtype">None</span>:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Writes file to the sandbox.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.sandbox: await self.create()</div>
<div class="line">        <span class="comment"># Delegate writing to the DockerSandbox instance</span></div>
<div class="line">        await self.sandbox.write_file(path, content)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>cleanup(self) -&gt; None:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Cleans up the sandbox resources.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> self.sandbox:</div>
<div class="line">            await self.sandbox.cleanup() <span class="comment"># Tell DockerSandbox to stop/remove container</span></div>
<div class="line">            self.sandbox = <span class="keywordtype">None</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Create the shared instance used by tools</span></div>
<div class="line">SANDBOX_CLIENT = LocalSandboxClient()</div>
</div><!-- fragment --><p><b>Explanation:</b> The client acts as a middleman. It holds a <code>DockerSandbox</code> instance and forwards calls like <code>run_command</code> or <code>write_file</code> to it, potentially handling creation/cleanup implicitly.</p>
<p><b>3. <code>DockerSandbox</code> in <code>app/sandbox/core/sandbox.py</code>:</b> This class interacts directly with the Docker engine.</p>
<div class="fragment"><div class="line"><span class="comment"># Simplified snippet from app/sandbox/core/sandbox.py</span></div>
<div class="line"><span class="keyword">import</span> docker</div>
<div class="line"><span class="keyword">import</span> asyncio</div>
<div class="line"><span class="keyword">from</span> app.config <span class="keyword">import</span> SandboxSettings</div>
<div class="line"><span class="keyword">from</span> app.sandbox.core.terminal <span class="keyword">import</span> AsyncDockerizedTerminal <span class="comment"># For running commands</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DockerSandbox:</div>
<div class="line">    <span class="keyword">def </span>__init__(self, config: Optional[SandboxSettings] = <span class="keywordtype">None</span>, ...):</div>
<div class="line">        self.config = config <span class="keywordflow">or</span> SandboxSettings()</div>
<div class="line">        self.client = docker.from_env() <span class="comment"># Connect to Docker engine</span></div>
<div class="line">        self.container: Optional[docker.models.containers.Container] = <span class="keywordtype">None</span></div>
<div class="line">        self.terminal: Optional[AsyncDockerizedTerminal] = <span class="keywordtype">None</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>create(self) -&gt; &quot;DockerSandbox&quot;:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Creates and starts the Docker container.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">try</span>:</div>
<div class="line">            <span class="comment"># 1. Prepare container settings (image, limits, etc.) from self.config</span></div>
<div class="line">            container_config = {...} <span class="comment"># Simplified</span></div>
<div class="line"> </div>
<div class="line">            <span class="comment"># 2. Use Docker client to create the container</span></div>
<div class="line">            container_data = await asyncio.to_thread(</div>
<div class="line">                self.client.api.create_container, **container_config</div>
<div class="line">            )</div>
<div class="line">            self.container = self.client.containers.get(container_data[<span class="stringliteral">&quot;Id&quot;</span>])</div>
<div class="line"> </div>
<div class="line">            <span class="comment"># 3. Start the container</span></div>
<div class="line">            await asyncio.to_thread(self.container.start)</div>
<div class="line"> </div>
<div class="line">            <span class="comment"># 4. Initialize a terminal interface to run commands inside</span></div>
<div class="line">            self.terminal = AsyncDockerizedTerminal(container_data[<span class="stringliteral">&quot;Id&quot;</span>], ...)</div>
<div class="line">            await self.terminal.init()</div>
<div class="line">            <span class="keywordflow">return</span> self</div>
<div class="line">        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line">            await self.cleanup() <span class="comment"># Cleanup on failure</span></div>
<div class="line">            <span class="keywordflow">raise</span> RuntimeError(f<span class="stringliteral">&quot;Failed to create sandbox: {e}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>run_command(self, cmd: str, timeout: Optional[int] = <span class="keywordtype">None</span>) -&gt; str:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Runs a command using the container&#39;s terminal.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.terminal: <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&quot;Sandbox not initialized&quot;</span>)</div>
<div class="line">        <span class="comment"># Use the terminal helper to execute the command and get output</span></div>
<div class="line">        <span class="keywordflow">return</span> await self.terminal.run_command(</div>
<div class="line">            cmd, timeout=timeout <span class="keywordflow">or</span> self.config.timeout</div>
<div class="line">        )</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>write_file(self, path: str, content: str) -&gt; <span class="keywordtype">None</span>:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Writes content to a file inside the container.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> <span class="keywordflow">not</span> self.container: <span class="keywordflow">raise</span> RuntimeError(<span class="stringliteral">&quot;Sandbox not initialized&quot;</span>)</div>
<div class="line">        <span class="keywordflow">try</span>:</div>
<div class="line">            <span class="comment"># Simplified: Creates a temporary tar archive with the file</span></div>
<div class="line">            <span class="comment"># and uses Docker&#39;s put_archive to copy it into the container</span></div>
<div class="line">            tar_stream = await self._create_tar_stream(...) <span class="comment"># Helper method</span></div>
<div class="line">            await asyncio.to_thread(</div>
<div class="line">                self.container.put_archive, <span class="stringliteral">&quot;/&quot;</span>, tar_stream</div>
<div class="line">            )</div>
<div class="line">        <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div>
<div class="line">            <span class="keywordflow">raise</span> RuntimeError(f<span class="stringliteral">&quot;Failed to write file: {e}&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">async def </span>cleanup(self) -&gt; None:</div>
<div class="line">        <span class="stringliteral">&quot;&quot;&quot;Stops and removes the Docker container.&quot;&quot;&quot;</span></div>
<div class="line">        <span class="keywordflow">if</span> self.terminal: await self.terminal.close()</div>
<div class="line">        <span class="keywordflow">if</span> self.container:</div>
<div class="line">            <span class="keywordflow">try</span>:</div>
<div class="line">                await asyncio.to_thread(self.container.stop, timeout=5)</div>
<div class="line">            <span class="keywordflow">except</span> Exception: <span class="keywordflow">pass</span> <span class="comment"># Ignore errors on stop</span></div>
<div class="line">            <span class="keywordflow">try</span>:</div>
<div class="line">                await asyncio.to_thread(self.container.remove, force=<span class="keyword">True</span>)</div>
<div class="line">            <span class="keywordflow">except</span> Exception: <span class="keywordflow">pass</span> <span class="comment"># Ignore errors on remove</span></div>
<div class="line">            self.container = <span class="keywordtype">None</span></div>
</div><!-- fragment --><p><b>Explanation:</b> This class contains the low-level logic to interact with Docker's API (via the <code>docker</code> Python library) to create, start, stop, and remove containers, as well as execute commands and transfer files using Docker's mechanisms.</p>
<h2><a class="anchor" id="autotoc_md2694"></a>
Wrapping Up Chapter 8</h2>
<p>You've learned about the <code>DockerSandbox</code>, a critical security feature in OpenManus. It provides an isolated Docker container environment where agents can safely execute potentially untrusted code or commands generated by the <a class="el" href="../../db/dc5/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_201__llm.html">LLM</a>, using tools like <code>Bash</code> or <code>PythonExecute</code>. By isolating execution, the sandbox protects your host system from accidental or malicious harm. Its behavior is configured in <code>config.toml</code>, and it's typically used via the <code>SANDBOX_CLIENT</code> interface.</p>
<p>Now that we understand the core components – LLMs, Memory, Agents, Tools, Flows, Schemas, Config, and the Sandbox – how does information, especially structured data and context, flow between the user, the agent, and external models or tools in a standardized way?</p>
<p>Let's move on to the final core concept in <a class="el" href="../../dc/ddf/md__2github_2workspace_2ecosystem_2pocketflow_2docs_2OpenManus_209__mcp____model__context__protocol__.html">Chapter 9: MCP (Model Context Protocol)</a> to explore how OpenManus defines a protocol for rich context exchange.</p>
<hr  />
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
